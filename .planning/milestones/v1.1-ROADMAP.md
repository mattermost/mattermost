# Milestone v1.1: LangChain Agent Demo

**Status:** ✅ SHIPPED 2026-01-20
**Phases:** 14-18
**Total Plans:** 5

## Overview

Demonstrate Python ecosystem advantages by building an AI agent plugin with LangChain, showcasing real LLM integration, multi-turn conversations via threading, Model Context Protocol (MCP) client integration, and agentic loops with extended reasoning capabilities. Built entirely on top of v1.0 Python SDK foundation to showcase language ecosystem advantages.

## Phases

### Phase 14: Bot Infrastructure

**Goal**: Create two bots (OpenAI, Anthropic) on plugin activation, handle DM message routing
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 14-01: Bot Infrastructure (plugin structure, bot creation, DM routing)

**Details:**
Plugin activation creates two bot users: `ai-openai` and `ai-anthropic`. DMs from users are routed to the appropriate bot channel. Uses `ensure_bot_user()` for idempotent bot creation and bot membership lookup for reliable channel identification.

Key decision: Bot membership lookup more reliable than parsing channel name for DM routing.

### Phase 15: LangChain Core

**Goal**: Basic LangChain setup with OpenAI/Anthropic providers, simple chat responses
**Depends on**: Phase 14
**Plans**: 1 plan

Plans:
- [x] 15-01: LangChain integration with real LLM responses

**Details:**
Models initialized in `on_activate` hook with error handling for graceful degradation when API keys missing. Uses provider-agnostic `SystemMessage` and `HumanMessage` types. Each model responds to DM messages with simple chat completion.

Key decisions:
- LangChain message types for provider-agnostic prompting
- Model initialization in hook with error handling

### Phase 16: Session Memory

**Goal**: Multi-turn conversations via Mattermost threading as conversation history
**Depends on**: Phase 15
**Plans**: 1 plan

Plans:
- [x] 16-01: Threading and conversation history from threads

**Details:**
Leverages Mattermost threading as conversation history. When a reply is sent to a root message, `get_post_thread()` fetches the thread and maps previous messages to `HumanMessage`/`AIMessage` format. Root ID determination: use `post.root_id` if in thread, else `post.id` as new root.

Key decision: Thread-based conversation history uses existing SDK APIs for retrieval and mapping.

### Phase 17: MCP Client

**Goal**: Model Context Protocol integration for external tools (HTTP/SSE and STDIO servers)
**Depends on**: Phase 16
**Plans**: 1 plan

Plans:
- [x] 17-01: MCP client initialization and async agent handlers

**Details:**
MCP client initialized in hook. Sync hooks call `asyncio.run(async_method())` for MCP operations. Empty MCP config by default; servers configured via plugin settings in future. Falls back to basic `model.invoke()` when tools unavailable.

Key decisions:
- Empty MCP config by default (servers configured later)
- asyncio.run() bridges sync hook → async MCP client
- Graceful fallback without MCP available

### Phase 18: Agentic Loop

**Goal**: Tool calling orchestration, reasoning, multi-step execution with LangChain agents
**Depends on**: Phase 17
**Plans**: 1 plan

Plans:
- [x] 18-01: Recursion limit, extended thinking, tenacity retry

**Details:**
LangGraph agent with ReAct loop. Recursion limit set to 10 iterations via config dict (LangGraph standard for infinite loop prevention). Extended thinking enabled for Anthropic with `budget_tokens=2000` and `max_tokens=5000`. Tenacity retry for transient errors only (ConnectionError, TimeoutError).

Key decisions:
- `recursion_limit=10` prevents infinite ReAct loops
- `budget_tokens=2000` for extended thinking caps usage
- Tenacity retry for transient errors; others fail fast

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**

| Decision | Phase | Rationale | Outcome |
|----------|-------|-----------|---------|
| Bot membership lookup for DM routing | 14-01 | More reliable than parsing channel name | ✓ Good |
| ensure_bot_user for bot creation | 14-01 | Idempotent - returns existing bot if present | ✓ Good |
| LangChain message types for prompts | 15-01 | Provider-agnostic SystemMessage/HumanMessage format | ✓ Good |
| Model init in on_activate with error handling | 15-01 | Graceful degradation when API keys missing | ✓ Good |
| Thread-based conversation history | 16-01 | Use get_post_thread to fetch context, map to HumanMessage/AIMessage | ✓ Good |
| root_id determination for threading | 16-01 | Use post.root_id if in thread, else post.id as new root | ✓ Good |
| Empty MCP config by default | 17-01 | Servers configured via plugin settings in future | ✓ Good |
| asyncio.run() for async handlers | 17-01 | Sync hooks call asyncio.run(async_method()) for MCP operations | ✓ Good |
| Graceful fallback without MCP | 17-01 | Falls back to basic model.invoke() when tools unavailable | ✓ Good |
| recursion_limit=10 via config dict | 18-01 | LangGraph standard; prevents infinite ReAct loops | ✓ Good |
| budget_tokens=2000 for extended thinking | 18-01 | Caps thinking tokens while allowing complex reasoning | ✓ Good |
| Tenacity retry for transient errors only | 18-01 | ConnectionError/TimeoutError benefit from retry; others fail fast | ✓ Good |

**Issues Resolved:**

- Demonstrated Python ecosystem advantages through practical LangChain integration
- Showed how to build stateful agents leveraging Mattermost threading
- Proved MCP integration possible in plugin context for tool access
- Validated agentic patterns with extended reasoning and retry logic

**Issues Deferred:**

- Performance optimization (agentic loops can be slow; document expectations)
- Production deployment considerations (rate limiting, cost management)
- v1.2 features (user preferences for model selection, conversation archival)

**Technical Debt Incurred:**

None noted during v1.1

---

_For current project status, see .planning/ROADMAP.md_

---

*Milestone archived: 2026-01-20*
