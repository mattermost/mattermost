---
phase: 04-scheduled-tab
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - webapp/channels/src/packages/mattermost-redux/src/action_types/recaps.ts
  - webapp/channels/src/packages/mattermost-redux/src/actions/recaps.ts
  - webapp/channels/src/packages/mattermost-redux/src/reducers/entities/recaps.ts
  - webapp/channels/src/packages/mattermost-redux/src/selectors/entities/recaps.ts
  - webapp/platform/types/src/store.ts
autonomous: true

must_haves:
  truths:
    - "Redux actions exist for all scheduled recap operations"
    - "Scheduled recaps are stored in Redux state"
    - "Selectors return scheduled recaps from state"
  artifacts:
    - path: "webapp/channels/src/packages/mattermost-redux/src/action_types/recaps.ts"
      provides: "Scheduled recap action type constants"
      contains: "GET_SCHEDULED_RECAPS"
    - path: "webapp/channels/src/packages/mattermost-redux/src/actions/recaps.ts"
      provides: "Scheduled recap async actions"
      contains: "getScheduledRecaps"
    - path: "webapp/channels/src/packages/mattermost-redux/src/reducers/entities/recaps.ts"
      provides: "Scheduled recaps reducer"
      contains: "scheduledRecaps"
    - path: "webapp/channels/src/packages/mattermost-redux/src/selectors/entities/recaps.ts"
      provides: "Scheduled recap selectors"
      contains: "getScheduledRecaps"
  key_links:
    - from: "webapp/channels/src/packages/mattermost-redux/src/actions/recaps.ts"
      to: "webapp/platform/client/src/client4.ts"
      via: "Client4 API calls"
      pattern: "Client4\\.getScheduledRecaps"
    - from: "webapp/channels/src/packages/mattermost-redux/src/reducers/entities/recaps.ts"
      to: "webapp/channels/src/packages/mattermost-redux/src/action_types/recaps.ts"
      via: "action type imports"
      pattern: "RECEIVED_SCHEDULED_RECAPS"
---

<objective>
Add Redux action types, actions, reducer, and selectors for scheduled recaps

Purpose: Enable React components to fetch, store, and access scheduled recap data through Redux
Output: Complete Redux layer for scheduled recap state management
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-scheduled-tab/04-CONTEXT.md
@.planning/codebase/CONVENTIONS.md

# Reference existing recap Redux patterns
@webapp/channels/src/packages/mattermost-redux/src/action_types/recaps.ts
@webapp/channels/src/packages/mattermost-redux/src/actions/recaps.ts
@webapp/channels/src/packages/mattermost-redux/src/reducers/entities/recaps.ts
@webapp/channels/src/packages/mattermost-redux/src/selectors/entities/recaps.ts

# Types from Plan 01
@webapp/platform/types/src/recaps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scheduled recap action types</name>
  <files>webapp/channels/src/packages/mattermost-redux/src/action_types/recaps.ts</files>
  <action>
Add scheduled recap action types to the existing keyMirror object:

```typescript
// Add these to the existing keyMirror call:
GET_SCHEDULED_RECAPS_REQUEST: null,
GET_SCHEDULED_RECAPS_SUCCESS: null,
GET_SCHEDULED_RECAPS_FAILURE: null,

RECEIVED_SCHEDULED_RECAP: null,
RECEIVED_SCHEDULED_RECAPS: null,

PAUSE_SCHEDULED_RECAP_REQUEST: null,
PAUSE_SCHEDULED_RECAP_SUCCESS: null,
PAUSE_SCHEDULED_RECAP_FAILURE: null,

RESUME_SCHEDULED_RECAP_REQUEST: null,
RESUME_SCHEDULED_RECAP_SUCCESS: null,
RESUME_SCHEDULED_RECAP_FAILURE: null,

DELETE_SCHEDULED_RECAP_REQUEST: null,
DELETE_SCHEDULED_RECAP_SUCCESS: null,
DELETE_SCHEDULED_RECAP_FAILURE: null,
```

Note: Create/Update actions will be added in Phase 5 (Enhanced Wizard). This plan only covers read/pause/resume/delete needed for the Scheduled tab.
  </action>
  <verify>TypeScript compiles: `cd webapp && npm run check-types 2>&1 | head -20`</verify>
  <done>All scheduled recap action type constants exist in keyMirror</done>
</task>

<task type="auto">
  <name>Task 2: Add scheduled recap Redux actions</name>
  <files>webapp/channels/src/packages/mattermost-redux/src/actions/recaps.ts</files>
  <action>
Add async actions for scheduled recaps. Follow the existing pattern (e.g., getRecaps, deleteRecap):

1. Add import for ScheduledRecap type at top:
```typescript
import type {Recap, CreateRecapRequest, ScheduledRecap} from '@mattermost/types/recaps';
```

2. Add these actions after existing recap actions:

```typescript
// Scheduled Recap Actions

export function getScheduledRecaps(page = 0, perPage = 60): ActionFuncAsync<ScheduledRecap[]> {
    return async (dispatch, getState) => {
        dispatch({type: RecapTypes.GET_SCHEDULED_RECAPS_REQUEST});

        let data: ScheduledRecap[];
        try {
            data = await Client4.getScheduledRecaps(page, perPage);
        } catch (error) {
            forceLogoutIfNecessary(error, dispatch, getState);
            dispatch({type: RecapTypes.GET_SCHEDULED_RECAPS_FAILURE, error});
            dispatch(logError(error));
            return {error};
        }

        dispatch({type: RecapTypes.RECEIVED_SCHEDULED_RECAPS, data});
        dispatch({type: RecapTypes.GET_SCHEDULED_RECAPS_SUCCESS});

        return {data};
    };
}

export function pauseScheduledRecap(id: string): ActionFuncAsync<ScheduledRecap> {
    return async (dispatch, getState) => {
        dispatch({type: RecapTypes.PAUSE_SCHEDULED_RECAP_REQUEST});

        let data: ScheduledRecap;
        try {
            data = await Client4.pauseScheduledRecap(id);
        } catch (error) {
            forceLogoutIfNecessary(error, dispatch, getState);
            dispatch({type: RecapTypes.PAUSE_SCHEDULED_RECAP_FAILURE, error});
            dispatch(logError(error));
            return {error};
        }

        dispatch({type: RecapTypes.RECEIVED_SCHEDULED_RECAP, data});
        dispatch({type: RecapTypes.PAUSE_SCHEDULED_RECAP_SUCCESS});

        return {data};
    };
}

export function resumeScheduledRecap(id: string): ActionFuncAsync<ScheduledRecap> {
    return async (dispatch, getState) => {
        dispatch({type: RecapTypes.RESUME_SCHEDULED_RECAP_REQUEST});

        let data: ScheduledRecap;
        try {
            data = await Client4.resumeScheduledRecap(id);
        } catch (error) {
            forceLogoutIfNecessary(error, dispatch, getState);
            dispatch({type: RecapTypes.RESUME_SCHEDULED_RECAP_FAILURE, error});
            dispatch(logError(error));
            return {error};
        }

        dispatch({type: RecapTypes.RECEIVED_SCHEDULED_RECAP, data});
        dispatch({type: RecapTypes.RESUME_SCHEDULED_RECAP_SUCCESS});

        return {data};
    };
}

export function deleteScheduledRecap(id: string): ActionFuncAsync {
    return async (dispatch, getState) => {
        dispatch({type: RecapTypes.DELETE_SCHEDULED_RECAP_REQUEST});

        try {
            await Client4.deleteScheduledRecap(id);
        } catch (error) {
            forceLogoutIfNecessary(error, dispatch, getState);
            dispatch({type: RecapTypes.DELETE_SCHEDULED_RECAP_FAILURE, error});
            dispatch(logError(error));
            return {error};
        }

        dispatch({type: RecapTypes.DELETE_SCHEDULED_RECAP_SUCCESS, data: {id}});

        return {data: true};
    };
}
```
  </action>
  <verify>TypeScript compiles: `cd webapp && npm run check-types 2>&1 | head -20`</verify>
  <done>All 4 scheduled recap actions exist: getScheduledRecaps, pauseScheduledRecap, resumeScheduledRecap, deleteScheduledRecap</done>
</task>

<task type="auto">
  <name>Task 3: Add scheduled recaps to reducer</name>
  <files>webapp/channels/src/packages/mattermost-redux/src/reducers/entities/recaps.ts</files>
  <action>
Add scheduled recaps state handling to the existing reducer. Check the existing file structure first.

1. Add import for ScheduledRecap type if not present

2. Add a new reducer function for scheduledRecaps (or add cases to existing reducer):

```typescript
function scheduledRecaps(state: Record<string, ScheduledRecap> = {}, action: AnyAction): Record<string, ScheduledRecap> {
    switch (action.type) {
    case RecapTypes.RECEIVED_SCHEDULED_RECAP: {
        const recap = action.data as ScheduledRecap;
        return {
            ...state,
            [recap.id]: recap,
        };
    }
    case RecapTypes.RECEIVED_SCHEDULED_RECAPS: {
        const recaps = action.data as ScheduledRecap[];
        const newState = {...state};
        for (const recap of recaps) {
            newState[recap.id] = recap;
        }
        return newState;
    }
    case RecapTypes.DELETE_SCHEDULED_RECAP_SUCCESS: {
        const {id} = action.data;
        const newState = {...state};
        delete newState[id];
        return newState;
    }
    default:
        return state;
    }
}
```

3. Export the combined reducer including scheduledRecaps. Check how the existing file exports and follow that pattern (likely combineReducers or a combined export).
  </action>
  <verify>TypeScript compiles: `cd webapp && npm run check-types 2>&1 | head -20`</verify>
  <done>scheduledRecaps reducer handles RECEIVED_SCHEDULED_RECAP, RECEIVED_SCHEDULED_RECAPS, DELETE_SCHEDULED_RECAP_SUCCESS</done>
</task>

<task type="auto">
  <name>Task 4: Add scheduled recap selectors</name>
  <files>webapp/channels/src/packages/mattermost-redux/src/selectors/entities/recaps.ts</files>
  <action>
Add selectors for scheduled recaps. Follow existing selector patterns (using createSelector from 'mattermost-redux/selectors/create_selector'):

1. Add import for ScheduledRecap type

2. Add base selector to get scheduled recaps from state:
```typescript
export function getScheduledRecapsState(state: GlobalState): Record<string, ScheduledRecap> {
    return state.entities.recaps.scheduledRecaps || {};
}
```

3. Add derived selectors:
```typescript
export const getAllScheduledRecaps = createSelector(
    'getAllScheduledRecaps',
    getScheduledRecapsState,
    (scheduledRecaps) => Object.values(scheduledRecaps),
);

export const getActiveScheduledRecaps = createSelector(
    'getActiveScheduledRecaps',
    getAllScheduledRecaps,
    (scheduledRecaps) => scheduledRecaps.filter((sr) => sr.enabled && sr.delete_at === 0),
);

export const getPausedScheduledRecaps = createSelector(
    'getPausedScheduledRecaps',
    getAllScheduledRecaps,
    (scheduledRecaps) => scheduledRecaps.filter((sr) => !sr.enabled && sr.delete_at === 0),
);

export function getScheduledRecapById(state: GlobalState, id: string): ScheduledRecap | undefined {
    return getScheduledRecapsState(state)[id];
}
```

Note: Check how GlobalState is imported in this file (likely from '@mattermost/types/store' or similar).
  </action>
  <verify>TypeScript compiles: `cd webapp && npm run check-types 2>&1 | head -20`</verify>
  <done>Selectors exist: getScheduledRecapsState, getAllScheduledRecaps, getActiveScheduledRecaps, getPausedScheduledRecaps, getScheduledRecapById</done>
</task>

<task type="auto">
  <name>Task 5: Update GlobalState type for scheduled recaps</name>
  <files>webapp/platform/types/src/store.ts</files>
  <action>
Add scheduledRecaps to the recaps entity state in GlobalState.

1. First check the existing structure of the recaps state in store.ts
2. Add scheduledRecaps field to the recaps state type:

Look for where recaps state is defined (likely something like):
```typescript
recaps: {
    // existing fields...
    scheduledRecaps: Record<string, ScheduledRecap>;
};
```

If recaps isn't explicitly typed, you may need to add/update the type definition.

Also ensure ScheduledRecap is imported from './recaps'.
  </action>
  <verify>TypeScript compiles: `cd webapp && npm run check-types 2>&1 | head -20`</verify>
  <done>GlobalState.entities.recaps.scheduledRecaps is typed as Record&lt;string, ScheduledRecap&gt;</done>
</task>

</tasks>

<verification>
- [ ] Action types added to keyMirror: GET_SCHEDULED_RECAPS_*, RECEIVED_SCHEDULED_RECAP(S), PAUSE_*, RESUME_*, DELETE_*
- [ ] Actions implemented: getScheduledRecaps, pauseScheduledRecap, resumeScheduledRecap, deleteScheduledRecap
- [ ] Reducer handles all scheduled recap actions
- [ ] Selectors work: getAllScheduledRecaps, getActiveScheduledRecaps, getPausedScheduledRecaps, getScheduledRecapById
- [ ] GlobalState type includes scheduledRecaps
- [ ] TypeScript compiles successfully
</verification>

<success_criteria>
Components can dispatch getScheduledRecaps() and use useSelector(getAllScheduledRecaps) to access data. Type checking passes.
</success_criteria>

<output>
After completion, create `.planning/phases/04-scheduled-tab/04-02-SUMMARY.md`
</output>
