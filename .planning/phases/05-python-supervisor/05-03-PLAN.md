---
phase: 05-python-supervisor
plan: 03
type: execute
depends_on: ["05-02"]
files_modified:
  - server/public/plugin/python_supervisor_test.go
---

<objective>
Harden the Python supervisor with failure-mode coverage (startup timeout, invalid handshake, crash/restart) and prove restart behavior works end-to-end.

Purpose: Ensure Python plugin supervision is resilient and debuggable before we build the Python SDK + hook system.
Output: Additional integration tests that cover the critical failure modes and the restart loop using existing Environment APIs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-python-supervisor/05-RESEARCH.md

@server/public/plugin/supervisor.go
@server/public/plugin/environment.go
@server/public/plugin/health_check.go
@server/public/plugin/health_check_test.go

@/Users/nickmisasi/go/pkg/mod/github.com/hashicorp/go-plugin@v1.7.0/docs/guide-plugin-write-non-go.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Python plugin startup failure-mode tests (timeout + invalid handshake)</name>
  <files>server/public/plugin/python_supervisor_test.go</files>
  <action>
Extend the integration-test harness from Plan 05-02 with additional fake “python interpreter” binaries to validate supervisor error handling:

- **Handshake timeout**:
  - Fake interpreter that never prints the handshake line (e.g., blocks forever).
  - Ensure activation/start returns within `StartTimeout` and surfaces a clear error (reuse the existing `StartTimeout` behavior in supervisor).

- **Invalid handshake protocol**:
  - Fake interpreter that prints a handshake line with protocol `netrpc` (or malformed parts count) while the supervisor expects `ProtocolGRPC`.
  - Assert startup fails with a useful error and does not hang.

Design constraints:
- Keep tests hermetic (no real Python, no grpcio).
- Use `utils.CompileGo` to produce these fake interpreters.
- Reuse the same temp bundle structure (plugin.json + dummy plugin.py + venv interpreter path).
  </action>
  <verify>cd server/public && go test ./plugin -run TestPythonSupervisor_ -count=1</verify>
  <done>
We have deterministic tests for handshake timeout and invalid handshake that complete quickly and validate helpful error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restart test: crash the Python plugin process and verify Environment.RestartPlugin recovers</name>
  <files>server/public/plugin/python_supervisor_test.go</files>
  <action>
Add an end-to-end restart test using existing Environment APIs:

- Start a healthy fake Python plugin (the same one that serves gRPC health + prints a valid handshake).
- Verify `env.PerformHealthCheck(id)` succeeds.
- Simulate a crash:
  - Locate the registered plugin’s supervisor from `env.registeredPlugins` (tests are in package `plugin`, so you can access internal types).
  - Kill the underlying process via `rp.supervisor.client.Kill()` (or the appropriate internal handle).
- Verify `env.PerformHealthCheck(id)` returns an error after the crash.
- Call `env.RestartPlugin(id)` and verify:
  - It returns nil.
  - `env.PerformHealthCheck(id)` succeeds again.

Avoid:
- Relying on timing-based sleeps where possible. Prefer “wait until health check fails/succeeds” loops with a short timeout.
  </action>
  <verify>cd server/public && go test ./plugin -run TestPythonSupervisor_Restart -count=1</verify>
  <done>
Restart flow is proven: crash → health check fails → RestartPlugin → health check passes again.
  </done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `cd server/public && go test ./plugin -count=1` passes
- [ ] Failure-mode tests complete quickly (<10s each) and do not flake
</verification>

<success_criteria>
- Python plugin supervision has coverage for the top failure modes called out in research: startup hang/timeout and invalid handshake
- Restart behavior is proven end-to-end via Environment APIs
- No dependency on a real Python runtime or third-party Python libraries in Go tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-python-supervisor/05-03-SUMMARY.md` using:
@/Users/nickmisasi/.claude/get-shit-done/templates/summary.md
</output>


