---
phase: 05-python-supervisor
plan: 01
type: execute
depends_on: []
files_modified:
  - server/public/plugin/python_supervisor.go
  - server/public/plugin/python_supervisor_test.go
  - server/public/plugin/supervisor.go
---

<objective>
Add Python plugin runtime detection + safe subprocess command construction (python interpreter + script) without changing existing Go plugin behavior.

Purpose: Establish the process-spawning primitives Phase 5+ will use for Python plugins.
Output: Helper functions to detect Python plugins, locate a Python interpreter (venv or system), and a new supervisor option that sets `ClientConfig.Cmd` correctly.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-python-supervisor/05-RESEARCH.md

@server/public/plugin/supervisor.go
@server/public/plugin/environment.go
@server/public/model/manifest.go

@/Users/nickmisasi/go/pkg/mod/github.com/hashicorp/go-plugin@v1.7.0/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Python plugin detection + interpreter discovery helpers</name>
  <files>server/public/plugin/python_supervisor.go</files>
  <action>
Create a new helper file in the `plugin` package for Python-supervisor-specific logic:

- Implement `isPythonPlugin(manifest *model.Manifest) bool` using ONLY existing manifest fields:
  - Prefer `manifest.Server` executable extension: treat `*.py` as Python.
  - Also support a transitional marker via `manifest.Props` (e.g. `props.runtime == "python"`) to avoid needing Phase 9 schema changes to test early.

- Implement `findPythonInterpreter(pluginDir string) (string, error)`:
  - Check venv paths first (cross-platform):
    - Unix: `{pluginDir}/venv/bin/python`, `{pluginDir}/venv/bin/python3`, `{pluginDir}/.venv/bin/python`, `{pluginDir}/.venv/bin/python3`
    - Windows: `{pluginDir}/venv/Scripts/python.exe`, `{pluginDir}/.venv/Scripts/python.exe`
  - Fall back to `exec.LookPath("python3")`, then `exec.LookPath("python")`.
  - Do NOT hardcode `/usr/bin/python3` (breaks pyenv, brew, containers).

- Implement a safe join for the script path:
  - Use the same sanitation pattern as `WithExecutableFromManifest`:
    - `filepath.Clean(filepath.Join(".", executable))`
    - Reject if it escapes (`strings.HasPrefix(cleaned, "..")`).
  - Return the absolute script path under `pluginInfo.Path`.

- When constructing `exec.Cmd` for Python, set:
  - `cmd := exec.Command(pythonPath, scriptPath)`
  - `cmd.Dir = pluginInfo.Path` (so relative imports/data files behave like Go plugins’ working dir).
  - `cmd.WaitDelay = 5 * time.Second` (graceful shutdown window; avoid immediate SIGKILL on cancel).

Avoid pitfalls from Phase 5 research:
- Don’t read stdout/stderr synchronously in the same goroutine you might later wait on (deadlock risk); leave log capture to go-plugin’s SyncStdout/SyncStderr in Phase 5-02.
- Don’t accept path traversal in manifest executables (security boundary).
  </action>
  <verify>cd server/public && go test ./plugin -run TestPython -count=1</verify>
  <done>
Helper functions compile and are covered by tests. `isPythonPlugin` correctly detects `.py` and `props.runtime == "python"`. `findPythonInterpreter` returns venv python when present and falls back to LookPath.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add a supervisor ClientConfig option that builds Cmd correctly for Python plugins</name>
  <files>server/public/plugin/supervisor.go, server/public/plugin/python_supervisor.go</files>
  <action>
Add a new exported option (keep existing behavior intact for Go plugins):

- Introduce `WithCommandFromManifest(pluginInfo *model.BundleInfo) func(*supervisor, *plugin.ClientConfig) error`.
  - If `isPythonPlugin(pluginInfo.Manifest)`:
    - Build `cmd` using `findPythonInterpreter(pluginInfo.Path)` + sanitized script path.
    - IMPORTANT: If you set `clientConfig.SecureConfig`, ensure the checksum is computed against `cmd.Path` (the interpreter), not the script, because go-plugin validates `SecureConfig.Check(cmd.Path)` on startup.
    - Prefer either:
      - `SecureConfig=nil` for Python (simplest; avoids checksum mismatch), OR
      - compute checksum of the interpreter at `cmd.Path` to keep parity with existing warning-suppression behavior.
  - Else (Go plugin):
    - Reuse existing logic from `WithExecutableFromManifest` (including checksum and SecureConfig) without changing semantics.

Do NOT change the existing public option `WithExecutableFromManifest` signature or behavior; instead, have Phase 5 activation call this new option.
  </action>
  <verify>cd server/public && go test ./plugin -run TestSupervisor -count=1</verify>
  <done>
`WithCommandFromManifest` sets `clientConfig.Cmd` correctly for both Go and Python plugin manifests. Go plugin startup tests remain unchanged/passing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for Python command construction (no process start)</name>
  <files>server/public/plugin/python_supervisor_test.go</files>
  <action>
Add unit tests that exercise ONLY the option/helpers (no plugin process execution yet):

- Create a temp plugin bundle with a manifest that sets `server.executable` to `plugin.py`.
- Create a fake venv interpreter file at the expected venv path so `findPythonInterpreter` never calls `exec.LookPath` (keeps tests hermetic).
- Invoke `WithCommandFromManifest(bundleInfo)` against a fresh `plugin.ClientConfig` and assert:
  - `Cmd.Path` equals the venv interpreter path
  - `Cmd.Args` contains `[pythonPath, scriptPath]`
  - `scriptPath` is within `bundleInfo.Path` and path traversal is rejected.

Keep tests cross-platform (use runtime.GOOS to pick the venv path variant).
  </action>
  <verify>cd server/public && go test ./plugin -run TestPythonCommandFromManifest -count=1</verify>
  <done>
Tests pass without requiring a real Python installation, and validate path safety + correct Cmd construction.
  </done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `cd server/public && go test ./plugin -count=1` passes
- [ ] Existing Go plugin behavior unchanged (no regression in `TestSupervisor*` / `TestPluginHealthCheck*`)
</verification>

<success_criteria>
- Python plugins can be detected without Phase 9 manifest schema changes (extension and/or props marker)
- Python subprocess command is `python <script>` with safe path joining and venv-first interpreter selection
- No new security boundary regression (manifest path traversal still rejected)
</success_criteria>

<output>
After completion, create `.planning/phases/05-python-supervisor/05-01-SUMMARY.md` using:
@/Users/nickmisasi/.claude/get-shit-done/templates/summary.md
</output>


