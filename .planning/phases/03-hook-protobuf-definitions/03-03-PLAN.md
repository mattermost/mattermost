---
phase: 03-hook-protobuf-definitions
plan: 03
type: execute
depends_on: ["03-01"]
files_modified:
  - server/public/pluginapi/grpc/proto/hooks_user_channel.proto
  - server/public/pluginapi/grpc/proto/hooks.proto
  - server/public/Makefile
domain: grpc-protobuf
---

<objective>
Define protobuf/gRPC contracts for user and channel lifecycle hooks including user creation, login, deactivation, SAML, and channel/team membership changes.

Purpose: Enable Python plugins to receive user and channel lifecycle events with full type safety.
Output: hooks_user_channel.proto with request/response messages, updated hooks.proto service with user/channel RPCs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-hook-protobuf-definitions/03-01-SUMMARY.md

**Existing proto files to reference:**
@server/public/pluginapi/grpc/proto/hooks.proto
@server/public/pluginapi/grpc/proto/hooks_lifecycle.proto
@server/public/pluginapi/grpc/proto/hooks_common.proto
@server/public/pluginapi/grpc/proto/common.proto
@server/public/pluginapi/grpc/proto/user.proto
@server/public/pluginapi/grpc/proto/channel.proto
@server/public/pluginapi/grpc/proto/team.proto
@server/public/pluginapi/grpc/proto/api_channel_post.proto (has ChannelMember)

**Go hooks interface:**
@server/public/plugin/hooks.go

**Conventions from 03-01:**
- Every request: `RequestContext context = 1;`
- Hooks with `*Context`: also `PluginContext plugin_context = 2;`
- Hooks returning error: `AppError error = 1;` in response
- Void hooks: Response has no error field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks_user_channel.proto with user/channel hook definitions</name>
  <files>server/public/pluginapi/grpc/proto/hooks_user_channel.proto</files>
  <action>
Create hooks_user_channel.proto defining request/response messages for all user and channel lifecycle hooks.

**Model types to define:**
1. `SamlAssertionInfoJson` - JSON blob wrapper for saml2.AssertionInfo (external library type)
   - Complex SAML assertion data, best handled as JSON to avoid proto dependency on external library

**Existing types to import:**
- User from user.proto
- Channel from channel.proto
- TeamMember from team.proto
- ChannelMember from api_channel_post.proto

**Hooks to define (10 total):**

1. `UserHasBeenCreated(c *Context, user *model.User)`
   - Notification after user creation
   - Void return

2. `UserWillLogIn(c *Context, user *model.User) string`
   - Can reject login by returning non-empty string
   - Response: rejection_reason (empty = allow)

3. `UserHasLoggedIn(c *Context, user *model.User)`
   - Notification after successful login
   - Void return

4. `UserHasBeenDeactivated(c *Context, user *model.User)`
   - Notification after user deactivation
   - Void return

5. `OnSAMLLogin(c *Context, user *model.User, assertion *saml2.AssertionInfo) error`
   - Called after successful SAML login
   - Use JSON blob for assertion (external library type)
   - Returns error

6. `ChannelHasBeenCreated(c *Context, channel *model.Channel)`
   - Notification after channel creation
   - Void return

7. `UserHasJoinedChannel(c *Context, channelMember *model.ChannelMember, actor *model.User)`
   - Notification after user joins channel
   - actor is optional (nil if self-join)
   - Void return

8. `UserHasLeftChannel(c *Context, channelMember *model.ChannelMember, actor *model.User)`
   - Notification after user leaves channel
   - actor is optional (nil if self-removal)
   - Void return

9. `UserHasJoinedTeam(c *Context, teamMember *model.TeamMember, actor *model.User)`
   - Notification after user joins team
   - actor is optional
   - Void return

10. `UserHasLeftTeam(c *Context, teamMember *model.TeamMember, actor *model.User)`
    - Notification after user leaves team
    - actor is optional
    - Void return

**File structure:**
```protobuf
// Header comment block explaining purpose
// Imports: common.proto, hooks_common.proto, user.proto, channel.proto, team.proto, api_channel_post.proto

// Model types section
message SamlAssertionInfoJson {
  bytes assertion_json = 1;
}

// Hook messages (Request/Response pairs for each hook)
```

For optional actor parameters, use `optional User actor = X;` (proto3 optional).
  </action>
  <verify>File exists and follows proto3 syntax</verify>
  <done>hooks_user_channel.proto created with all 10 user/channel hook definitions</done>
</task>

<task type="auto">
  <name>Task 2: Add user/channel hook RPCs to PluginHooks service</name>
  <files>server/public/pluginapi/grpc/proto/hooks.proto</files>
  <action>
Update hooks.proto to:
1. Import hooks_user_channel.proto
2. Add USER HOOKS section comment
3. Add CHANNEL HOOKS section comment
4. Add 10 RPC definitions with documentation comments

**User hooks section:**
```protobuf
// ===========================================================================
// USER HOOKS
// ===========================================================================

// UserHasBeenCreated is invoked after a user was created.
// Go signature: UserHasBeenCreated(c *Context, user *model.User)
rpc UserHasBeenCreated(UserHasBeenCreatedRequest) returns (UserHasBeenCreatedResponse);

// UserWillLogIn is invoked before the login. Return non-empty string to reject.
// Go signature: UserWillLogIn(c *Context, user *model.User) string
rpc UserWillLogIn(UserWillLogInRequest) returns (UserWillLogInResponse);

// [etc. for UserHasLoggedIn, UserHasBeenDeactivated, OnSAMLLogin]
```

**Channel/Team hooks section:**
```protobuf
// ===========================================================================
// CHANNEL AND TEAM HOOKS
// ===========================================================================

// ChannelHasBeenCreated is invoked after a channel has been created.
// Go signature: ChannelHasBeenCreated(c *Context, channel *model.Channel)
rpc ChannelHasBeenCreated(ChannelHasBeenCreatedRequest) returns (ChannelHasBeenCreatedResponse);

// [etc. for membership hooks]
```
  </action>
  <verify>hooks.proto has valid syntax and imports hooks_user_channel.proto</verify>
  <done>hooks.proto updated with 10 user/channel hook RPCs</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile and generate Go code</name>
  <files>server/public/Makefile</files>
  <action>
1. Update PROTO_FILES or proto mapping in Makefile to include hooks_user_channel.proto
2. Run `make proto-gen` from server/public directory
3. Verify generated files compile: `go build ./pluginapi/grpc/generated/go/pluginapiv1/...`
  </action>
  <verify>`make proto-gen` succeeds and `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds</verify>
  <done>Proto generation works, Go code compiles without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make proto-gen` succeeds in server/public
- [ ] `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds
- [ ] hooks_user_channel.proto defines all 10 user/channel hooks
- [ ] hooks.proto imports hooks_user_channel.proto and has 10 new RPCs
- [ ] SamlAssertionInfoJson type defined for SAML assertion
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 10 user/channel hook RPCs added to PluginHooks service
- Generated Go code compiles
</success_criteria>

<output>
After completion, create `.planning/phases/03-hook-protobuf-definitions/03-03-SUMMARY.md`:

# Plan 03-03 Summary: User/Channel Hook Protobuf Definitions

**Plan:** 03-03 (User/Channel hooks)
**Phase:** 03-hook-protobuf-definitions
**Status:** Complete
**Date:** [date]

## Objective

Define protobuf/gRPC contracts for user and channel lifecycle hooks.

## Tasks Completed

### Task 1: Create hooks_user_channel.proto
- [Details]

### Task 2: Add user/channel hook RPCs
- [List of RPCs added]

### Task 3: Generate and verify
- [Build results]

## Hooks Added

| Hook | Go Signature | Notes |
|------|-------------|-------|
| UserHasBeenCreated | ... | ... |
[etc.]

## Model Types Added

- SamlAssertionInfoJson (JSON blob for SAML assertion)

## Files Modified

- `server/public/pluginapi/grpc/proto/hooks_user_channel.proto` (new)
- `server/public/pluginapi/grpc/proto/hooks.proto` (updated)
- Generated files

## Commits

[List commits]

## Verification

- [x] Proto generation succeeds
- [x] Go code compiles

## Next Step

Ready for 03-04-PLAN.md (Command/WebSocket/Cluster hooks)
</output>
