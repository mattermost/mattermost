---
phase: 03-hook-protobuf-definitions
plan: 02
type: execute
depends_on: ["03-01"]
files_modified:
  - server/public/pluginapi/grpc/proto/hooks_message.proto
  - server/public/pluginapi/grpc/proto/hooks.proto
  - server/public/Makefile
domain: grpc-protobuf
---

<objective>
Define protobuf/gRPC contracts for message-related plugin hooks including post lifecycle, reactions, file uploads, notifications, and preferences.

Purpose: Enable Python plugins to receive and intercept message events (posts, reactions, files, notifications) with full type safety.
Output: hooks_message.proto with request/response messages, updated hooks.proto service with message RPCs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-hook-protobuf-definitions/03-01-SUMMARY.md

**Existing proto files to reference:**
@server/public/pluginapi/grpc/proto/hooks.proto
@server/public/pluginapi/grpc/proto/hooks_lifecycle.proto
@server/public/pluginapi/grpc/proto/hooks_common.proto
@server/public/pluginapi/grpc/proto/common.proto
@server/public/pluginapi/grpc/proto/post.proto
@server/public/pluginapi/grpc/proto/file.proto
@server/public/pluginapi/grpc/proto/user.proto

**Go hooks interface:**
@server/public/plugin/hooks.go

**Conventions from 03-01:**
- Every request: `RequestContext context = 1;` (for hooks with *Context, also `PluginContext plugin_context = 2;`)
- Every response with error return: `AppError error = 1;`
- Void hooks: Response has no error field
- Field numbering: Tag 1 reserved for context/error, business fields start at 2
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks_message.proto with message hook definitions</name>
  <files>server/public/pluginapi/grpc/proto/hooks_message.proto</files>
  <action>
Create hooks_message.proto defining request/response messages for all message-related hooks.

**Model types to define in this file:**
1. `PushNotification` - Maps to model.PushNotification (moderate size, define as typed proto)
2. `EmailNotification` - Maps to model.EmailNotification (use JSON blob - complex nested structure)
3. `EmailNotificationContent` - Maps to model.EmailNotificationContent (return type for hook)
4. `Preference` - Maps to model.Preference (simple 4-field struct)

**Hooks to define (12 total):**

1. `MessageWillBePosted(c *Context, post *model.Post) (*model.Post, string)`
   - Can modify/reject posts before save
   - Response includes optional modified_post and rejection_reason

2. `MessageWillBeUpdated(c *Context, newPost, oldPost *model.Post) (*model.Post, string)`
   - Can modify/reject post updates
   - Request has both new_post and old_post

3. `MessageHasBeenPosted(c *Context, post *model.Post)`
   - Notification after post saved
   - Void return (no error field in response)

4. `MessageHasBeenUpdated(c *Context, newPost, oldPost *model.Post)`
   - Notification after post updated
   - Void return

5. `MessagesWillBeConsumed(posts []*model.Post) []*model.Post`
   - Filter/modify posts before client delivery
   - No Context parameter, no error return

6. `MessageHasBeenDeleted(c *Context, post *model.Post)`
   - Notification after post deleted
   - Void return

7. `FileWillBeUploaded(c *Context, info *model.FileInfo, file io.Reader, output io.Writer) (*model.FileInfo, string)`
   - NOTE: Phase 8 will handle streaming. For now, use bytes for file content.
   - Request: plugin_context, file_info, file_content (bytes)
   - Response: error, modified_file_info, modified_content (bytes), rejection_reason

8. `ReactionHasBeenAdded(c *Context, reaction *model.Reaction)`
   - Notification after reaction added
   - Void return

9. `ReactionHasBeenRemoved(c *Context, reaction *model.Reaction)`
   - Notification after reaction removed
   - Void return

10. `NotificationWillBePushed(pushNotification *model.PushNotification, userID string) (*model.PushNotification, string)`
    - Can modify/reject push notifications
    - No Context parameter

11. `EmailNotificationWillBeSent(emailNotification *model.EmailNotification) (*model.EmailNotificationContent, string)`
    - Can modify/reject email notifications
    - Use JSON blob for EmailNotification (complex type)
    - Define typed EmailNotificationContent for return

12. `PreferencesHaveChanged(c *Context, preferences []model.Preference)`
    - Notification after preferences changed
    - Void return

**File structure:**
```protobuf
// Header comment block explaining purpose
// Imports: common.proto, hooks_common.proto, post.proto, file.proto

// Model types section
message PushNotification { ... }
message EmailNotificationJson { bytes notification_json = 1; }
message EmailNotificationContent { ... }
message Preference { ... }

// Hook messages (Request/Response pairs for each hook)
```

Follow snake_case for field names. Add comments documenting Go signature for each hook.
  </action>
  <verify>File exists and follows proto3 syntax</verify>
  <done>hooks_message.proto created with all 12 message hook definitions and 4 model types</done>
</task>

<task type="auto">
  <name>Task 2: Add message hook RPCs to PluginHooks service</name>
  <files>server/public/pluginapi/grpc/proto/hooks.proto</files>
  <action>
Update hooks.proto to:
1. Import hooks_message.proto
2. Add MESSAGE HOOKS section comment
3. Add 12 RPC definitions with documentation comments

Add RPCs in this order (matching hooks.go order):
```protobuf
// ===========================================================================
// MESSAGE HOOKS
// ===========================================================================

// MessageWillBePosted is invoked when a message is posted before it is committed.
// Return a modified post, rejection reason, or allow unchanged.
// Go signature: MessageWillBePosted(c *Context, post *model.Post) (*model.Post, string)
rpc MessageWillBePosted(MessageWillBePostedRequest) returns (MessageWillBePostedResponse);

// [Similar for all 12 hooks]
```

Each RPC should have a doc comment explaining:
- What the hook does
- When it's called
- How to use the return values
- The original Go signature
  </action>
  <verify>hooks.proto has valid syntax and imports hooks_message.proto</verify>
  <done>hooks.proto updated with 12 message hook RPCs</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile and generate Go code</name>
  <files>server/public/Makefile</files>
  <action>
1. Update PROTO_FILES or proto mapping in Makefile to include hooks_message.proto
2. Run `make proto-gen` from server/public directory
3. Verify generated files compile: `go build ./pluginapi/grpc/generated/go/pluginapiv1/...`

The Makefile should already have the pattern for adding new proto files from 03-01.
  </action>
  <verify>`make proto-gen` succeeds and `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds</verify>
  <done>Proto generation works, Go code compiles without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make proto-gen` succeeds in server/public
- [ ] `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds
- [ ] hooks_message.proto defines all 12 message hooks
- [ ] hooks.proto imports hooks_message.proto and has 12 new RPCs
- [ ] All model types defined (PushNotification, EmailNotificationContent, Preference)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 12 message-related hook RPCs added to PluginHooks service
- Generated Go code compiles
</success_criteria>

<output>
After completion, create `.planning/phases/03-hook-protobuf-definitions/03-02-SUMMARY.md`:

# Plan 03-02 Summary: Message Hook Protobuf Definitions

**Plan:** 03-02 (Message hooks)
**Phase:** 03-hook-protobuf-definitions
**Status:** Complete
**Date:** [date]

## Objective

Define protobuf/gRPC contracts for message-related plugin hooks.

## Tasks Completed

### Task 1: Create hooks_message.proto
- [Details of what was created]

### Task 2: Add message hook RPCs
- [List of RPCs added]

### Task 3: Generate and verify
- [Build results]

## Hooks Added

| Hook | Go Signature | Notes |
|------|-------------|-------|
| MessageWillBePosted | ... | ... |
[etc.]

## Model Types Added

- PushNotification
- EmailNotificationContent
- Preference

## Files Modified

- `server/public/pluginapi/grpc/proto/hooks_message.proto` (new)
- `server/public/pluginapi/grpc/proto/hooks.proto` (updated)
- Generated files in `server/public/pluginapi/grpc/generated/go/pluginapiv1/`

## Commits

[List commits]

## Verification

- [x] Proto generation succeeds
- [x] Go code compiles

## Next Step

Ready for 03-03-PLAN.md (User/Channel hooks)
</output>
