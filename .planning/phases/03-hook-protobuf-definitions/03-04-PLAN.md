---
phase: 03-hook-protobuf-definitions
plan: 04
type: execute
depends_on: ["03-01"]
files_modified:
  - server/public/pluginapi/grpc/proto/hooks_command.proto
  - server/public/pluginapi/grpc/proto/hooks.proto
  - server/public/Makefile
domain: grpc-protobuf
---

<objective>
Define protobuf/gRPC contracts for command execution, WebSocket events, cluster events, shared channels, and support data generation hooks.

Purpose: Enable Python plugins to receive command execution, WebSocket, cluster, and shared channel events with full type safety.
Output: hooks_command.proto with request/response messages, updated hooks.proto service with remaining RPCs. Phase 3 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-hook-protobuf-definitions/03-01-SUMMARY.md

**Existing proto files to reference:**
@server/public/pluginapi/grpc/proto/hooks.proto
@server/public/pluginapi/grpc/proto/hooks_lifecycle.proto
@server/public/pluginapi/grpc/proto/hooks_common.proto
@server/public/pluginapi/grpc/proto/common.proto
@server/public/pluginapi/grpc/proto/post.proto
@server/public/pluginapi/grpc/proto/file.proto
@server/public/pluginapi/grpc/proto/user.proto

**Go hooks interface:**
@server/public/plugin/hooks.go

**Model files for reference:**
- server/public/model/command_args.go - CommandArgs struct
- server/public/model/command_response.go - CommandResponse struct
- server/public/model/plugin_cluster_event.go - PluginClusterEvent struct
- server/public/model/websocket_request.go - WebSocketRequest struct
- server/public/model/shared_channel.go - SyncMsg, SyncResponse, RemoteCluster
- server/public/model/support_packet.go - FileData struct

**Conventions from 03-01:**
- Every request: `RequestContext context = 1;`
- Hooks with `*Context`: also `PluginContext plugin_context = 2;`
- Hooks returning error: `AppError error = 1;` in response
- Void hooks: Response has no error field

**NOTE:** ServeHTTP and ServeMetrics are deferred to Phase 8 (HTTP streaming).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks_command.proto with command/cluster/websocket hook definitions</name>
  <files>server/public/pluginapi/grpc/proto/hooks_command.proto</files>
  <action>
Create hooks_command.proto defining request/response messages for command, WebSocket, cluster, shared channel, and support hooks.

**Model types to define:**

1. `CommandArgs` - Maps to model.CommandArgs (moderate size, define typed)
   ```protobuf
   message CommandArgs {
     string user_id = 1;
     string channel_id = 2;
     string team_id = 3;
     string root_id = 4;
     string parent_id = 5;
     string trigger_id = 6;
     string command = 7;
     string site_url = 8;
     // Note: T, UserMentions, ChannelMentions omitted (function/map types handled server-side)
   }
   ```

2. `CommandResponse` - Maps to model.CommandResponse
   ```protobuf
   message CommandResponse {
     string response_type = 1;  // "in_channel" or "ephemeral"
     string text = 2;
     string username = 3;
     string channel_id = 4;
     string icon_url = 5;
     string type = 6;
     google.protobuf.Struct props = 7;
     string goto_location = 8;
     string trigger_id = 9;
     bool skip_slack_parsing = 10;
     repeated SlackAttachment attachments = 11;
     repeated CommandResponse extra_responses = 12;
   }
   ```

3. `SlackAttachment` - Maps to model.SlackAttachment (nested in CommandResponse)

4. `PluginClusterEvent` - Maps to model.PluginClusterEvent (simple: id + bytes)
   ```protobuf
   message PluginClusterEvent {
     string id = 1;
     bytes data = 2;
   }
   ```

5. `WebSocketRequest` - Maps to model.WebSocketRequest (client-provided fields only)
   ```protobuf
   message WebSocketRequest {
     int64 seq = 1;
     string action = 2;
     google.protobuf.Struct data = 3;
   }
   ```

6. `SyncMsgJson` - JSON blob for model.SyncMsg (complex nested structure)
7. `SyncResponse` - Maps to model.SyncResponse (response for sync hook)
8. `RemoteCluster` - Maps to model.RemoteCluster (moderate size, define typed)
9. `FileData` - Maps to model.FileData (for GenerateSupportData)
   ```protobuf
   message FileData {
     string filename = 1;
     bytes body = 2;
   }
   ```

**Hooks to define (11 total, excluding ServeHTTP/ServeMetrics):**

1. `ExecuteCommand(c *Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError)`
   - Execute registered slash command
   - Returns CommandResponse + AppError

2. `OnPluginClusterEvent(c *Context, ev model.PluginClusterEvent)`
   - Receive intra-cluster plugin event
   - Void return

3. `OnWebSocketConnect(webConnID, userID string)`
   - New WebSocket connection opened
   - No Context, void return

4. `OnWebSocketDisconnect(webConnID, userID string)`
   - WebSocket connection closed
   - No Context, void return

5. `WebSocketMessageHasBeenPosted(webConnID, userID string, req *model.WebSocketRequest)`
   - WebSocket message received
   - No Context, void return

6. `OnSharedChannelsSyncMsg(msg *model.SyncMsg, rc *model.RemoteCluster) (model.SyncResponse, error)`
   - Shared channels sync message received
   - Use JSON blob for SyncMsg (complex nested structure)
   - Returns SyncResponse + error

7. `OnSharedChannelsPing(rc *model.RemoteCluster) bool`
   - Health check for shared channels plugin
   - Returns bool (healthy or not)

8. `OnSharedChannelsAttachmentSyncMsg(fi *model.FileInfo, post *model.Post, rc *model.RemoteCluster) error`
   - File attachment sync message
   - Returns error

9. `OnSharedChannelsProfileImageSyncMsg(user *model.User, rc *model.RemoteCluster) error`
   - Profile image sync message
   - Returns error

10. `GenerateSupportData(c *Context) ([]*model.FileData, error)`
    - Generate plugin support data
    - Returns list of FileData + error

**File structure:**
```protobuf
// Header comment explaining purpose
// Imports: google/protobuf/struct.proto, common.proto, hooks_common.proto, file.proto, post.proto, user.proto

// Model types section (CommandArgs, CommandResponse, SlackAttachment, etc.)

// Hook messages (Request/Response pairs for each hook)
```
  </action>
  <verify>File exists and follows proto3 syntax</verify>
  <done>hooks_command.proto created with all 11 hook definitions and model types</done>
</task>

<task type="auto">
  <name>Task 2: Add remaining hook RPCs to PluginHooks service</name>
  <files>server/public/pluginapi/grpc/proto/hooks.proto</files>
  <action>
Update hooks.proto to:
1. Import hooks_command.proto
2. Add COMMAND HOOKS section comment
3. Add WEBSOCKET HOOKS section comment
4. Add CLUSTER HOOKS section comment
5. Add SHARED CHANNELS HOOKS section comment
6. Add SUPPORT HOOKS section comment
7. Add 11 RPC definitions with documentation comments

**Command hooks:**
```protobuf
// ===========================================================================
// COMMAND HOOKS
// ===========================================================================

// ExecuteCommand executes a registered slash command.
// Go signature: ExecuteCommand(c *Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError)
rpc ExecuteCommand(ExecuteCommandRequest) returns (ExecuteCommandResponse);
```

**WebSocket hooks:**
```protobuf
// ===========================================================================
// WEBSOCKET HOOKS
// ===========================================================================

// OnWebSocketConnect is invoked when a new WebSocket connection is opened.
// Go signature: OnWebSocketConnect(webConnID, userID string)
rpc OnWebSocketConnect(OnWebSocketConnectRequest) returns (OnWebSocketConnectResponse);

// OnWebSocketDisconnect is invoked when a WebSocket connection is closed.
// Go signature: OnWebSocketDisconnect(webConnID, userID string)
rpc OnWebSocketDisconnect(OnWebSocketDisconnectRequest) returns (OnWebSocketDisconnectResponse);

// WebSocketMessageHasBeenPosted is invoked when a WebSocket message is received.
// Go signature: WebSocketMessageHasBeenPosted(webConnID, userID string, req *model.WebSocketRequest)
rpc WebSocketMessageHasBeenPosted(WebSocketMessageHasBeenPostedRequest) returns (WebSocketMessageHasBeenPostedResponse);
```

**Cluster hooks:**
```protobuf
// ===========================================================================
// CLUSTER HOOKS
// ===========================================================================

// OnPluginClusterEvent is invoked when an intra-cluster plugin event is received.
// Go signature: OnPluginClusterEvent(c *Context, ev model.PluginClusterEvent)
rpc OnPluginClusterEvent(OnPluginClusterEventRequest) returns (OnPluginClusterEventResponse);
```

**Shared channels hooks:**
```protobuf
// ===========================================================================
// SHARED CHANNELS HOOKS
// ===========================================================================

// [Add 4 shared channels hooks]
```

**Support hooks:**
```protobuf
// ===========================================================================
// SUPPORT HOOKS
// ===========================================================================

// GenerateSupportData is invoked when a Support Packet gets generated.
// Go signature: GenerateSupportData(c *Context) ([]*model.FileData, error)
rpc GenerateSupportData(GenerateSupportDataRequest) returns (GenerateSupportDataResponse);
```

**Add header note:**
```protobuf
// NOTE: ServeHTTP and ServeMetrics are deferred to Phase 8 (HTTP streaming).
// These hooks require HTTP request/response streaming over gRPC.
```
  </action>
  <verify>hooks.proto has valid syntax and imports hooks_command.proto</verify>
  <done>hooks.proto updated with 11 remaining hook RPCs, Phase 3 complete</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile and generate Go code</name>
  <files>server/public/Makefile</files>
  <action>
1. Update PROTO_FILES or proto mapping in Makefile to include hooks_command.proto
2. Run `make proto-gen` from server/public directory
3. Verify generated files compile: `go build ./pluginapi/grpc/generated/go/pluginapiv1/...`
4. Verify all hooks.proto imports are correct

**Final verification:**
- Count total RPCs in PluginHooks service (should be 9 lifecycle + 12 message + 10 user/channel + 11 command = 42 total, excluding deferred ServeHTTP/ServeMetrics)
  </action>
  <verify>`make proto-gen` succeeds and `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds</verify>
  <done>Proto generation works, Go code compiles, Phase 3 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make proto-gen` succeeds in server/public
- [ ] `go build ./pluginapi/grpc/generated/go/pluginapiv1/...` succeeds
- [ ] hooks_command.proto defines all 11 remaining hooks
- [ ] hooks.proto imports hooks_command.proto and has 11 new RPCs
- [ ] All model types defined (CommandArgs, CommandResponse, PluginClusterEvent, etc.)
- [ ] Total hook count: ~42 RPCs in PluginHooks service (verify against hooks.go)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 11 hook RPCs added to PluginHooks service
- Generated Go code compiles
- Phase 3 (Hook Protobuf Definitions) complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-hook-protobuf-definitions/03-04-SUMMARY.md`:

# Plan 03-04 Summary: Command/WebSocket/Cluster Hook Protobuf Definitions

**Plan:** 03-04 (Command/WebSocket/Cluster hooks)
**Phase:** 03-hook-protobuf-definitions
**Status:** Complete
**Date:** [date]

## Objective

Define protobuf/gRPC contracts for command, WebSocket, cluster, shared channels, and support hooks.

## Tasks Completed

### Task 1: Create hooks_command.proto
- [Details]

### Task 2: Add remaining hook RPCs
- [List of RPCs added]

### Task 3: Generate and verify
- [Build results]

## Hooks Added

| Hook | Go Signature | Notes |
|------|-------------|-------|
| ExecuteCommand | ... | ... |
[etc.]

## Model Types Added

- CommandArgs
- CommandResponse
- SlackAttachment
- PluginClusterEvent
- WebSocketRequest
- SyncMsgJson (JSON blob)
- SyncResponse
- RemoteCluster
- FileData

## Deferred to Phase 8

- ServeHTTP (requires HTTP streaming)
- ServeMetrics (requires HTTP streaming)

## Files Modified

- `server/public/pluginapi/grpc/proto/hooks_command.proto` (new)
- `server/public/pluginapi/grpc/proto/hooks.proto` (updated)
- Generated files

## Commits

[List commits]

## Phase 3 Summary

**Total hooks defined:** ~42 RPCs (excluding ServeHTTP/ServeMetrics)
- Lifecycle: 9 hooks
- Message: 12 hooks
- User/Channel: 10 hooks
- Command/WebSocket/Cluster: 11 hooks

**Proto files created:**
- hooks_common.proto (shared types)
- hooks_lifecycle.proto (lifecycle hooks)
- hooks_message.proto (message hooks)
- hooks_user_channel.proto (user/channel hooks)
- hooks_command.proto (command/websocket/cluster hooks)
- hooks.proto (service definition)

## Verification

- [x] Proto generation succeeds
- [x] Go code compiles

## Next Step

Phase 3 complete. Ready for Phase 4 (Go gRPC Server implementation).
</output>
