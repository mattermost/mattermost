---
phase: 10-integration-testing
plan: 02
type: execute
depends_on: ["10-01"]
files_modified:
  - server/public/pluginapi/grpc/server/integration_test.go
  - python-sdk/tests/test_integration_e2e.py
---

<objective>
Create end-to-end integration tests proving Go gRPC server and Python SDK communicate correctly.

Purpose: Validate the complete data path: Go server -> gRPC -> Python client -> Python plugin -> gRPC -> Go server. Catch integration issues before users encounter them.
Output: Integration test suites in both Go and Python that exercise real gRPC communication.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/05-python-supervisor/05-02-SUMMARY.md (fake interpreter pattern)
@.planning/phases/08-servehttp-streaming/08-01-SUMMARY.md (streaming tests)

# Existing test patterns
@server/public/pluginapi/grpc/server/api_server_test.go
@python-sdk/tests/test_hooks_grpc_integration.py

**Tech stack available:** Go testing, pytest, grpcio, fake interpreter pattern
**Established patterns:**
- Go: `testing.T`, mock API via interface
- Python: pytest with fixtures, mock gRPC channels
- Fake interpreter pattern from Phase 5-02 for hermetic testing
**Constraining decisions:**
- Phase 05-02: Fake Python interpreter binaries for controlled testing
- Phase 04-01: gRPC error mapping to HTTP status codes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Go integration test for Python plugin lifecycle</name>
  <files>server/public/pluginapi/grpc/server/integration_test.go</files>
  <action>
Create integration tests proving Go can communicate with a Python-style gRPC plugin.

Build on the fake interpreter pattern from Phase 5-02:
1. Create a test binary that starts a gRPC server implementing PluginHooks
2. Test binary reports hooks via `Implemented` RPC
3. Test binary responds to hook invocations

Test scenarios:
1. **TestPythonPluginLifecycle**: Start fake plugin, call OnActivate, verify response, call OnDeactivate
2. **TestPythonPluginAPICall**: Start fake plugin, have it call back to API server via gRPC, verify round-trip
3. **TestPythonPluginHookChain**: Start fake plugin, invoke MessageWillBePosted, verify post modification

Implementation approach:
- Use `exec.Command` to start test binary (like existing python_supervisor_test.go)
- Establish gRPC connection to test binary
- Call hook RPCs and verify responses
- Use `t.Cleanup()` for process cleanup

Reference: `server/public/plugin/python_supervisor_test.go` for fake interpreter patterns.

AVOID: Requiring actual Python installation. Tests must be hermetic using Go-compiled binaries.
  </action>
  <verify>cd server/public/pluginapi/grpc/server && go test -v -run "TestPythonPlugin" -count=1 2>&1 | head -30</verify>
  <done>Integration tests pass, proving Go ↔ fake Python plugin communication works</done>
</task>

<task type="auto">
  <name>Task 2: Create Python integration tests for gRPC round-trip</name>
  <files>python-sdk/tests/test_integration_e2e.py</files>
  <action>
Create Python integration tests proving the SDK communicates correctly with a gRPC server.

Test scenarios:
1. **test_api_round_trip**: Connect to mock server, call API methods, verify responses match
2. **test_hook_invocation_chain**: Register hook, receive invocation, return response, verify server receives it
3. **test_error_propagation**: Server returns AppError, verify Python raises appropriate PluginAPIError
4. **test_streaming_http**: If practical, test ServeHTTP request/response streaming

Implementation approach:
- Use pytest fixtures to start a mock gRPC server in a thread
- Create PluginAPIClient connected to localhost
- Exercise multiple API methods and hooks
- Verify correct serialization/deserialization of complex types (User, Post, etc.)

Reference existing patterns:
- `test_hooks_grpc_integration.py` for gRPC testing patterns
- `test_client_smoke.py` for client testing patterns

Mark tests that require actual server with `@pytest.mark.integration` for easy filtering.
  </action>
  <verify>cd python-sdk && python -m pytest tests/test_integration_e2e.py -v --tb=short 2>&1 | head -40</verify>
  <done>Python integration tests pass, proving Python SDK ↔ gRPC server communication works</done>
</task>

<task type="auto">
  <name>Task 3: Add CI-friendly test runner scripts</name>
  <files>python-sdk/scripts/run_integration_tests.sh, server/public/pluginapi/grpc/scripts/run_integration_tests.sh</files>
  <action>
Create shell scripts for running integration tests in CI environments.

Python script (`python-sdk/scripts/run_integration_tests.sh`):
```bash
#!/bin/bash
set -e
cd "$(dirname "$0")/.."
python -m pytest tests/test_integration_e2e.py -v --tb=short
```

Go script (`server/public/pluginapi/grpc/scripts/run_integration_tests.sh`):
```bash
#!/bin/bash
set -e
cd "$(dirname "$0")/.."
go test -v -run "TestPythonPlugin|TestIntegration" ./server/...
```

Make both executable with `chmod +x`.

These scripts provide:
- Consistent test invocation across environments
- Easy CI integration (just run the script)
- Filter to integration tests only
  </action>
  <verify>test -x python-sdk/scripts/run_integration_tests.sh && test -x server/public/pluginapi/grpc/scripts/run_integration_tests.sh</verify>
  <done>Both test runner scripts exist and are executable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Go integration tests compile: `go build ./server/public/pluginapi/grpc/server/...`
- [ ] Go integration tests pass (or skip gracefully if dependencies missing)
- [ ] Python integration tests pass: `python -m pytest tests/test_integration_e2e.py`
- [ ] Test runner scripts are executable
</verification>

<success_criteria>

- All tasks completed
- Integration tests prove Go ↔ Python gRPC communication works
- Tests are hermetic (no external dependencies beyond Go/Python)
- CI-friendly runner scripts exist
</success_criteria>

<output>
After completion, create `.planning/phases/10-integration-testing/10-02-SUMMARY.md`:

# Phase 10 Plan 02: Integration Test Suite Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `server/public/pluginapi/grpc/server/integration_test.go` - Go integration tests
- `python-sdk/tests/test_integration_e2e.py` - Python integration tests
- `python-sdk/scripts/run_integration_tests.sh` - Python test runner
- `server/public/pluginapi/grpc/scripts/run_integration_tests.sh` - Go test runner

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 10-03-PLAN.md (Performance benchmarks and documentation)
</output>
