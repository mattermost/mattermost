---
phase: 17-mcp-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/langchain-agent/requirements.txt
  - plugins/langchain-agent/plugin.py
autonomous: true

must_haves:
  truths:
    - "Plugin can connect to MCP servers on activation"
    - "MCP tools are available to the LLM agents"
    - "Agent uses MCP tools when appropriate for user queries"
    - "Plugin falls back to basic chat when no MCP servers configured"
  artifacts:
    - path: "plugins/langchain-agent/requirements.txt"
      provides: "MCP and LangGraph dependencies"
      contains: "langchain-mcp-adapters"
    - path: "plugins/langchain-agent/plugin.py"
      provides: "MCP client initialization and agent creation"
      contains: "MultiServerMCPClient"
  key_links:
    - from: "plugins/langchain-agent/plugin.py"
      to: "MultiServerMCPClient"
      via: "import and initialization in on_activate"
      pattern: "MultiServerMCPClient"
    - from: "plugins/langchain-agent/plugin.py"
      to: "create_agent"
      via: "agent creation with MCP tools"
      pattern: "create_agent.*tools"
---

<objective>
Integrate Model Context Protocol (MCP) client capabilities into the LangChain agent plugin.

Purpose: Enable the AI bots to use external tools via MCP servers (HTTP and STDIO transports), extending their capabilities beyond simple chat to interact with external systems, databases, and APIs.

Output: Updated plugin with MCP client initialization, async message handling, and agent-based tool execution using `create_agent()` from LangGraph.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-mcp-client/17-RESEARCH.md
@.planning/phases/16-session-memory/16-01-SUMMARY.md
@plugins/langchain-agent/plugin.py
@plugins/langchain-agent/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP dependencies and imports</name>
  <files>plugins/langchain-agent/requirements.txt, plugins/langchain-agent/plugin.py</files>
  <action>
Update requirements.txt to add MCP and LangGraph dependencies:
```
langchain>=1.2.0
langchain-mcp-adapters>=0.2.0
langgraph>=0.2.0
```

Note: Bump langchain to >=1.2.0 per research recommendation (existing requirements.txt has >=0.2.0 which is too old for MCP adapter compatibility).

Update plugin.py imports section to add:
```python
import asyncio
from langchain_mcp_adapters.client import MultiServerMCPClient
from langgraph.prebuilt import create_react_agent
```

Note: Use `create_react_agent` from `langgraph.prebuilt` (not `langchain.agents.create_agent` which doesn't exist). This is the standard way to create a ReAct agent with LangGraph.

Note: `create_react_agent` accepts LangChain message objects (HumanMessage, AIMessage, SystemMessage) directly in its `{"messages": [...]}` input format. The `_build_conversation_history` method already returns this format, so no conversion is needed.

Add instance attributes in `__init__`:
```python
self.mcp_client: MultiServerMCPClient | None = None
```
  </action>
  <verify>
Run `python -c "from langchain_mcp_adapters.client import MultiServerMCPClient; from langgraph.prebuilt import create_react_agent; print('imports ok')"` in the plugin directory after installing deps.
  </verify>
  <done>requirements.txt includes langchain-mcp-adapters and langgraph; plugin.py imports MultiServerMCPClient and create_react_agent; mcp_client attribute added to __init__</done>
</task>

<task type="auto">
  <name>Task 2: Initialize MCP client and convert handlers to async agents</name>
  <files>plugins/langchain-agent/plugin.py</files>
  <action>
1. Add `_get_mcp_server_config()` method that returns MCP server configuration. For now, return a hardcoded demo config that can be easily modified:
```python
def _get_mcp_server_config(self) -> dict:
    """
    Get MCP server configuration.
    
    Returns dict of server configs. Each server needs:
    - For STDIO: transport="stdio", command="...", args=[...]
    - For HTTP: transport="http", url="..."
    
    Returns empty dict if no servers configured.
    """
    # TODO: In future, read from plugin settings
    # For now, return empty dict - no MCP servers configured by default
    return {}
```

2. Initialize MCP client in `on_activate()` after model initialization:
```python
# Initialize MCP client with configured servers
mcp_config = self._get_mcp_server_config()
if mcp_config:
    try:
        self.mcp_client = MultiServerMCPClient(mcp_config)
        self.logger.info(f"MCP client initialized with {len(mcp_config)} server(s)")
    except Exception as e:
        self.logger.warning(f"Failed to initialize MCP client: {e}")
        self.mcp_client = None
else:
    self.logger.info("No MCP servers configured, running without tools")
    self.mcp_client = None
```

3. Add async message handler that uses agents when MCP tools available:
```python
async def _handle_message_async(self, post: Post, model, bot_id: str, system_prompt: str) -> None:
    """Handle message with optional MCP tool support."""
    root_id = post.root_id if post.root_id else post.id
    
    if model is None:
        self._send_error_response(post.channel_id, "Model not configured.", root_id)
        return
    
    # Build conversation history
    messages = self._build_conversation_history(post, bot_id, system_prompt)
    
    # If MCP client available, use agent with tools
    if self.mcp_client is not None:
        try:
            tools = await self.mcp_client.get_tools()
            if tools:
                # Create agent with tools
                agent = create_react_agent(model, tools)
                # Convert messages to format agent expects
                response = await agent.ainvoke({"messages": messages})
                # Extract final response
                last_message = response["messages"][-1]
                self._send_response(post.channel_id, last_message.content, root_id)
                return
        except Exception as e:
            self.logger.warning(f"MCP tools unavailable, falling back to basic chat: {e}")
    
    # Fallback to basic model invocation (no tools)
    try:
        response = model.invoke(messages)
        self._send_response(post.channel_id, response.content, root_id)
    except Exception as e:
        self.logger.error(f"Model API error: {e}")
        self._send_error_response(post.channel_id, f"API error: {e}", root_id)
```

4. Update `_handle_openai_message` and `_handle_anthropic_message` to use async handler:
```python
def _handle_openai_message(self, post: Post) -> None:
    """Handle a message directed to the OpenAI bot."""
    self.logger.info(f"OpenAI Agent processing message: {post.message[:50]}...")
    asyncio.run(self._handle_message_async(
        post,
        self.openai_model,
        self.openai_bot_id,
        "You are a helpful AI assistant powered by OpenAI. Be concise and helpful."
    ))

def _handle_anthropic_message(self, post: Post) -> None:
    """Handle a message directed to the Anthropic bot."""
    self.logger.info(f"Anthropic Agent processing message: {post.message[:50]}...")
    asyncio.run(self._handle_message_async(
        post,
        self.anthropic_model,
        self.anthropic_bot_id,
        "You are a helpful AI assistant powered by Anthropic Claude. Be concise and helpful."
    ))
```

Remove the old implementation bodies from both handlers (they now just delegate to the async handler).
  </action>
  <verify>
1. Plugin syntax valid: `python -m py_compile plugins/langchain-agent/plugin.py`
2. Verify imports work after installing new deps: `cd plugins/langchain-agent && pip install -r requirements.txt && python -c "import plugin; print('module loads')"`
  </verify>
  <done>Plugin initializes MCP client from config; handlers use asyncio.run() with create_react_agent when tools available; graceful fallback to basic chat when no MCP servers configured</done>
</task>

</tasks>

<verification>
1. Syntax check passes: `python -m py_compile plugins/langchain-agent/plugin.py`
2. Dependencies install without error: `pip install -r plugins/langchain-agent/requirements.txt`
3. Plugin loads without runtime errors
4. With empty MCP config, plugin logs "No MCP servers configured" and uses basic chat
5. Existing functionality (multi-turn conversations, threading) still works
</verification>

<success_criteria>
- Plugin compiles and loads without errors
- MCP client initialized when config provided, None when empty
- Handlers use create_react_agent with MCP tools when available
- Falls back to direct model.invoke() when no MCP servers configured
- Threading and conversation history preserved from Phase 16
</success_criteria>

<output>
After completion, create `.planning/phases/17-mcp-client/17-01-SUMMARY.md`
</output>
