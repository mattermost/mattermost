---
phase: 09-manifest-extension
plan: 01
type: execute
depends_on: []
files_modified: [server/public/model/manifest.go, server/public/model/manifest_test.go, api/v4/source/definitions.yaml]
---

<objective>
Extend Go manifest model and OpenAPI schema with Python plugin fields.

Purpose: Formalize Python plugin detection with proper manifest fields instead of the transitional props.runtime hack, enabling explicit runtime declaration for Python plugins.
Output: Updated ManifestServer with runtime/python fields, OpenAPI schema with new fields, unit tests proving JSON/YAML parsing works.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-python-supervisor/05-01-SUMMARY.md

# Key source files
@server/public/model/manifest.go
@server/public/model/manifest_test.go
@api/v4/source/definitions.yaml

**Tech stack available:** Go model with JSON/YAML tags, OpenAPI 3.0 schemas
**Established patterns:** ManifestServer struct with optional fields, JSON+YAML tag consistency
**Constraining decisions:**
- Phase 05-01: Python detection currently uses .py extension OR props.runtime="python" as transitional marker
- Backward compatibility: existing Go plugins must continue working unchanged
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ManifestServer struct with Python fields</name>
  <files>server/public/model/manifest.go</files>
  <action>
Add new fields to ManifestServer struct:

1. Add `Runtime` field:
   - Type: `string`
   - JSON tag: `json:"runtime,omitempty"`
   - YAML tag: `yaml:"runtime,omitempty"`
   - Comment: "Runtime specifies the plugin runtime. Valid values: 'go' (default if empty), 'python'."

2. Add `PythonVersion` field:
   - Type: `string`
   - JSON tag: `json:"python_version,omitempty"`
   - YAML tag: `yaml:"python_version,omitempty"`
   - Comment: "PythonVersion specifies the minimum Python version required (e.g. '3.10', '>=3.11'). Only applicable when Runtime is 'python'."

3. Add `Python` field (nested struct for Python-specific config):
   - Type: `*ManifestPython`
   - JSON tag: `json:"python,omitempty"`
   - YAML tag: `yaml:"python,omitempty"`

4. Create new `ManifestPython` struct with fields:
   - `DependencyMode string` - "system", "venv", "bundled" (json:"dependency_mode,omitempty" yaml:"dependency_mode,omitempty")
   - `VenvPath string` - relative path to venv directory (json:"venv_path,omitempty" yaml:"venv_path,omitempty")
   - `RequirementsPath string` - relative path to requirements file (json:"requirements_path,omitempty" yaml:"requirements_path,omitempty")

5. Update the doc comment example at the top of the Manifest struct to show a Python plugin variant.

Do NOT add validation logic yet - keep fields optional for backward compatibility. Validation can be added in a follow-up if needed.
  </action>
  <verify>go build ./server/public/model/... compiles without errors</verify>
  <done>ManifestServer has Runtime, PythonVersion, Python fields; ManifestPython struct defined; code compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add manifest unmarshal tests for Python fields</name>
  <files>server/public/model/manifest_test.go</files>
  <action>
Add test cases to TestManifestUnmarshal function that verify Python plugin manifests parse correctly:

1. Create a new test variant in TestManifestUnmarshal (or add a new test function TestManifestUnmarshalPython):
   - Define an expected Manifest with:
     - Server.Runtime = "python"
     - Server.PythonVersion = "3.11"
     - Server.Executable = "server/plugin.py"
     - Server.Python = &ManifestPython{
         DependencyMode: "venv",
         VenvPath: "server/venv",
         RequirementsPath: "server/requirements.txt",
       }

2. Add YAML test case that unmarshals a Python plugin manifest string and asserts equality with expected.

3. Add JSON test case that unmarshals a Python plugin manifest JSON string and asserts equality with expected.

4. Add a backward compatibility test case: verify an existing Go plugin manifest (no runtime field) still parses correctly with Runtime as empty string.

Use existing test patterns from TestManifestUnmarshal.
  </action>
  <verify>go test ./server/public/model -run TestManifest -v passes</verify>
  <done>Python manifest unmarshal tests exist and pass for both JSON and YAML; backward compatibility verified</done>
</task>

<task type="auto">
  <name>Task 3: Update OpenAPI schema with Python fields</name>
  <files>api/v4/source/definitions.yaml</files>
  <action>
Extend the PluginManifest.server object in definitions.yaml (around line 2895-2912):

1. Add `runtime` property under server:
   ```yaml
   runtime:
     type: string
     description: |
       The plugin runtime. Valid values: "go" (default), "python".
       When set to "python", the server will use the Python supervisor to run the plugin.
     enum:
       - go
       - python
   ```

2. Add `python_version` property under server:
   ```yaml
   python_version:
     type: string
     description: |
       Minimum Python version required for Python plugins (e.g. "3.10", ">=3.11").
       Only applicable when runtime is "python". Informational - used for validation and error messages.
   ```

3. Add `python` object property under server:
   ```yaml
   python:
     type: object
     description: Python-specific configuration. Only applicable when runtime is "python".
     properties:
       dependency_mode:
         type: string
         description: |
           How Python dependencies are managed.
           - "system": Use system Python with no isolated dependencies
           - "venv": Use a virtual environment bundled with the plugin
           - "bundled": Dependencies are bundled directly in the plugin package
         enum:
           - system
           - venv
           - bundled
       venv_path:
         type: string
         description: Relative path to the virtual environment directory (e.g. "server/venv"). Only used when dependency_mode is "venv".
       requirements_path:
         type: string
         description: Relative path to the requirements.txt file (e.g. "server/requirements.txt").
   ```

Place these after the existing `executable` property but before `webapp`. Maintain consistent indentation (2 spaces for YAML).
  </action>
  <verify>The YAML file is valid (no syntax errors when parsed)</verify>
  <done>OpenAPI definitions.yaml has runtime, python_version, and python object with sub-properties</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./server/public/model/...` succeeds
- [ ] `go test ./server/public/model -run TestManifest -v` passes
- [ ] definitions.yaml is valid YAML (can be parsed without errors)
</verification>

<success_criteria>

- ManifestServer struct has Runtime, PythonVersion, Python fields
- ManifestPython struct defined with DependencyMode, VenvPath, RequirementsPath
- Tests verify JSON and YAML parsing of Python plugin manifests
- Backward compatibility maintained (existing manifests still parse)
- OpenAPI schema updated with all new fields and descriptions
</success_criteria>

<output>
After completion, create `.planning/phases/09-manifest-extension/09-01-SUMMARY.md`
</output>
