---
phase: 09-manifest-extension
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [server/public/plugin/python_supervisor.go, server/public/plugin/python_supervisor_test.go, webapp/platform/types/src/plugins.ts]
---

<objective>
Update Python supervisor detection to use proper manifest fields and add TypeScript types.

Purpose: Replace transitional props.runtime hack with proper manifest field detection, complete the type system across Go/TS, ensure full integration.
Output: isPythonPlugin() uses manifest.Server.Runtime, TypeScript types updated, tests verify new detection logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-manifest-extension/09-01-SUMMARY.md

# Key source files
@server/public/plugin/python_supervisor.go
@server/public/plugin/python_supervisor_test.go
@webapp/platform/types/src/plugins.ts
@server/public/model/manifest.go

**Tech stack available:** Go model with Runtime field (from 09-01), TypeScript interfaces
**Established patterns:** isPythonPlugin() detection, PluginManifestServer TS type
**Constraining decisions:**
- Phase 05-01: Current detection uses .py extension OR props.runtime="python"
- Phase 09-01: Runtime field now available in ManifestServer
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update isPythonPlugin to use manifest.Server.Runtime</name>
  <files>server/public/plugin/python_supervisor.go</files>
  <action>
Update the isPythonPlugin function to prioritize the new Runtime field:

1. Change detection order to:
   a. First check manifest.Server.Runtime == "python" (explicit declaration)
   b. Then check executable ends with .py (fallback for migration)
   c. Remove props.runtime check (transitional hack no longer needed)

2. Update the function comment to reflect the new detection strategy:
   ```go
   // isPythonPlugin determines if a plugin manifest indicates a Python plugin.
   // Detection uses:
   // 1. Server.Runtime field explicitly set to "python"
   // 2. Server executable ends with .py (fallback for backward compatibility)
   ```

3. The function should look like:
   ```go
   func isPythonPlugin(manifest *model.Manifest) bool {
       if manifest == nil || manifest.Server == nil {
           return false
       }

       // Check explicit runtime declaration
       if manifest.Server.Runtime == "python" {
           return true
       }

       // Fallback: check executable extension for backward compatibility
       executable := manifest.GetExecutableForRuntime(runtime.GOOS, runtime.GOARCH)
       return strings.HasSuffix(executable, ".py")
   }
   ```

Do NOT remove the .py extension fallback - it provides backward compatibility for plugins that haven't updated their manifest yet.
  </action>
  <verify>go build ./server/public/plugin/... compiles without errors</verify>
  <done>isPythonPlugin uses Server.Runtime field with .py extension fallback; props.runtime hack removed</done>
</task>

<task type="auto">
  <name>Task 2: Update Python supervisor tests for new detection</name>
  <files>server/public/plugin/python_supervisor_test.go</files>
  <action>
Update tests in python_supervisor_test.go:

1. Add test case for explicit Runtime="python" detection:
   ```go
   {
       name: "python runtime from manifest field",
       manifest: &model.Manifest{
           Server: &model.ManifestServer{
               Runtime:    "python",
               Executable: "server/plugin",  // No .py extension
           },
       },
       expected: true,
   },
   ```

2. Add test case verifying Runtime="go" is not Python:
   ```go
   {
       name: "go runtime explicit",
       manifest: &model.Manifest{
           Server: &model.ManifestServer{
               Runtime:    "go",
               Executable: "server/plugin",
           },
       },
       expected: false,
   },
   ```

3. Keep existing test for .py extension fallback (backward compatibility).

4. Remove or update any test that relied on props.runtime="python" - this is no longer supported.

5. Add test case with PythonVersion and Python config to verify full manifest parsing:
   ```go
   {
       name: "python with full config",
       manifest: &model.Manifest{
           Server: &model.ManifestServer{
               Runtime:       "python",
               PythonVersion: "3.11",
               Executable:    "server/main.py",
               Python: &model.ManifestPython{
                   DependencyMode: "venv",
                   VenvPath:       "server/venv",
               },
           },
       },
       expected: true,
   },
   ```
  </action>
  <verify>go test ./server/public/plugin -run TestIsPythonPlugin -v passes</verify>
  <done>Tests cover Runtime field detection, explicit go runtime, .py fallback, and full Python config</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript PluginManifestServer type</name>
  <files>webapp/platform/types/src/plugins.ts</files>
  <action>
Update the PluginManifestServer type to include Python fields:

1. Add runtime field:
   ```typescript
   runtime?: 'go' | 'python';
   ```

2. Add python_version field:
   ```typescript
   python_version?: string;
   ```

3. Add python object field with nested type:
   ```typescript
   python?: {
       dependency_mode?: 'system' | 'venv' | 'bundled';
       venv_path?: string;
       requirements_path?: string;
   };
   ```

4. Make executable optional (since Python plugins may use runtime field without specifying per-platform executables):
   Change `executable: string;` to `executable?: string;`

The updated PluginManifestServer should look like:
```typescript
export type PluginManifestServer = {
    executables?: {
        'linux-amd64'?: string;
        'darwin-amd64'?: string;
        'windows-amd64'?: string;
    };
    executable?: string;
    runtime?: 'go' | 'python';
    python_version?: string;
    python?: {
        dependency_mode?: 'system' | 'venv' | 'bundled';
        venv_path?: string;
        requirements_path?: string;
    };
};
```

Place new fields after executable for logical grouping.
  </action>
  <verify>TypeScript file has valid syntax (no parse errors)</verify>
  <done>PluginManifestServer has runtime, python_version, python fields; executable is optional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./server/public/plugin/...` succeeds
- [ ] `go test ./server/public/plugin -run TestIsPythonPlugin -v` passes
- [ ] TypeScript types are syntactically valid
</verification>

<success_criteria>

- isPythonPlugin() prioritizes Server.Runtime over .py extension
- props.runtime hack removed from detection logic
- Tests verify Runtime field detection works correctly
- Backward compatibility maintained (.py extension still works)
- TypeScript PluginManifestServer has all Python fields
- Phase 9 complete - manifest extension done
</success_criteria>

<output>
After completion, create `.planning/phases/09-manifest-extension/09-02-SUMMARY.md`
</output>
