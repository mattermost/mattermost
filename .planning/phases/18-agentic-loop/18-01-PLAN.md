---
phase: 18-agentic-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/langchain-agent/plugin.py
  - plugins/langchain-agent/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Agent retries failed tool calls up to 3 times with exponential backoff"
    - "Agent stops after maximum 10 iterations to prevent infinite loops"
    - "Anthropic agent uses extended thinking for complex reasoning"
    - "Tool errors gracefully fall back to tool-less model instead of crashing"
  artifacts:
    - path: "plugins/langchain-agent/plugin.py"
      provides: "Enhanced agentic loop with retry and limits"
      contains: "recursion_limit"
    - path: "plugins/langchain-agent/plugin.py"
      provides: "Extended thinking for Anthropic"
      contains: "thinking"
    - path: "plugins/langchain-agent/plugin.py"
      provides: "Tool error handling with retry"
      contains: "@retry"
    - path: "plugins/langchain-agent/requirements.txt"
      provides: "Updated dependencies with tenacity"
      contains: "tenacity"
  key_links:
    - from: "plugins/langchain-agent/plugin.py"
      to: "langgraph.prebuilt"
      via: "create_react_agent with recursion_limit config"
      pattern: "create_react_agent|recursion_limit"
---

<objective>
Enhance the LangChain agent with robust tool orchestration using LangGraph's recursion limits, add extended thinking for complex reasoning, and implement graceful tool error handling with retry logic.

Purpose: Transform the basic ReAct agent into a production-quality agentic loop with retry logic, iteration limits, and thoughtful error handling - using verified LangGraph and tenacity APIs.

Output: Enhanced `plugin.py` with recursion-limited agent, extended thinking for Anthropic, and try/except-based tool error handling with tenacity retries.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-agentic-loop/18-RESEARCH.md

# Current implementation to enhance
@plugins/langchain-agent/plugin.py
@plugins/langchain-agent/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recursion limit to prevent infinite agent loops</name>
  <files>plugins/langchain-agent/plugin.py</files>
  <action>
Keep `create_react_agent` from `langgraph.prebuilt` (already working) and add `recursion_limit` via config to prevent infinite loops.

1. No import changes needed - `create_react_agent` from `langgraph.prebuilt` is already imported and working.

2. Modify `_handle_message_async` method to pass recursion_limit config:
   - Change the agent invocation from:
     ```python
     response = await agent.ainvoke({"messages": messages})
     ```
   - To:
     ```python
     response = await agent.ainvoke(
         {"messages": messages},
         config={"recursion_limit": 10}
     )
     ```
   - This limits the agent to 10 iterations max, preventing infinite loops.

3. Keep the existing fallback logic for when MCP client is unavailable - this is good defensive coding.

Note: LangGraph's `recursion_limit` is passed via config dict, not as a constructor parameter. This is the documented way to limit agent iterations.
  </action>
  <verify>
Python syntax check: `python -m py_compile plugins/langchain-agent/plugin.py`
Check recursion_limit: `grep -n "recursion_limit" plugins/langchain-agent/plugin.py`
  </verify>
  <done>
Agent invocation uses `config={"recursion_limit": 10}` to prevent infinite loops
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable extended thinking for Anthropic model</name>
  <files>plugins/langchain-agent/plugin.py</files>
  <action>
Configure Anthropic's extended thinking capability for complex reasoning tasks.

1. Modify Anthropic model initialization in `on_activate`:
   - Change the `ChatAnthropic` initialization to include thinking parameter:
     ```python
     self.anthropic_model = ChatAnthropic(
         model="claude-sonnet-4-5-20250929",
         temperature=0.7,
         max_tokens=5000,  # Increased to accommodate thinking + response
         thinking={"type": "enabled", "budget_tokens": 2000},
     )
     ```
   - `budget_tokens=2000` caps the thinking tokens to prevent excessive usage
   - `max_tokens=5000` allows for both thinking (2000) and response (3000)

2. Update the Anthropic system prompt in `_handle_anthropic_message` to leverage thinking:
   - Change to: "You are a thoughtful AI assistant powered by Anthropic Claude. Think through complex problems carefully before responding. Be concise and helpful."

This enables Claude to show its reasoning process for complex queries while keeping responses focused.
  </action>
  <verify>
Python syntax check: `python -m py_compile plugins/langchain-agent/plugin.py`
Check thinking config: `grep -n "thinking" plugins/langchain-agent/plugin.py`
  </verify>
  <done>
Anthropic model initialized with `thinking={"type": "enabled", "budget_tokens": 2000}` and `max_tokens=5000`
  </done>
</task>

<task type="auto">
  <name>Task 3: Add graceful tool error handling with tenacity retry</name>
  <files>plugins/langchain-agent/plugin.py, plugins/langchain-agent/requirements.txt</files>
  <action>
Implement tool error handling using try/except and tenacity for retry logic.

1. Add imports at top of plugin.py:
   - Add: `from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type`

2. Add tenacity to requirements.txt:
   - Add line: `tenacity>=8.0.0`

3. Create a helper method in the class for invoking tools with retry:
   ```python
   async def _invoke_agent_with_retry(self, agent, messages: list) -> dict:
       """Invoke agent with retry logic for transient failures."""
       @retry(
           stop=stop_after_attempt(3),
           wait=wait_exponential(multiplier=1, min=1, max=10),
           retry=retry_if_exception_type((ConnectionError, TimeoutError)),
           reraise=True
       )
       async def _invoke():
           return await agent.ainvoke(
               {"messages": messages},
               config={"recursion_limit": 10}
           )
       
       try:
           return await _invoke()
       except (ConnectionError, TimeoutError) as e:
           # All retries exhausted - return error message
           raise RuntimeError(f"Tool connection failed after retries: {e}")
       except Exception as e:
           # Non-retryable error - pass through
           raise
   ```

4. Update `_handle_message_async` to use the retry helper:
   - Replace the direct `agent.ainvoke()` call with:
     ```python
     response = await self._invoke_agent_with_retry(agent, messages)
     ```

5. Wrap the entire tool invocation in try/except for graceful degradation:
   ```python
   try:
       response = await self._invoke_agent_with_retry(agent, messages)
       last_message = response["messages"][-1]
       self._send_response(post.channel_id, last_message.content, root_id)
       return
   except RuntimeError as e:
       self.logger.warning(f"Agent failed after retries: {e}")
       # Fall back to basic model (no tools)
   except Exception as e:
       self.logger.warning(f"Agent error, falling back: {e}")
   ```

This provides:
- Automatic retry (up to 3 attempts) for transient network errors
- Exponential backoff between retries
- Graceful fallback to tool-less model if all retries fail
  </action>
  <verify>
Python syntax check: `python -m py_compile plugins/langchain-agent/plugin.py`
Check retry decorator: `grep -n "@retry\|tenacity" plugins/langchain-agent/plugin.py`
Check requirements: `grep "tenacity" plugins/langchain-agent/requirements.txt`
  </verify>
  <done>
Tool invocation uses `tenacity` @retry decorator with 3 attempts, exponential backoff, and graceful fallback to tool-less model on failure
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax validation:**
   ```bash
   python -m py_compile plugins/langchain-agent/plugin.py
   ```

2. **Import validation:**
   ```bash
   cd plugins/langchain-agent && python -c "
   from langgraph.prebuilt import create_react_agent
   from langchain_anthropic import ChatAnthropic
   from tenacity import retry, stop_after_attempt, wait_exponential
   print('All imports resolve correctly')
   "
   ```

3. **Code inspection:**
   - `create_react_agent` used with `config={"recursion_limit": 10}` for iteration limits
   - Anthropic model has `thinking` parameter configured
   - `@retry` decorator from tenacity used for tool error handling
   - Graceful fallback to tool-less model on repeated failures
</verification>

<success_criteria>
- [ ] `plugin.py` compiles without syntax errors
- [ ] All imports resolve correctly (langgraph, langchain-anthropic, tenacity)
- [ ] Agent invocation uses `config={"recursion_limit": 10}` to prevent infinite loops
- [ ] Anthropic model has extended thinking enabled (budget_tokens=2000)
- [ ] `@retry` decorator from tenacity handles transient tool failures (3 attempts, exponential backoff)
- [ ] Graceful fallback to tool-less model when all retries exhausted
- [ ] Existing functionality preserved (OpenAI bot, conversation history, fallback logic)
</success_criteria>

<output>
After completion, create `.planning/phases/18-agentic-loop/18-01-SUMMARY.md`
</output>
