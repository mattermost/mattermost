---
phase: 02-api-protobuf-definitions
plan: 04
type: execute
depends_on: ["02-01"]
files_modified:
  - server/public/pluginapi/grpc/proto/api_file_bot.proto
  - server/public/pluginapi/grpc/proto/bootstrap.proto
  - server/public/pluginapi/grpc/proto/plugin.proto
---

<objective>
Define protobuf request/response messages for File + Bot + Upload Plugin API methods, including streaming-safe representations for `io.Reader`-based APIs.

Purpose: Enable Python plugins to interact with files/uploads and manage bots with parity to the Go Plugin API.
Output: Fully-specified messages in `api_file_bot.proto` (+ any required shared/common types).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-protocol-foundation/01-RESEARCH.md

# Source of truth: signatures + semantics
@server/public/plugin/api.go

# Proto skeleton + generation tooling
@server/public/pluginapi/grpc/proto/api.proto
@server/public/pluginapi/grpc/proto/api_file_bot.proto
@server/public/pluginapi/grpc/proto/bootstrap.proto
@server/public/Makefile

# Model sources of truth for this plan
@server/public/model/file_info.go
@server/public/model/bot.go
@server/public/model/upload_session.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement File + Bot + Upload method messages (non-streaming)</name>
  <files>server/public/pluginapi/grpc/proto/api_file_bot.proto, server/public/pluginapi/grpc/proto/plugin.proto</files>
  <action>
Replace placeholders in `api_file_bot.proto` for methods assigned to this group covering:
- File fetch/link/info/list operations
- Bot CRUD/patch/active/delete operations
- Upload session creation/get operations (excluding the `io.Reader` streaming upload itself)

Maintain Phase 2 conventions:
- `AppError error = 1;` in every response
- snake_case fields
- shared `plugin.proto` messages for `model.FileInfo`, `model.Bot`, `model.BotPatch`, `model.BotGetOptions`, `model.UploadSession`, `model.Manifest` (if referenced), etc.

If a type is too large/churn-heavy (e.g., `model.Manifest`), consider a wrapper message in `plugin.proto` (`Struct`/`json` field) rather than mapping every field immediately—document the choice.
  </action>
  <verify>make -C server/public proto-gen succeeds AND no TODO placeholders remain for non-streaming methods in `api_file_bot.proto`</verify>
  <done>All file/bot/upload (non-streaming) methods are fully defined and codegen succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Implement streaming-safe RPC patterns for io.Reader methods (UploadData, InstallPlugin)</name>
  <files>server/public/pluginapi/grpc/proto/api_file_bot.proto, server/public/pluginapi/grpc/proto/bootstrap.proto, server/public/pluginapi/grpc/proto/plugin.proto</files>
  <action>
Handle `io.Reader`-based methods in a way that won’t explode gRPC message limits:

- `UploadData(us *model.UploadSession, rd io.Reader) (*model.FileInfo, error)`
- `InstallPlugin(file io.Reader, replace bool) (*model.Manifest, *model.AppError)`

Preferred approach:
- Define these RPCs as **client-streaming** (`rpc UploadData(stream UploadDataRequest) returns (UploadDataResponse);`).
- The streamed request message should support:
  - An initial “header” frame (upload session id / replace flag / metadata)
  - Repeated binary chunks (`bytes chunk = N;`) for the body
  - A stable way to distinguish header vs chunk (e.g., `oneof payload { UploadDataHeader header = 1; bytes chunk = 2; }`)

Rules:
- Keep `AppError error = 1;` in the response payload (even if Go returns `error`), for parity and uniformity.
- Avoid a unary `bytes data = 1` field for these methods (will break for large plugins/files).
- Keep chunk size guidance in comments (e.g., 64KiB–256KiB) but do not hardcode it into proto.
  </action>
  <verify>go run ./server/public/pluginapi/grpc/cmd/apiverify reports parity AND make -C server/public proto-gen succeeds</verify>
  <done>`UploadData` and `InstallPlugin` have streaming-capable proto definitions, and all placeholders for these methods are removed.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `go run ./server/public/pluginapi/grpc/cmd/apiverify` reports no missing/extra RPCs
- [ ] `make -C server/public proto-gen` succeeds
- [ ] No placeholder TODOs remain for methods assigned to `api_file_bot.proto`
</verification>

<success_criteria>

- File/Bot/Upload protobuf messages are fully defined (no placeholders)
- io.Reader methods are represented using streaming-safe RPCs
- Go proto generation succeeds without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/02-api-protobuf-definitions/02-04-SUMMARY.md`:

# Phase 2 Plan 04: File and Bot API Protos Summary

**Implemented file/bot/upload protobuf messages including client-streaming definitions for io.Reader APIs.**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Ready for `02-05-PLAN.md` (after remaining plans complete)
</output>


