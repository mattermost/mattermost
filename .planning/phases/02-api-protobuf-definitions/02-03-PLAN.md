---
phase: 02-api-protobuf-definitions
plan: 03
type: execute
depends_on: ["02-01"]
files_modified:
  - server/public/pluginapi/grpc/proto/api_kv_config.proto
  - server/public/pluginapi/grpc/proto/bootstrap.proto
  - server/public/pluginapi/grpc/proto/plugin.proto
---

<objective>
Define protobuf request/response messages for KV Store + Configuration Plugin API methods, including the “dynamic payload” methods (plugin config, websocket events, logging).

Purpose: Enable Python plugins to read/write KV, read config, and interact with server-side logging/events while preserving Mattermost’s AppError semantics.
Output: Fully-specified messages in `api_kv_config.proto` (+ any required shared/common types in `plugin.proto` / `bootstrap.proto`).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-protocol-foundation/01-RESEARCH.md

# Source of truth: signatures + semantics
@server/public/plugin/api.go

# Proto skeleton + generation tooling
@server/public/pluginapi/grpc/proto/api.proto
@server/public/pluginapi/grpc/proto/api_kv_config.proto
@server/public/pluginapi/grpc/proto/bootstrap.proto
@server/public/Makefile

# Model sources of truth for this plan
@server/public/model/config.go
@server/public/model/websocket_message.go
@server/public/model/plugin_key_value.go
@server/public/model/plugin_kvset_options.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement KV Store + Configuration method messages</name>
  <files>server/public/pluginapi/grpc/proto/api_kv_config.proto, server/public/pluginapi/grpc/proto/plugin.proto</files>
  <action>
Replace placeholders in `api_kv_config.proto` for methods assigned to this group that cover:
- KV store (get/set/delete/list + any option variants like `KVSetWithOptions`)
- Configuration access (`GetConfig`, `GetUnsanitizedConfig`, `SaveConfig`, etc.)
- Plugin enable/disable/status and other `@tag Plugin` non-streaming methods assigned to this group

Type strategy (be explicit and consistent):
- Keep the Phase 2 response convention: `AppError error = 1;` always present in responses.
- For very large / frequently changing structs (notably `model.Config`), prefer a wrapper message in `plugin.proto` that carries **structured data** without mapping thousands of fields up front (e.g., `message Config { google.protobuf.Struct data = 1; }` or `bytes json = 1;`).
  - This preserves parity while avoiding constant proto churn as config evolves.
  - If you choose `google.protobuf.Struct`, import `google/protobuf/struct.proto` and use it consistently across dynamic payloads.
  </action>
  <verify>make -C server/public proto-gen succeeds AND no TODO placeholders remain for KV/Configuration methods in `api_kv_config.proto`</verify>
  <done>KV/Configuration methods are fully defined, chosen Config representation is consistent, and Go codegen succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Implement dynamic payload methods (plugin config, websocket events, logging)</name>
  <files>server/public/pluginapi/grpc/proto/api_kv_config.proto, server/public/pluginapi/grpc/proto/bootstrap.proto, server/public/pluginapi/grpc/proto/plugin.proto</files>
  <action>
Implement the “non-proto-friendly signature” methods in a parity-preserving way (replace placeholders in `api_kv_config.proto`):

- `LoadPluginConfiguration(dest any) error`
  - Define `LoadPluginConfigurationRequest` (likely empty or includes plugin id if required later).
  - Define response with `AppError error = 1` and a structured config payload field (prefer `google.protobuf.Struct config = 2` or `bytes config_json = 2`).

- `GetPluginConfig() map[string]any` / `SavePluginConfig(map[string]any)`
  - Use a structured payload type (`google.protobuf.Struct`) to preserve nested objects.

- `PublishWebSocketEvent(event string, payload map[string]any, broadcast *model.WebsocketBroadcast)`
  - Represent `payload` as `google.protobuf.Struct` (or an equivalent shared dynamic type).
  - Ensure `WebsocketBroadcast` is a shared message in `plugin.proto`.

- `LogDebug/LogInfo/LogWarn/LogError(msg string, keyValuePairs ...any)`
  - Map `msg` directly.
  - Represent keyValuePairs as either:
    - `google.protobuf.Struct fields = N` (simplest), OR
    - `repeated LogField fields = N` with a well-defined scalar/structured oneof (more work, better parity).
  - Do NOT reduce everything to “stringified args”; preserve structure where possible.

Rules:
- Keep `AppError error = 1` in responses (even for methods that are “void” in Go).
- Use gRPC status only for transport/system failures; application errors must be in the response payload.
- Add any shared helper messages (e.g., `LogField`) to `bootstrap.proto` if they’re reused across multiple API groups.
  </action>
  <verify>go run ./server/public/pluginapi/grpc/cmd/apiverify reports parity AND make -C server/public proto-gen succeeds</verify>
  <done>Dynamic-payload methods compile, preserve structure (Struct/LogField), and all placeholders for these methods are removed.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `go run ./server/public/pluginapi/grpc/cmd/apiverify` reports no missing/extra RPCs
- [ ] `make -C server/public proto-gen` succeeds
- [ ] No placeholder TODOs remain for methods assigned to `api_kv_config.proto`
</verification>

<success_criteria>

- KV/Config/Plugin/Logging messages are fully specified
- Dynamic payload methods use a consistent representation (Struct vs JSON) documented in the summary
- Go proto generation succeeds without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/02-api-protobuf-definitions/02-03-SUMMARY.md`:

# Phase 2 Plan 03: KV Store and Configuration API Protos Summary

**Implemented KV/config/logging/websocket-event protobuf messages with parity-safe AppError payloads and a consistent dynamic payload representation.**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Ready for `02-05-PLAN.md` (after remaining plans complete)
</output>


