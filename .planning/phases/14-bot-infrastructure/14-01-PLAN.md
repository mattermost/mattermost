---
phase: 14-bot-infrastructure
plan: 01
type: execute
depends_on: []
files_modified:
  - plugins/langchain-agent/plugin.json
  - plugins/langchain-agent/plugin.py
  - plugins/langchain-agent/requirements.txt
  - plugins/langchain-agent/Makefile
domain: python-plugin
---

<objective>
Create the LangChain Agent plugin with two AI bots (OpenAI and Anthropic) and DM message routing.

Purpose: Establish the bot infrastructure that Phase 15-18 will build upon for LangChain integration, session memory, MCP client, and agentic loop.
Output: Working Python plugin that creates two bots on activation and routes DM messages to the appropriate handler.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work reference
@examples/hello_python/plugin.py - Example plugin showing hook patterns
@examples/hello_python/plugin.json - Example manifest format
@python-sdk/src/mattermost_plugin/_internal/mixins/bots.py - Bot API (ensure_bot_user)
@python-sdk/src/mattermost_plugin/hooks.py - Available hooks (MessageHasBeenPosted)

# Key SDK types
- Bot: username, display_name, description
- Channel: type field ("D" for DM), id
- Post: channel_id, user_id, message
- ChannelType.DIRECT = "D"

**Tech stack available:**
- Python Plugin SDK with typed API client
- Bot APIs: ensure_bot_user(), get_bot()
- Channel APIs: get_channel()
- Post APIs: create_post()
- Hooks: OnActivate, OnDeactivate, MessageHasBeenPosted

**Established patterns:**
- @hook decorator for hook registration
- self.api for API client access
- self.logger for logging
- Bot usernames should be plugin-scoped (e.g., "langchain-openai-agent")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin structure with manifest</name>
  <files>plugins/langchain-agent/plugin.json, plugins/langchain-agent/requirements.txt, plugins/langchain-agent/Makefile</files>
  <action>
Create the plugin directory structure:

1. Create `plugins/langchain-agent/plugin.json` manifest:
   - id: "com.mattermost.langchain-agent"
   - name: "LangChain Agent"
   - description: "AI agent plugin demonstrating LangChain integration with OpenAI and Anthropic"
   - version: "0.1.0"
   - min_server_version: "10.0.0"
   - server.executable: "plugin.py"
   - server.runtime: "python"
   - server.python_version: ">=3.9"

2. Create `plugins/langchain-agent/requirements.txt`:
   - mattermost-plugin (will be vendored from python-sdk)
   - (Leave placeholder comment for future LangChain dependencies)

3. Create `plugins/langchain-agent/Makefile`:
   - Copy pattern from examples/hello_python/Makefile
   - Targets: venv, lint, dist, dist-minimal, clean
   - SDK should be copied from ../../python-sdk/

Do NOT add LangChain dependencies yet - that's Phase 15.
  </action>
  <verify>ls plugins/langchain-agent/ shows plugin.json, requirements.txt, Makefile</verify>
  <done>Plugin directory structure exists with valid manifest</done>
</task>

<task type="auto">
  <name>Task 2: Create plugin class with bot creation on activation</name>
  <files>plugins/langchain-agent/plugin.py</files>
  <action>
Create the main plugin file with:

1. Import from mattermost_plugin: Plugin, hook, HookName, Bot, Post, ChannelType

2. Define constants at module level:
   - OPENAI_BOT_USERNAME = "langchain-openai-agent"
   - ANTHROPIC_BOT_USERNAME = "langchain-anthropic-agent"

3. Create LangChainAgentPlugin(Plugin) class with:
   - Instance attributes to store bot user IDs (set in OnActivate)
   - self.openai_bot_id: str | None = None
   - self.anthropic_bot_id: str | None = None

4. Implement @hook(HookName.OnActivate) method:
   - Create OpenAI bot using self.api.ensure_bot_user(Bot(...)):
     - username: OPENAI_BOT_USERNAME
     - display_name: "OpenAI Agent"
     - description: "LangChain-powered AI agent using OpenAI"
   - Create Anthropic bot similarly:
     - username: ANTHROPIC_BOT_USERNAME
     - display_name: "Anthropic Agent"
     - description: "LangChain-powered AI agent using Anthropic Claude"
   - Store returned bot_user_ids in instance attributes
   - Log bot creation with self.logger.info()
   - Wrap in try/except to handle errors gracefully

5. Implement @hook(HookName.OnDeactivate):
   - Log deactivation
   - (Bots persist across plugin restarts, no cleanup needed)

6. Add if __name__ == "__main__" entry point:
   - from mattermost_plugin.server import run_plugin
   - run_plugin(LangChainAgentPlugin)

Use type hints throughout. Handle exceptions with logging - don't crash on bot creation failure.
  </action>
  <verify>python -c "import sys; sys.path.insert(0, 'plugins/langchain-agent'); from plugin import LangChainAgentPlugin" succeeds</verify>
  <done>Plugin class exists with OnActivate creating two bots and storing their IDs</done>
</task>

<task type="auto">
  <name>Task 3: Implement DM message routing</name>
  <files>plugins/langchain-agent/plugin.py</files>
  <action>
Add MessageHasBeenPosted hook to route DMs to bots:

1. Implement @hook(HookName.MessageHasBeenPosted) method:
   - Signature: def on_message_posted(self, context, post) -> None
   - Note: post is already a Post object from the SDK

2. Early exit checks (in order):
   - If openai_bot_id or anthropic_bot_id is None, return (bots not created)
   - If post.user_id equals either bot ID, return (don't respond to own messages)

3. Get channel and check if it's a DM:
   - channel = self.api.get_channel(post.channel_id)
   - If channel.type != ChannelType.DIRECT ("D"), return (not a DM)

4. Determine which bot the DM is to:
   - For DMs, the channel name is a combination of two user IDs (sorted alphabetically)
   - Use self.api.get_direct_channel(user_id_1, user_id_2) pattern to check
   - OR check if the bot is a member of this DM channel using get_channel_member

   Simpler approach: Check if the channel contains either bot:
   - Try: self.api.get_channel_member(post.channel_id, self.openai_bot_id)
     - If succeeds and post.user_id != openai_bot_id: route to OpenAI
   - Try: self.api.get_channel_member(post.channel_id, self.anthropic_bot_id)
     - If succeeds and post.user_id != anthropic_bot_id: route to Anthropic
   - Catch NotFoundError for non-members (expected)

5. Create routing stub methods:
   - def _handle_openai_message(self, post: Post) -> None:
     - For now: Log the message and create a placeholder response
     - self.api.create_post(Post(id="", channel_id=post.channel_id, message="[OpenAI Agent] Received: " + post.message[:50]))
   - def _handle_anthropic_message(self, post: Post) -> None:
     - Similar placeholder response

6. Call appropriate handler based on which bot is in the channel

Log all routing decisions at debug level for troubleshooting.

IMPORTANT: Import NotFoundError from mattermost_plugin.exceptions for catching channel member lookup failures.
  </action>
  <verify>grep -q "MessageHasBeenPosted" plugins/langchain-agent/plugin.py && grep -q "_handle_openai_message" plugins/langchain-agent/plugin.py</verify>
  <done>DM messages to bots are detected and routed to appropriate handler stubs</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Plugin directory exists at plugins/langchain-agent/
- [ ] plugin.json is valid JSON with correct structure
- [ ] plugin.py imports successfully (no syntax errors)
- [ ] Plugin class has OnActivate, OnDeactivate, MessageHasBeenPosted hooks
- [ ] Bot creation uses ensure_bot_user with proper Bot objects
- [ ] DM routing logic checks channel type and bot membership
- [ ] Handler stubs exist for OpenAI and Anthropic message processing
</verification>

<success_criteria>

- All tasks completed
- Plugin structure matches hello_python pattern
- Two bots created on activation (OpenAI, Anthropic)
- DM messages routed to correct handler based on which bot is in the channel
- Placeholder responses posted (proves end-to-end flow works)
- Code uses type hints and proper error handling
</success_criteria>

<output>
After completion, create `.planning/phases/14-bot-infrastructure/14-01-SUMMARY.md`:

# Phase 14-01: Bot Infrastructure Summary

**[One-liner describing what was built]**

## Accomplishments

- Created LangChain Agent plugin structure
- Implemented bot creation on activation (OpenAI and Anthropic bots)
- Added DM message routing based on bot membership
- Placeholder responses for testing end-to-end flow

## Files Created/Modified

- `plugins/langchain-agent/plugin.json` - Plugin manifest
- `plugins/langchain-agent/plugin.py` - Main plugin implementation
- `plugins/langchain-agent/requirements.txt` - Dependencies
- `plugins/langchain-agent/Makefile` - Build tooling

## Decisions Made

[Any implementation decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Bot infrastructure ready for LangChain integration (Phase 15)
- Handler stubs ready to be replaced with actual LLM calls
- Message routing proven working
</output>
