## Objective

Create the **Go-side gRPC server scaffolding** for the Plugin API, including:

- A compilable `PluginAPI` gRPC server implementation that wraps the existing Go `plugin.API` interface
- Standardized **error mapping** (Mattermost `*model.AppError` → `grpc/status` codes)
- A small **in-process test harness** (bufconn) proving the wiring works before implementing the full API surface

This plan intentionally aims for “thin but correct” scaffolding so subsequent plans can implement method groups incrementally.

## Execution Context

- **Project state**: `.planning/STATE.md`
- **Roadmap**: `.planning/ROADMAP.md` (Phase 4 depends on Phase 2 + 3)
- **Architecture decision inputs**:
  - `.planning/phases/01-protocol-foundation/01-RESEARCH.md` (recommended folder layout + error handling)
  - `.planning/phases/06-python-sdk-core/06-RESEARCH.md` (Python SDK expects proto path under `server/public/pluginapi/grpc/proto`)
- **Relevant codebase entrypoints** (host-side plugin system):
  - `server/public/plugin/api.go` — authoritative Plugin API interface (200+ methods, tags like `@tag User`)
  - `server/channels/app/plugin_api.go` — concrete server implementation (`type PluginAPI struct { ... }`)
  - `server/public/plugin/environment.go` — plugin environment, creates per-plugin API via `apiImplCreatorFunc`
  - `server/public/plugin/supervisor.go` — current supervisor (hashicorp/go-plugin + net/rpc)
  - `server/public/plugin/client.go` — explicitly states “gRPC is not supported” for Go plugins (must remain unchanged)
- **Testing/mocks**:
  - `server/public/plugin/.mockery.yaml` + `server/Makefile` target `plugin-mocks` — generates `plugintest` mocks for `plugin.API`

## Context

### What Phase 4 Builds (and What It Does NOT)

- **Builds**: a Go gRPC server that implements the generated protobuf `PluginAPI` service and forwards calls to a `plugin.API` implementation (e.g., `app.PluginAPI`).
- **Does NOT**: change existing Go plugin transport (`net/rpc`) or `plugin.ClientMain`. Python plugins are additive.

### Prerequisites / Dependencies (Hard Gates)

Phase 4 assumes Phase 2 and Phase 3 have produced:

- `server/public/pluginapi/grpc/proto/plugin.proto`
- `server/public/pluginapi/grpc/proto/api.proto`
- Generated Go code (paths from Phase 1 research):
  - `server/public/pluginapi/grpc/generated/go/*.pb.go`
  - `server/public/pluginapi/grpc/generated/go/*_grpc.pb.go`

If these do not exist yet, **stop** and complete Phase 1/2/3 first.

### Error Handling Standard

Follow Phase 1 research “Pattern 5”:

- **All gRPC methods return errors using `status` + `codes`** (not “error fields” in responses).
- Convert Mattermost `*model.AppError` primarily using `StatusCode` (HTTP-ish) → gRPC `codes.Code` via an explicit mapping helper.

Recommended mapping (documented in code, unit tested):

- 400 → `InvalidArgument`
- 401 → `Unauthenticated`
- 403 → `PermissionDenied`
- 404 → `NotFound`
- 409 → `AlreadyExists`
- 413 → `ResourceExhausted` (payload too large)
- 429 → `ResourceExhausted`
- 501 → `Unimplemented`
- 503 → `Unavailable`
- default/500 → `Internal`

### Server Packaging / Location

Use the directory structure from `.planning/phases/01-protocol-foundation/01-RESEARCH.md`:

`server/public/pluginapi/grpc/server/` contains the Go server wrapper code.

## Tasks

### Task 1: Validate prerequisites (proto + generated Go)

- Confirm `server/public/pluginapi/grpc/proto/{plugin.proto,api.proto}` exist.
- Confirm generated Go packages exist under `server/public/pluginapi/grpc/generated/go/` and compile.
- If missing: record the missing artifacts and stop execution of this plan (return to Phase 2/3).

### Task 2: Add gRPC API server skeleton

Create `server/public/pluginapi/grpc/server/api_server.go`:

- Define `type APIServer struct` with:
  - `pb.UnimplementedPluginAPIServer` embedded (so we can implement incrementally)
  - `impl plugin.API`
- Provide constructors/helpers:
  - `func NewAPIServer(impl plugin.API) *APIServer`
  - `func Register(grpcServer *grpc.Server, impl plugin.API)` (thin helper)
- Add minimal “smoke” RPC implementations (choose ones with minimal model conversion, e.g. `GetServerVersion`, `IsEnterpriseReady`, or similar *if they exist in api.proto*).

Notes:

- Do **not** add any network listeners here; keep it as a pure `grpc.Server` registration unit. Listener lifecycle belongs to Phase 5 supervisor integration.
- Keep imports pinned to `server/public` module paths (this code lives under `server/public/...`).

### Task 3: Implement shared error conversion helpers

Create `server/public/pluginapi/grpc/server/errors.go`:

- `func appErrorToStatus(appErr *model.AppError) error`
- `func errorToStatus(err error) error` (fallback, uses `codes.Internal` unless a known type is detected)
- Keep mapping logic centralized so later plans don’t re-implement it per method.

### Task 4: Add bufconn test harness + smoke tests

Create `server/public/pluginapi/grpc/server/api_server_test.go` using `google.golang.org/grpc/test/bufconn`:

- Spin up a `grpc.Server` in-memory
- Register `APIServer` with a **mock** `plugin.API` (from `server/public/plugin/plugintest`)
- Call the smoke RPC(s) and assert:
  - Correct response values
  - Correct `grpc` error code mapping for an injected `*model.AppError`

If the existing `plugintest` mocks are missing/out-of-date, run from `server/`:

- `make plugin-mocks`

### Task 5: Document “how subsequent plans extend this”

In code comments (not a new doc), add a short note in `api_server.go`:

- “This server intentionally embeds `UnimplementedPluginAPIServer` to allow incremental implementation by plan 04-02..04-04.”

## Verification

- **Unit tests** (from repo root):
  - `cd server/public && go test ./...` (or narrower: `cd server/public && go test ./pluginapi/grpc/server -v`)
- **Build sanity**:
  - `cd server/public && go test ./...` should compile the generated pb packages + server wrapper.

## Success Criteria

- `server/public/pluginapi/grpc/server` compiles and tests pass.
- At least one RPC is wired end-to-end through bufconn using a mock `plugin.API`.
- `*model.AppError` is consistently mapped to `grpc/status` codes via shared helpers.

## Output

- **New files**:
  - `server/public/pluginapi/grpc/server/api_server.go`
  - `server/public/pluginapi/grpc/server/errors.go`
  - `server/public/pluginapi/grpc/server/api_server_test.go`


