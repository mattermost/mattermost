## Objective

Implement the **Post / File / KV Store** subset of the gRPC `PluginAPI` service by forwarding protobuf RPCs to the existing Go `plugin.API` interface.

This plan continues the incremental buildout started in 04-02, keeping the server wrapper thin, tested, and aligned with Mattermost plugin parity.

## Execution Context

- `.planning/STATE.md`, `.planning/ROADMAP.md`
- `.planning/phases/01-protocol-foundation/01-RESEARCH.md` (gRPC error/status conventions)
- Must already exist:
  - Generated pb code: `server/public/pluginapi/grpc/generated/go/`
  - 04-01 scaffolding: `server/public/pluginapi/grpc/server/*`
  - 04-02 pattern established for implementing + testing method groups
- Authoritative interface + tagging:
  - `server/public/plugin/api.go`
- Testing utilities:
  - `server/public/plugin/plugintest` mocks

## Context

### Scope Definition

Use tag-based grouping from `server/public/plugin/api.go`:

- `@tag Post`
- `@tag File`
- `@tag KV Store` (and/or `@tag KVStore` depending on existing tags)

Confirm the exact tag strings in `api.go` and align your checklist accordingly.

### Performance / Payload Considerations

File APIs can involve large payloads. Even before Phase 8 (ServeHTTP streaming), ensure:

- gRPC max message sizes are considered (likely configured in the Python client per Phase 6 research; server-side may also need configuration when integrated in Phase 5).
- Methods that return file bytes should match whatever Phase 2 decided:
  - `bytes` fields (with size limits) vs
  - chunking/streaming (if Phase 2 already introduced streaming messages)

If streaming is not in Phase 2/3 for file content, keep 04-03 unary and document size caveats.

## Tasks

### Task 1: Produce an explicit method checklist for Post/File/KV

- Generate a checklist of Post/File/KV methods from `server/public/plugin/api.go` using the same approach as 04-02.
- Cross-check against `api.proto` RPC names and message shapes.
- If mismatches exist, stop and fix Phase 2 proto definitions (don’t paper over with ad-hoc wrappers).

### Task 2: Implement conversions for Post/File/KV related types

Add conversion helpers (new files as needed):

- `convert_post.go` (e.g., `Post`, `PostList`, `PostPatch`, `Reaction`, etc.)
- `convert_file.go` (e.g., `FileInfo`, `FileUploadSession`, etc.)
- `convert_kv.go` (KV types; likely scalar/bytes + metadata)

Guidelines:

- Prefer clear, explicit conversion code over clever reflection.
- For “map[string]any” values in KV/config-related calls, follow the protobuf design from Phase 2 (often `google.protobuf.Struct` or `google.protobuf.Any`).

### Task 3: Implement Post API RPC handlers

- Implement all Post-tagged RPCs in the server wrapper.
- Add unit tests for at least:
  - `CreatePost` success path
  - A “read” method (e.g., `GetPost`)
  - One permission/error mapping case

### Task 4: Implement File API RPC handlers

- Implement all File-tagged RPCs.
- Add unit tests for at least:
  - A metadata-oriented method (e.g., `GetFileInfo`)
  - One method that returns file bytes (if designed as unary)
  - One error mapping case for size limits or not-found

### Task 5: Implement KV Store API RPC handlers

- Implement all KV-tagged RPCs.
- Add unit tests for at least:
  - Put/Get (roundtrip)
  - “not found” behavior mapping to `codes.NotFound` (if Phase 2 chose that)

### Task 6: Keep files manageable

If needed, split server files by domain (mirroring 04-02):

- `api_post.go`, `api_file.go`, `api_kv.go`

## Verification

- `cd server/public && go test ./pluginapi/grpc/server -v`
- Ensure newly implemented RPCs don’t regress 04-01/04-02 tests.

## Success Criteria

- All Post/File/KV RPCs from the checklist are implemented.
- Each domain has at least one success + one failure test.
- Any decisions about file payload handling match Phase 2’s proto design (no silent divergence).

## Output

- **Modified**:
  - `server/public/pluginapi/grpc/server/api_server.go` (and/or split domain files)
  - `server/public/pluginapi/grpc/server/*_test.go`
- **New (likely)**:
  - `server/public/pluginapi/grpc/server/convert_post.go`
  - `server/public/pluginapi/grpc/server/convert_file.go`
  - `server/public/pluginapi/grpc/server/convert_kv.go`


