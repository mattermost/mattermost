## Phase 1 — Protocol Foundation
## Plan 01-02: Core protobuf types (User, Channel, Post, Team, …)

### Objective

Define the **core protobuf message types** shared across all future Plugin API methods (Phase 2) and hooks (Phase 3). These types must preserve Mattermost semantics closely enough to achieve eventual **full parity** with Go plugins.

### Execution Context

- **Project state / roadmap / research**
  - `@.planning/STATE.md`
  - `@.planning/ROADMAP.md`
  - `@.planning/PROJECT.md`
  - `@.planning/phases/01-protocol-foundation/01-RESEARCH.md`
- **Inputs (current Go surfaces to mirror)**
  - `@server/public/plugin/api.go` (API method signatures reference core model types)
  - `@server/public/plugin/hooks.go` (hook payload types)
- **Canonical Go types**
  - `@server/public/model/user.go`
  - `@server/public/model/channel.go`
  - `@server/public/model/post.go`
  - `@server/public/model/team.go`
  - `@server/public/model/file_info.go` (or equivalent file defining `FileInfo`)
  - `@server/public/model/utils.go` (notably `StringInterface`)
- **Prerequisite plan**
  - `@.planning/phases/01-protocol-foundation/01-01-PLAN.md` (must be completed first)

### Context / Constraints

- **Parity > elegance**: Prefer faithful representation of existing `model.*` types over “idealized” new schemas.
- **Timestamps**: Mattermost uses **milliseconds since epoch** (`int64`). Keep that convention in proto fields (also `int64`).
- **IDs**: Most IDs are opaque strings (26-char base32-ish). Keep as `string`.
- **Avoid monolithic protos**: Split by entity to keep compilation and reviews manageable.
- **Avoid field number reuse**: Once a field number ships, never reuse it. Use `reserved` when removing/renaming.

### Mandatory Discovery (Levels 1–3)

- [ ] **L1 — Confirm 01-01 output is in place**
  - `make proto-gen` exists and works with the bootstrap proto.
- [ ] **L2 — Enumerate type dependencies from real surfaces**
  - Extract referenced `model.*` types from:
    - `server/public/plugin/api.go`
    - `server/public/plugin/hooks.go`
  - Produce a deduped list (this becomes the source of truth for “core types”).

```bash
# Example (run from repo root)
rg -n --no-heading "model\\.[A-Za-z0-9_]+" server/public/plugin/{api.go,hooks.go} \
  | sed -E 's/.*(model\\.[A-Za-z0-9_]+).*/\\1/' \
  | sort -u
```

- [ ] **L2 — Identify “dynamic JSON” fields**
  - Find any fields typed as `model.StringInterface`, `map[string]any`, or `any`-like content (common in `Post.Props`).
  - Decide representation (recommendation: `google.protobuf.Struct`).
- [ ] **L3 — Choose the Phase 1 core subset**
  - Minimum recommended set (enough to unblock most API + hook protos):
    - `User`, `Channel`, `Post`, `Team`, `FileInfo`
    - `Bot` (commonly referenced)
    - `CommandArgs`, `CommandResponse` (common integration surface)
  - Everything else can be added incrementally in Phase 2/3 as needed, but Phase 1 should avoid leaving the “big 4” undefined.

### Tasks

- [ ] **Finalize proto package naming + file layout**
  - [ ] Use a versioned proto package (recommendation): `mattermost.pluginapi.v1`
  - [ ] Keep `.proto` sources under: `server/public/pluginapi/grpc/proto/`
  - [ ] Keep Go output under: `server/public/pluginapi/grpc/generated/go/`
  - [ ] Prefer one file per domain:
    - `common.proto`
    - `user.proto`
    - `channel.proto`
    - `post.proto`
    - `team.proto`
    - `file.proto`
    - (optional in Phase 1) `command.proto`, `bot.proto`

- [ ] **Define shared “common” building blocks**
  - [ ] Update/replace `bootstrap.proto` into `common.proto` (or keep bootstrap and add common; prefer common).
  - [ ] Add:
    - `Empty` (or use `google.protobuf.Empty` if you decide to import it later)
    - Any shared enums you need immediately (keep enums minimal in Phase 1)
    - A standard approach for “dynamic JSON” (recommended: `google.protobuf.Struct`)

- [ ] **Define core entity messages**
  - [ ] For each core Go model type, map fields with these rules:
    - **Keep field names in `snake_case`**
    - **Preserve ms timestamps** (`*_at` → `int64`)
    - **Use `repeated` for slices**
    - **Use `map<...>` for `map[string]string`**
    - **Use `google.protobuf.Struct` for `model.StringInterface` / arbitrary JSON**
  - [ ] Start with the minimum field set required by plugin API/hook usage, but prefer mirroring the full struct when it’s not overly complex.

**Minimum target list (Phase 1):**
- `User` (include `password` field for create/update flows, but document that it must not be populated in API responses)
- `Channel`
- `Post` (expect to need `props` as `Struct`)
- `Team`
- `FileInfo`

**Strongly suggested add-ons (if referenced by signatures):**
- `Bot`
- `CommandArgs`, `CommandResponse`

- [ ] **Prevent import cycles**
  - [ ] Treat proto dependencies as a DAG:
    - `common.proto` imports only google well-known types
    - entity protos import `common.proto` and/or other entity protos only when unavoidable
  - [ ] If you hit an import cycle, extract the shared type into `common.proto` (or a new smaller shared proto).

- [ ] **Generate + compile**
  - [ ] Run generation:

```bash
cd server
make proto-gen
```

  - [ ] Compile-check public module:

```bash
cd server
make test-public
```

### Verification

- **Proto compile**: `make proto-gen` succeeds without warnings about import cycles.
- **Go compile**: `make test-public` succeeds.
- **Sanity checks**
  - Generated Go package imports cleanly (no missing go_package paths).
  - No message has “obviously wrong” scalar types (e.g., timestamps accidentally `string`).

### Success Criteria

- Core types exist in `.proto` form and generate Go code successfully.
- Types are ready to be referenced by upcoming `api.proto` (Phase 2) and `hooks.proto` (Phase 3).
- The schema is split sensibly (not one huge proto file) and is evolution-friendly (field numbering discipline).

### Output

- **New/updated proto files** in `server/public/pluginapi/grpc/proto/`:
  - `common.proto`
  - `user.proto`
  - `channel.proto`
  - `post.proto`
  - `team.proto`
  - `file.proto`
  - (optional) `bot.proto`, `command.proto`
- **Regenerated Go code** in `server/public/pluginapi/grpc/generated/go/`


