## Phase 1 — Protocol Foundation
## Plan 01-01: gRPC dependency setup + protobuf build configuration

### Objective

Establish the **protobuf/gRPC “plumbing”** needed for cross-language plugins:
- A stable directory layout for proto sources + generated artifacts.
- A repeatable `make` target that generates Go code from `.proto` files.
- A minimal bootstrap `.proto` that proves generation + compilation work end-to-end.

### Execution Context

- **Project state / roadmap**
  - `@.planning/STATE.md`
  - `@.planning/ROADMAP.md`
  - `@.planning/PROJECT.md`
  - `@.planning/phases/01-protocol-foundation/01-RESEARCH.md`
- **Build + module topology**
  - `@server/go.work` (this repo uses a multi-module workspace)
  - `@server/Makefile` (includes `public/Makefile`)
  - `@server/public/Makefile`
  - `@server/public/go.mod`
- **Existing plugin system (for discovery only; do not modify in this plan)**
  - `@server/public/plugin/api.go`
  - `@server/public/plugin/hooks.go`
  - `@server/public/plugin/client_rpc.go`
  - `@server/public/plugin/supervisor.go`

### Context / Constraints

- **Backward compatibility**: Go plugins must continue working unchanged. The gRPC/protobuf layer is additive.
- **Repo structure**: Most “public” plugin-facing types live in the `server/public` Go module.
- **No extra docs**: Do not add new standalone Markdown docs (beyond this plan file). Prefer code comments.

### Mandatory Discovery (Levels 0–2)

- [ ] **L0 — Confirm scope**: This plan only sets up proto + codegen plumbing (no API methods/services yet).
- [ ] **L1 — Confirm module boundaries**:
  - Verify `server/go.work` includes `./public` and that `server/public` is its own Go module.
- [ ] **L1 — Confirm current state**:
  - Verify there are currently **no** `.proto` files in the repo.
  - Verify `server/Makefile` includes `public/Makefile` (so new targets in `server/public/Makefile` are available from `server/`).
- [ ] **L2 — Confirm toolchain versions present**:
  - `google.golang.org/grpc` and `google.golang.org/protobuf` are already in `go.mod` (likely indirect). Note their versions for pinning codegen tools.
  - Identify existing codegen patterns (e.g., `make pluginapi`, `make store-layers`) to match style.

### Tasks

- [ ] **Create directory skeleton (proto sources + generated Go)**
  - [ ] Create `server/public/pluginapi/grpc/proto/`
  - [ ] Create `server/public/pluginapi/grpc/generated/go/`

- [ ] **Add a minimal bootstrap proto (to validate the pipeline)**
  - [ ] Create `server/public/pluginapi/grpc/proto/bootstrap.proto` with:
    - `syntax = "proto3";`
    - A stable proto package name (recommendation: `mattermost.pluginapi.v1`)
    - A Go package option targeting the generated directory (example below; confirm exact path)
    - At least one trivial message (e.g., `Empty`)

```protobuf
syntax = "proto3";

package mattermost.pluginapi.v1;

// NOTE: This is a bootstrap file for validating protoc + Go generation.
// It will be expanded/updated by later Phase 1 plans.
option go_package = "github.com/mattermost/mattermost/server/public/pluginapi/grpc/generated/go;pluginapiv1";

message Empty {}
```

- [ ] **Add protobuf code generation targets**
  - [ ] Update `server/public/Makefile` to add targets (available from `server/` because it is included):
    - `proto-tools`: installs pinned versions of:
      - `protoc-gen-go` (pin to the protobuf module version already used in `server/public/go.mod`)
      - `protoc-gen-go-grpc` (pin to the grpc module version already used in `server/public/go.mod`)
    - `proto-gen`: runs `protoc` over `server/public/pluginapi/grpc/proto/*.proto` and writes output into `server/public/pluginapi/grpc/generated/go`
  - [ ] Ensure the Make target fails fast with a clear message if `protoc` is missing.

```bash
# Example usage (run from server/ directory)
make proto-gen
```

- [ ] **Keep generated code buildable**
  - [ ] Run the public module tests to ensure the generated package compiles (no need for new tests yet).

### Verification

- **From `server/`**

```bash
make proto-gen
make test-public
```

- **Optional (more direct)**

```bash
cd server/public && go test ./...
```

### Success Criteria

- `make proto-gen` exists and is repeatable.
- A minimal `.proto` compiles and produces Go output in `server/public/pluginapi/grpc/generated/go/`.
- `make test-public` (or `go test ./...` in `server/public`) passes after generation.

### Output

- **New directories**
  - `server/public/pluginapi/grpc/proto/`
  - `server/public/pluginapi/grpc/generated/go/`
- **New files**
  - `server/public/pluginapi/grpc/proto/bootstrap.proto`
- **Updated files**
  - `server/public/Makefile` (new `proto-tools` + `proto-gen` targets)


