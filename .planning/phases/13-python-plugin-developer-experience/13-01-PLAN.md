---
phase: 13-python-plugin-developer-experience
plan: 01
type: execute
depends_on: []
files_modified: [server/public/pluginapi/grpc/ARCHITECTURE.md]
---

<objective>
Create comprehensive architecture documentation for the Python plugin gRPC system.

Purpose: Enable internal Mattermost engineers to understand, debug, and extend the Python plugin infrastructure.
Output: `server/public/pluginapi/grpc/ARCHITECTURE.md` documenting the entire gRPC plugin system.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files to document:**
@server/public/plugin/python_supervisor.go
@server/public/plugin/hooks_grpc_client.go
@server/public/plugin/environment.go
@server/public/pluginapi/grpc/server/api_server.go
@server/public/pluginapi/grpc/server/serve_http.go
@python-sdk/src/mattermost_plugin/server.py
@python-sdk/src/mattermost_plugin/plugin.py
@python-sdk/src/mattermost_plugin/hooks.py
@python-sdk/src/mattermost_plugin/client.py

**Proto definitions:**
@server/public/pluginapi/grpc/proto/api.proto
@server/public/pluginapi/grpc/proto/hooks.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create architecture documentation</name>
  <files>server/public/pluginapi/grpc/ARCHITECTURE.md</files>
  <action>
Create comprehensive architecture documentation covering:

## Document Structure

1. **Overview Section**
   - Purpose: Explain gRPC-based multi-language plugin support
   - Key value proposition: Full API parity between Go and Python plugins
   - High-level architecture diagram (ASCII art showing: Mattermost Server → gRPC → Python Plugin)

2. **Component Layers**
   - Protocol Layer: Proto definitions (api.proto, hooks.proto, types)
   - Go Infrastructure:
     - Python Supervisor (`python_supervisor.go`): Process spawning, go-plugin handshake
     - Hooks gRPC Client (`hooks_grpc_client.go`): Hook dispatch to Python
     - API Server (`server/api_server.go`): gRPC server Python calls back to
     - ServeHTTP streaming (`server/serve_http.go`): Bidirectional HTTP streaming
   - Python SDK:
     - Plugin base class (`plugin.py`): `Plugin` class with `__init_subclass__`
     - Hook system (`hooks.py`): `@hook` decorator, `HookName` enum
     - API Client (`client.py`): Typed API client with mixins
     - gRPC Server (`server.py`): Plugin-side gRPC server for hooks

3. **Process Lifecycle**
   - Plugin loading: Manifest parsing, runtime detection
   - Python process spawning: Command construction, env vars
   - gRPC handshake: go-plugin protocol, health checking
   - API server startup: `MATTERMOST_PLUGIN_API_TARGET` env var
   - Shutdown: Graceful termination, API server cleanup

4. **Communication Flow**
   - Hook dispatch: Go server → gRPC → Python hook handler → response
   - API calls: Python plugin → gRPC → Go API server → response
   - ServeHTTP: Bidirectional streaming for HTTP requests/responses

5. **Key Design Decisions**
   - Response-embedded AppError (not gRPC status codes)
   - 64KB chunks for streaming
   - JSON blobs for complex types (Config, License, Manifest)
   - APIServerRegistrar pattern for import cycle breaking

6. **File Reference Table**
   - Table mapping functionality to file locations (Go and Python)

Format: Use markdown with clear headers, code blocks for paths, and ASCII diagrams where helpful.
  </action>
  <verify>File exists at server/public/pluginapi/grpc/ARCHITECTURE.md with all sections</verify>
  <done>Architecture document created with: Overview, Component Layers, Process Lifecycle, Communication Flow, Design Decisions, File Reference</done>
</task>

<task type="auto">
  <name>Task 2: Add architecture diagram</name>
  <files>server/public/pluginapi/grpc/ARCHITECTURE.md</files>
  <action>
Add detailed ASCII architecture diagram to the Overview section showing:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Mattermost Server                                  │
│                                                                              │
│  ┌──────────────┐    ┌─────────────────┐    ┌────────────────────────────┐  │
│  │   App Layer  │───▶│  Plugin Env     │───▶│   Python Supervisor        │  │
│  │              │    │  (environment.go)│    │   (python_supervisor.go)   │  │
│  └──────────────┘    └─────────────────┘    └────────────────────────────┘  │
│                             │                           │                    │
│                             ▼                           ▼                    │
│                      ┌─────────────────┐    ┌────────────────────────────┐  │
│                      │ hooksGRPCClient │    │   PluginAPI gRPC Server    │  │
│                      │ (hook dispatch) │    │   (api_server.go)          │  │
│                      └────────┬────────┘    └────────────┬───────────────┘  │
│                               │                          │                   │
└───────────────────────────────┼──────────────────────────┼───────────────────┘
                                │ gRPC                     │ gRPC
                   Hooks call   │                          │  API calls
                                ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Python Plugin Process                                │
│                                                                              │
│  ┌────────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │  PluginHooks       │    │   Plugin Class  │    │   API Client        │   │
│  │  gRPC Server       │◀───│   (user code)   │───▶│   (calls Go API)    │   │
│  │  (server.py)       │    │   (plugin.py)   │    │   (client.py)       │   │
│  └────────────────────┘    └─────────────────┘    └─────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

Also add a sequence diagram for hook invocation and API call flow.
  </action>
  <verify>grep -q "┌─" server/public/pluginapi/grpc/ARCHITECTURE.md</verify>
  <done>ASCII architecture diagram and sequence diagrams added to document</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `server/public/pluginapi/grpc/ARCHITECTURE.md` exists
- [ ] Document has Overview, Component Layers, Process Lifecycle, Communication Flow sections
- [ ] ASCII diagrams present for system architecture
- [ ] File reference table maps all key files
</verification>

<success_criteria>

- Architecture documentation created
- All major components documented with file locations
- Diagrams show data flow clearly
- Document is useful for onboarding new engineers
</success_criteria>

<output>
After completion, create `.planning/phases/13-python-plugin-developer-experience/13-01-SUMMARY.md`
</output>
