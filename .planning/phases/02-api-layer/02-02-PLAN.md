---
phase: 02-api-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - server/channels/api4/scheduled_recap.go
  - server/channels/api4/api.go
  - server/channels/web/params.go
  - server/channels/web/context.go
  - server/public/model/audit_events.go
autonomous: true

must_haves:
  truths:
    - "POST /api/v4/scheduled_recaps creates a scheduled recap"
    - "GET /api/v4/scheduled_recaps lists user's scheduled recaps"
    - "GET /api/v4/scheduled_recaps/{id} gets a specific scheduled recap"
    - "PUT /api/v4/scheduled_recaps/{id} updates a scheduled recap"
    - "DELETE /api/v4/scheduled_recaps/{id} deletes a scheduled recap"
    - "POST /api/v4/scheduled_recaps/{id}/pause pauses a scheduled recap"
    - "POST /api/v4/scheduled_recaps/{id}/resume resumes a scheduled recap"
    - "API returns 403 when user accesses another user's recap"
    - "API validates required fields and returns 400 for invalid input"
  artifacts:
    - path: "server/channels/api4/scheduled_recap.go"
      provides: "API handlers for scheduled recap endpoints"
      exports: ["InitScheduledRecap", "createScheduledRecap", "getScheduledRecap", "getScheduledRecaps", "updateScheduledRecap", "deleteScheduledRecap", "pauseScheduledRecap", "resumeScheduledRecap"]
      min_lines: 200
    - path: "server/channels/api4/api.go"
      provides: "Route registration for ScheduledRecaps"
      contains: "ScheduledRecaps"
    - path: "server/channels/web/params.go"
      provides: "ScheduledRecapId parameter parsing"
      contains: "ScheduledRecapId"
    - path: "server/channels/web/context.go"
      provides: "RequireScheduledRecapId validation"
      contains: "RequireScheduledRecapId"
    - path: "server/public/model/audit_events.go"
      provides: "Audit event constants for scheduled recaps"
      contains: "AuditEventCreateScheduledRecap"
  key_links:
    - from: "server/channels/api4/scheduled_recap.go"
      to: "server/channels/app/scheduled_recap.go"
      via: "c.App.CreateScheduledRecap"
      pattern: "c\\.App\\.(Create|Get|Update|Delete|Pause|Resume)ScheduledRecap"
    - from: "server/channels/api4/api.go"
      to: "server/channels/api4/scheduled_recap.go"
      via: "api.InitScheduledRecap()"
      pattern: "InitScheduledRecap"
---

<objective>
Create API handlers and routes for ScheduledRecap CRUD and state management endpoints.

Purpose: Expose the App layer methods via RESTful API endpoints with proper authentication, authorization, validation, and audit logging following Mattermost's API patterns.

Output: Complete API layer for scheduled recaps with all endpoints registered and functional.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-layer/02-01-SUMMARY.md

# Reference existing API patterns
@server/channels/api4/recap.go
@server/channels/api4/api.go

# Params and context patterns
@server/channels/web/params.go
@server/channels/web/context.go

# Audit events pattern
@server/public/model/audit_events.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit event constants for scheduled recaps</name>
  <files>server/public/model/audit_events.go</files>
  <action>
Add a new "Scheduled Recaps" section after the "Recaps" section in `audit_events.go`:

```go
// Scheduled Recaps
const (
    AuditEventCreateScheduledRecap = "createScheduledRecap" // create scheduled recap configuration
    AuditEventGetScheduledRecap    = "getScheduledRecap"    // view a single scheduled recap
    AuditEventGetScheduledRecaps   = "getScheduledRecaps"   // list user's scheduled recaps
    AuditEventUpdateScheduledRecap = "updateScheduledRecap" // update scheduled recap configuration
    AuditEventDeleteScheduledRecap = "deleteScheduledRecap" // delete scheduled recap
    AuditEventPauseScheduledRecap  = "pauseScheduledRecap"  // pause scheduled recap execution
    AuditEventResumeScheduledRecap = "resumeScheduledRecap" // resume paused scheduled recap
)
```

Place this after line 286 (after the Recaps section).
  </action>
  <verify>
```bash
grep -A 10 "Scheduled Recaps" server/public/model/audit_events.go
```
  </verify>
  <done>
Audit event constants for scheduled recap operations exist in audit_events.go
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ScheduledRecapId to params and context</name>
  <files>server/channels/web/params.go, server/channels/web/context.go</files>
  <action>
**In params.go:**

1. Add field to Params struct (after RecapId on line 58):
```go
ScheduledRecapId string
```

2. Add parsing in ParamsFromRequest function (after line 173 where RecapId is parsed):
```go
params.ScheduledRecapId = props["scheduled_recap_id"]
```

**In context.go:**

Add RequireScheduledRecapId function after RequireRecapId (after line 780):
```go
func (c *Context) RequireScheduledRecapId() *Context {
    if c.Err != nil {
        return c
    }

    if !model.IsValidId(c.Params.ScheduledRecapId) {
        c.SetInvalidURLParam("scheduled_recap_id")
    }
    return c
}
```
  </action>
  <verify>
```bash
# Verify params
grep "ScheduledRecapId" server/channels/web/params.go

# Verify context method
grep "RequireScheduledRecapId" server/channels/web/context.go
```
  </verify>
  <done>
ScheduledRecapId field exists in Params struct, is parsed from URL, and RequireScheduledRecapId validation method exists.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add route registration in api.go</name>
  <files>server/channels/api4/api.go</files>
  <action>
**In the Routes struct** (around line 104 after Recaps):
```go
ScheduledRecaps *mux.Router // 'api/v4/scheduled_recaps'
ScheduledRecap  *mux.Router // 'api/v4/scheduled_recaps/{scheduled_recap_id:[A-Za-z0-9]+}'
```

**In the Init function** (around line 261 after the Recaps route setup):
```go
api.BaseRoutes.ScheduledRecaps = api.BaseRoutes.APIRoot.PathPrefix("/scheduled_recaps").Subrouter()
api.BaseRoutes.ScheduledRecap = api.BaseRoutes.ScheduledRecaps.PathPrefix("/{scheduled_recap_id:[A-Za-z0-9]+}").Subrouter()
```

**In the Init function** (around line 343 after api.InitRecap()):
```go
api.InitScheduledRecap()
```
  </action>
  <verify>
```bash
# Verify route fields
grep "ScheduledRecaps" server/channels/api4/api.go

# Verify Init call
grep "InitScheduledRecap" server/channels/api4/api.go
```
  </verify>
  <done>
ScheduledRecaps and ScheduledRecap routes are defined in Routes struct, initialized in Init(), and InitScheduledRecap() is called.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create API handler file</name>
  <files>server/channels/api4/scheduled_recap.go</files>
  <action>
Create `server/channels/api4/scheduled_recap.go` following the patterns in `recap.go`.

```go
// Copyright (c) 2015-present Mattermost, Inc. All Rights Reserved.
// See LICENSE.txt for license information.

package api4

import (
    "encoding/json"
    "net/http"

    "github.com/mattermost/mattermost/server/public/model"
    "github.com/mattermost/mattermost/server/public/shared/mlog"
    "github.com/mattermost/mattermost/server/v8/channels/app"
)

func (api *API) InitScheduledRecap() {
    api.BaseRoutes.ScheduledRecaps.Handle("", api.APISessionRequired(createScheduledRecap)).Methods(http.MethodPost)
    api.BaseRoutes.ScheduledRecaps.Handle("", api.APISessionRequired(getScheduledRecaps)).Methods(http.MethodGet)
    api.BaseRoutes.ScheduledRecap.Handle("", api.APISessionRequired(getScheduledRecap)).Methods(http.MethodGet)
    api.BaseRoutes.ScheduledRecap.Handle("", api.APISessionRequired(updateScheduledRecap)).Methods(http.MethodPut)
    api.BaseRoutes.ScheduledRecap.Handle("", api.APISessionRequired(deleteScheduledRecap)).Methods(http.MethodDelete)
    api.BaseRoutes.ScheduledRecap.Handle("/pause", api.APISessionRequired(pauseScheduledRecap)).Methods(http.MethodPost)
    api.BaseRoutes.ScheduledRecap.Handle("/resume", api.APISessionRequired(resumeScheduledRecap)).Methods(http.MethodPost)
}
```

**Implement each handler following recap.go patterns:**

**createScheduledRecap:**
1. Check feature flag: `requireRecapsEnabled(c)` (reuse from recap.go)
2. Decode JSON body into `*model.ScheduledRecap`
3. Validate required fields: Title, DaysOfWeek, TimeOfDay, Timezone, TimePeriod, ChannelMode, AgentId
4. Setup audit record: `c.MakeAuditRecord(model.AuditEventCreateScheduledRecap, model.AuditStatusFail)`
5. Call `c.App.CreateScheduledRecap(c.AppContext, recap)`
6. Mark audit success and return 201 with JSON body

**getScheduledRecap:**
1. Feature flag check
2. `c.RequireScheduledRecapId()` - validate URL param
3. Setup audit record
4. Call `c.App.GetScheduledRecap(c.AppContext, c.Params.ScheduledRecapId)`
5. **Authorization check**: `if recap.UserId != c.AppContext.Session().UserId` return 403
6. Mark audit success and return JSON

**getScheduledRecaps:**
1. Feature flag check
2. Setup audit record (log page/per_page params)
3. Call `c.App.GetScheduledRecapsForUser(c.AppContext, c.Params.Page, c.Params.PerPage)`
4. Mark audit success and return JSON array

**updateScheduledRecap:**
1. Feature flag check
2. `c.RequireScheduledRecapId()`
3. Decode JSON body
4. Ensure recap.Id matches URL param (or set it)
5. **Fetch existing to check ownership**: `c.App.GetScheduledRecap(...)` -> check UserId
6. Setup audit record with prior state
7. Call `c.App.UpdateScheduledRecap(c.AppContext, recap)`
8. Mark audit success and return JSON

**deleteScheduledRecap:**
1. Feature flag check
2. `c.RequireScheduledRecapId()`
3. **Fetch existing to check ownership** -> return 403 if not owner
4. Setup audit record with prior state
5. Call `c.App.DeleteScheduledRecap(c.AppContext, c.Params.ScheduledRecapId)`
6. Mark audit success and return `ReturnStatusOK(w)`

**pauseScheduledRecap:**
1. Feature flag check
2. `c.RequireScheduledRecapId()`
3. **Fetch existing to check ownership**
4. Setup audit record with prior state
5. Call `c.App.PauseScheduledRecap(c.AppContext, c.Params.ScheduledRecapId)`
6. Mark audit success and return JSON

**resumeScheduledRecap:**
1. Feature flag check
2. `c.RequireScheduledRecapId()`
3. **Fetch existing to check ownership**
4. Setup audit record with prior state
5. Call `c.App.ResumeScheduledRecap(c.AppContext, c.Params.ScheduledRecapId)`
6. Mark audit success and return JSON

**Error IDs:** Use `api.scheduled_recap.permission_denied` for 403 errors.
**Audit object type:** Add `auditRec.AddEventObjectType("scheduled_recap")` after creating audit record.
  </action>
  <verify>
```bash
# Verify file compiles
cd server && go build ./channels/api4/...

# Verify handlers exist
grep -c "func.*ScheduledRecap" server/channels/api4/scheduled_recap.go

# Verify Init function
grep "InitScheduledRecap" server/channels/api4/scheduled_recap.go
```
  </verify>
  <done>
All 7 API handlers exist, compile successfully, and include authorization checks and audit logging.
  </done>
</task>

</tasks>

<verification>
```bash
# Full build verification
cd server && go build ./...

# Count handlers
grep -c "func.*ScheduledRecap" server/channels/api4/scheduled_recap.go

# Verify routes
grep "scheduled_recaps" server/channels/api4/api.go

# Verify audit events
grep "ScheduledRecap" server/public/model/audit_events.go
```
</verification>

<success_criteria>
1. All 7 API endpoints are registered and handlers exist
2. Authorization checks verify UserId matches session for all operations except create/list
3. Audit logging is implemented for all operations
4. Feature flag check (requireRecapsEnabled) is called in all handlers
5. Server compiles and builds successfully
6. Validation returns 400 for missing required fields
7. Permission denied returns 403 with appropriate error message
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-layer/02-02-SUMMARY.md`
</output>
