---
name: E2E Tests - Approve via Comment

on:
  issue_comment:
    types: [created]

jobs:
  approve-e2e:
    # Only run on PR comments (not issue comments) and only for /e2e-test-verified command
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == '/e2e-test-verified'
    runs-on: ubuntu-24.04
    steps:
      - name: Check user permission
        id: check-permission
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          # Check if user has write access to the repo
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${COMMENT_AUTHOR}/permission --jq '.permission')
          if [[ "$PERMISSION" != "admin" && "$PERMISSION" != "write" && "$PERMISSION" != "maintain" ]]; then
            echo "User ${COMMENT_AUTHOR} does not have write access (permission: ${PERMISSION})"
            exit 1
          fi
          echo "User ${COMMENT_AUTHOR} has ${PERMISSION} access"

      - name: Get PR head SHA
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER})
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Override failed full test statuses
        id: override
        env:
          GH_TOKEN: ${{ github.token }}
          COMMIT_SHA: ${{ steps.pr-info.outputs.head_sha }}
        run: |
          # Only full tests can be overridden (smoke tests must pass)
          FULL_TEST_CONTEXTS=("E2E Tests/playwright-full" "E2E Tests/cypress-full")
          OVERRIDDEN=""

          for CONTEXT_NAME in "${FULL_TEST_CONTEXTS[@]}"; do
            echo "Checking: $CONTEXT_NAME"

            # Get current status
            STATUS_JSON=$(gh api repos/${{ github.repository }}/commits/${COMMIT_SHA}/statuses \
              --jq "[.[] | select(.context == \"$CONTEXT_NAME\")] | first // empty")

            if [ -z "$STATUS_JSON" ]; then
              echo "  No status found, skipping"
              continue
            fi

            CURRENT_DESC=$(echo "$STATUS_JSON" | jq -r '.description // ""')
            CURRENT_URL=$(echo "$STATUS_JSON" | jq -r '.target_url // ""')
            CURRENT_STATE=$(echo "$STATUS_JSON" | jq -r '.state // ""')

            echo "  Current: $CURRENT_DESC ($CURRENT_STATE)"

            # Only override if status is failure
            if [ "$CURRENT_STATE" != "failure" ]; then
              echo "  Not failed, skipping"
              continue
            fi

            # Parse and construct new message
            if [[ "$CURRENT_DESC" =~ ^([0-9]+)\ failed,\ ([0-9]+)\ passed$ ]]; then
              FAILED="${BASH_REMATCH[1]}"
              PASSED="${BASH_REMATCH[2]}"
              NEW_MSG="${FAILED} failed (verified), ${PASSED} passed"
            elif [[ "$CURRENT_DESC" =~ ^([0-9]+)\ failed\ \([^)]+\),\ ([0-9]+)\ passed$ ]]; then
              FAILED="${BASH_REMATCH[1]}"
              PASSED="${BASH_REMATCH[2]}"
              NEW_MSG="${FAILED} failed (verified), ${PASSED} passed"
            else
              NEW_MSG="${CURRENT_DESC} (verified)"
            fi

            echo "  New: $NEW_MSG"

            # Update status via GitHub API
            gh api repos/${{ github.repository }}/statuses/${COMMIT_SHA} \
              -f state=success \
              -f context="$CONTEXT_NAME" \
              -f description="$NEW_MSG" \
              -f target_url="$CURRENT_URL"

            echo "  Updated to success"
            OVERRIDDEN="${OVERRIDDEN}- ${CONTEXT_NAME}\n"
          done

          echo "overridden<<EOF" >> $GITHUB_OUTPUT
          echo -e "$OVERRIDDEN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add reaction to comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='+1'

      - name: Reply to comment
        env:
          GH_TOKEN: ${{ github.token }}
          OVERRIDDEN: ${{ steps.override.outputs.overridden }}
          ACTOR: ${{ github.event.comment.user.login }}
        run: |
          if [ -n "$OVERRIDDEN" ]; then
            BODY="E2E test verified by @${ACTOR}:
          - Status: success
          - Overridden:
          ${OVERRIDDEN}"
          else
            BODY="No failed full tests to override."
          fi
          gh pr comment ${{ github.event.issue.number }} --body "$BODY"
