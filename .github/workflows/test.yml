name: Tests

on:
  push:
    tags:
      - 'v*-custom.*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

# Auto-discovery test system: Go tests are discovered via '// mattermost-extended-test'
# marker comments. Webapp tests run from the centralized tests/mattermost_extended/ folder.
# To add a new test: add the marker to Go files, or place webapp tests in that folder.

jobs:
  # Quick unit tests that don't need Docker
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'server/go.mod'
          cache-dependency-path: |
            server/go.sum
            server/public/go.sum

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.11.0

      - name: Setup workspace
        working-directory: ./server
        run: make setup-go-work

      - name: Create results directory
        run: mkdir -p test-results

      - name: Discover and run marked tests
        id: run-tests
        continue-on-error: true
        working-directory: ./server
        run: |
          # Find all marked test files in server/public/model/
          FILES=$(grep -rl '// mattermost-extended-test' ./public/model/ --include '*_test.go' || true)
          if [ -z "$FILES" ]; then
            echo "No marked test files found in ./public/model/"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract all Test* function names
          PATTERN=$(grep -ohE 'func (Test[A-Za-z0-9_]+)' $FILES | sed 's/func //' | sort -u | paste -sd '|')
          echo "Discovered test pattern: $PATTERN"
          echo "From files: $FILES"

          gotestsum --format testname --junitfile ../test-results/unit-tests.xml -- -v \
            -run "$PATTERN" \
            ./public/model/... \
            -timeout 10m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## Unit Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-tests.outputs.skip }}" = "true" ]; then
            echo "No marked test files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for file in test-results/*.xml; do
            if [ -f "$file" ]; then
              NAME=$(basename "$file" .xml)
              TESTS=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")

              if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
                echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **$NAME**: $FAILURES failures, $ERRORS errors out of $TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>View failures</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A 10 '<failure' "$file" | head -100 >> $GITHUB_STEP_SUMMARY || true
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "::error::Unit tests failed"
            exit 1
          fi

  # Webapp Jest tests - auto-discovered from centralized folder
  webapp-tests:
    name: Webapp Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webapp/package-lock.json

      - name: Install dependencies
        working-directory: ./webapp
        run: npm ci

      - name: Create results directory
        run: mkdir -p test-results

      - name: Run all Mattermost Extended webapp tests
        id: webapp-tests
        continue-on-error: true
        working-directory: ./webapp/channels
        run: |
          set -o pipefail
          npm test -- --ci --coverage=false \
            --testPathPatterns="tests/mattermost_extended/.*\\.test\\.(ts|tsx)$" \
            2>&1 | tee ../../test-results/webapp-tests.log
          cp build/test-results.xml ../../test-results/webapp-tests.xml 2>/dev/null || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: webapp-test-results
          path: test-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## Webapp Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for logfile in test-results/*.log; do
            if [ -f "$logfile" ]; then
              NAME=$(basename "$logfile" .log)

              if grep -q "was replaced by" "$logfile"; then
                ERROR_MSG=$(grep "was replaced by" "$logfile" | head -1)
                echo "- **$NAME**: Jest CLI error - $ERROR_MSG" >> $GITHUB_STEP_SUMMARY
              elif grep -q "PASS\|FAIL" "$logfile"; then
                SUMMARY=$(grep -E "Tests:.*[0-9]+ (passed|failed)" "$logfile" | tail -1 || echo "")
                if [ -n "$SUMMARY" ]; then
                  if echo "$SUMMARY" | grep -q "failed"; then
                    echo "- **$NAME**: $SUMMARY" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **$NAME**: $SUMMARY" >> $GITHUB_STEP_SUMMARY
                  fi
                else
                  PASS_COUNT=$(grep -c "^PASS" "$logfile" || echo "0")
                  FAIL_COUNT=$(grep -c "^FAIL" "$logfile" || echo "0")
                  if [ "$FAIL_COUNT" = "0" ] && [ "$PASS_COUNT" -gt "0" ]; then
                    echo "- **$NAME**: $PASS_COUNT test files passed" >> $GITHUB_STEP_SUMMARY
                  elif [ "$FAIL_COUNT" -gt "0" ]; then
                    echo "- **$NAME**: $FAIL_COUNT failed, $PASS_COUNT passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **$NAME**: Could not parse results" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              elif grep -q "npm error" "$logfile"; then
                echo "- **$NAME**: npm error (see logs)" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **$NAME**: Could not parse results" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.webapp-tests.outcome }}" = "failure" ]; then
            echo "::error::Webapp tests failed - see summary above for details"
            exit 1
          fi

  # Store layer tests with Docker services
  store-tests:
    name: Store Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mmuser
          POSTGRES_PASSWORD: mostest
          POSTGRES_DB: mattermost_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'server/go.mod'
          cache-dependency-path: |
            server/go.sum
            server/public/go.sum

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.11.0

      - name: Setup workspace
        working-directory: ./server
        run: make setup-go-work

      - name: Create results directory
        run: mkdir -p test-results

      - name: Discover and run marked store tests
        id: run-tests
        continue-on-error: true
        working-directory: ./server
        env:
          MM_SQLSETTINGS_DRIVERNAME: postgres
          MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mostest@localhost:5432/mattermost_test?sslmode=disable
        run: |
          FILES=$(grep -rl '// mattermost-extended-test' ./channels/store/sqlstore/ --include '*_test.go' || true)
          if [ -z "$FILES" ]; then
            echo "No marked test files found in ./channels/store/sqlstore/"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PATTERN=$(grep -ohE 'func (Test[A-Za-z0-9_]+)' $FILES | sed 's/func //' | sort -u | paste -sd '|')
          echo "Discovered test pattern: $PATTERN"
          echo "From files: $FILES"

          gotestsum --format testname --junitfile ../test-results/store-tests.xml -- -v \
            -run "$PATTERN" \
            ./channels/store/sqlstore/... \
            -timeout 15m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: store-test-results
          path: test-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## Store Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-tests.outputs.skip }}" = "true" ]; then
            echo "No marked test files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for file in test-results/*.xml; do
            if [ -f "$file" ]; then
              NAME=$(basename "$file" .xml)
              TESTS=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")

              if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
                echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **$NAME**: $FAILURES failures, $ERRORS errors out of $TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>View failures</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A 10 '<failure' "$file" | head -100 >> $GITHUB_STEP_SUMMARY || true
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "::error::Store tests failed - see summary above for details"
            exit 1
          fi

  # API tests with Docker services
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mmuser
          POSTGRES_PASSWORD: mostest
          POSTGRES_DB: mattermost_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'server/go.mod'
          cache-dependency-path: |
            server/go.sum
            server/public/go.sum

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.11.0

      - name: Setup workspace
        working-directory: ./server
        run: make setup-go-work

      - name: Create results directory
        run: mkdir -p test-results

      - name: Discover and run marked API tests
        id: run-tests
        continue-on-error: true
        working-directory: ./server
        env:
          MM_SQLSETTINGS_DRIVERNAME: postgres
          MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mostest@localhost:5432/mattermost_test?sslmode=disable
        run: |
          FILES=$(grep -rl '// mattermost-extended-test' ./channels/api4/ --include '*_test.go' || true)
          if [ -z "$FILES" ]; then
            echo "No marked test files found in ./channels/api4/"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PATTERN=$(grep -ohE 'func (Test[A-Za-z0-9_]+)' $FILES | sed 's/func //' | sort -u | paste -sd '|')
          echo "Discovered test pattern: $PATTERN"
          echo "From files: $FILES"

          gotestsum --format testname --junitfile ../test-results/api-tests.xml -- -v \
            -run "$PATTERN" \
            ./channels/api4/... \
            -timeout 15m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: test-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## API Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-tests.outputs.skip }}" = "true" ]; then
            echo "No marked test files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for file in test-results/*.xml; do
            if [ -f "$file" ]; then
              NAME=$(basename "$file" .xml)
              TESTS=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")

              if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
                echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **$NAME**: $FAILURES failures, $ERRORS errors out of $TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>View failures</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A 10 '<failure' "$file" | head -100 >> $GITHUB_STEP_SUMMARY || true
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "::error::API tests failed - see summary above for details"
            exit 1
          fi

  # Platform integration tests with Docker services
  platform-tests:
    name: Platform Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: mmuser
          POSTGRES_PASSWORD: mostest
          POSTGRES_DB: mattermost_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'server/go.mod'
          cache-dependency-path: |
            server/go.sum
            server/public/go.sum

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.11.0

      - name: Setup workspace
        working-directory: ./server
        run: make setup-go-work

      - name: Create results directory
        run: mkdir -p test-results

      - name: Discover and run marked platform tests
        id: run-tests
        continue-on-error: true
        working-directory: ./server
        env:
          MM_SQLSETTINGS_DRIVERNAME: postgres
          MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mostest@localhost:5432/mattermost_test?sslmode=disable
        run: |
          FILES=$(grep -rl '// mattermost-extended-test' ./channels/app/platform/ --include '*_test.go' || true)
          if [ -z "$FILES" ]; then
            echo "No marked test files found in ./channels/app/platform/"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PATTERN=$(grep -ohE 'func (Test[A-Za-z0-9_]+)' $FILES | sed 's/func //' | sort -u | paste -sd '|')
          echo "Discovered test pattern: $PATTERN"
          echo "From files: $FILES"

          gotestsum --format testname --junitfile ../test-results/platform-tests.xml -- -v \
            -run "$PATTERN" \
            ./channels/app/platform/... \
            -timeout 15m

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: platform-test-results
          path: test-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## Platform Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-tests.outputs.skip }}" = "true" ]; then
            echo "No marked test files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for file in test-results/*.xml; do
            if [ -f "$file" ]; then
              NAME=$(basename "$file" .xml)
              TESTS=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")

              if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
                echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **$NAME**: $FAILURES failures, $ERRORS errors out of $TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>View failures</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A 10 '<failure' "$file" | head -100 >> $GITHUB_STEP_SUMMARY || true
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "::error::Platform tests failed - see summary above for details"
            exit 1
          fi

  # Compile check (ensures tests compile without running them)
  compile-check:
    name: Compile Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'server/go.mod'
          cache-dependency-path: |
            server/go.sum
            server/public/go.sum

      - name: Setup workspace
        working-directory: ./server
        run: make setup-go-work

      - name: Compile Server
        working-directory: ./server
        run: |
          go build ./...

      - name: Compile Tests
        working-directory: ./server
        run: |
          # Compile test packages (build only, no output binary)
          go test -c -o /dev/null ./public/model/...
          go test -c -o /dev/null ./channels/app/platform/...
          go test -c -o /dev/null ./channels/store/sqlstore/...
          # Skip ./channels/app/... as it has multiple 'mocks' packages that conflict

  # Final summary job that aggregates all results
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, webapp-tests, store-tests, api-tests, platform-tests, compile-check]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          merge-multiple: false

      - name: Generate final summary
        run: |
          # Create plain-text report for easy copy-paste to AI
          REPORT_FILE="all-results/test-failures-report.txt"
          echo "============================================" > $REPORT_FILE
          echo "TEST FAILURES REPORT" >> $REPORT_FILE
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $REPORT_FILE
          echo "============================================" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each job's status
          [ "${{ needs.unit-tests.result }}" = "success" ] && U="Passed" || U="Failed"
          [ "${{ needs.webapp-tests.result }}" = "success" ] && W="Passed" || W="Failed"
          [ "${{ needs.store-tests.result }}" = "success" ] && S="Passed" || S="Failed"
          [ "${{ needs.api-tests.result }}" = "success" ] && A="Passed" || A="Failed"
          [ "${{ needs.platform-tests.result }}" = "success" ] && P="Passed" || P="Failed"
          [ "${{ needs.compile-check.result }}" = "success" ] && C="Passed" || C="Failed"

          echo "| Unit Tests | $U |" >> $GITHUB_STEP_SUMMARY
          echo "| Webapp Tests | $W |" >> $GITHUB_STEP_SUMMARY
          echo "| Store Tests | $S |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | $A |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform Tests | $P |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile Check | $C |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Write job status to plain-text report
          echo "JOB STATUS:" >> $REPORT_FILE
          echo "  Unit Tests:     ${{ needs.unit-tests.result }}" >> $REPORT_FILE
          echo "  Webapp Tests:   ${{ needs.webapp-tests.result }}" >> $REPORT_FILE
          echo "  Store Tests:    ${{ needs.store-tests.result }}" >> $REPORT_FILE
          echo "  API Tests:      ${{ needs.api-tests.result }}" >> $REPORT_FILE
          echo "  Platform Tests: ${{ needs.platform-tests.result }}" >> $REPORT_FILE
          echo "  Compile Check:  ${{ needs.compile-check.result }}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # Count total failures across all XML files
          TOTAL_TESTS=0
          TOTAL_FAILURES=0
          TOTAL_ERRORS=0

          echo "## Detailed Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for dir in all-results/*/; do
            if [ -d "$dir" ]; then
              JOB_NAME=$(basename "$dir" | sed 's/-test-results//')
              echo "### $JOB_NAME" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Process XML files (Go tests)
              for file in "$dir"*.xml; do
                if [ -f "$file" ]; then
                  NAME=$(basename "$file" .xml)
                  TESTS=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
                  FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")
                  ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*' || echo "0")

                  TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                  TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURES))
                  TOTAL_ERRORS=$((TOTAL_ERRORS + ERRORS))

                  if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
                    echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **$NAME**: $FAILURES failures, $ERRORS errors out of $TESTS tests" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done

              # Process log files (Jest/webapp tests)
              for file in "$dir"*.log; do
                if [ -f "$file" ]; then
                  NAME=$(basename "$file" .log)
                  SUMMARY_LINE=$(grep -E "^Tests:\s+[0-9]+" "$file" | tail -1 || echo "")
                  if [ -n "$SUMMARY_LINE" ]; then
                    TESTS=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+ total' | grep -oE '[0-9]+' || echo "0")
                    FAILURES=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' || echo "0")
                    PASSED=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+ passed' | grep -oE '[0-9]+' || echo "0")

                    TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                    TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURES))

                    if [ "$FAILURES" = "0" ] || [ -z "$FAILURES" ]; then
                      echo "- **$NAME**: $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "- **$NAME**: $FAILURES failed, $PASSED passed out of $TESTS total" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi
                fi
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: $TOTAL_TESTS tests, $TOTAL_FAILURES failures, $TOTAL_ERRORS errors**" >> $GITHUB_STEP_SUMMARY

          # Write totals to plain-text report
          echo "TOTALS: $TOTAL_TESTS tests, $TOTAL_FAILURES failures, $TOTAL_ERRORS errors" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # List all failures in detail
          if [ "$TOTAL_FAILURES" -gt 0 ] || [ "$TOTAL_ERRORS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## All Failures (for resolution)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "FAILED TESTS:" >> $REPORT_FILE
            echo "=============" >> $REPORT_FILE
            echo "" >> $REPORT_FILE

            for dir in all-results/*/; do
              for file in "$dir"*.xml; do
                if [ -f "$file" ]; then
                  FAILED_TESTS=$(awk '/<testcase/{name=""} /<testcase.*name="/{match($0,/name="([^"]*)"/,a); name=a[1]} /<failure/{if(name!="")print name; name=""}' "$file" 2>/dev/null || true)

                  if [ -z "$FAILED_TESTS" ]; then
                    FAILED_TESTS=$(grep -B5 '<failure' "$file" 2>/dev/null | grep -o 'name="[^"]*"' | sed 's/name="//;s/"//' || true)
                  fi

                  if [ -n "$FAILED_TESTS" ]; then
                    NAME=$(basename "$file" .xml)
                    echo "### $NAME" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    echo "$FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY

                    echo "--- $NAME ---" >> $REPORT_FILE
                    echo "$FAILED_TESTS" >> $REPORT_FILE
                    echo "" >> $REPORT_FILE

                    echo "<details><summary>Failure details</summary>" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    grep -B2 -A20 '<failure' "$file" | head -200 >> $GITHUB_STEP_SUMMARY || true
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    echo "</details>" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY

                    echo "Failure details for $NAME:" >> $REPORT_FILE
                    echo "----------------------------" >> $REPORT_FILE
                    grep -A30 '<failure' "$file" | sed 's/<[^>]*>//g' | head -100 >> $REPORT_FILE || true
                    echo "" >> $REPORT_FILE
                  fi
                fi
              done
            done

            echo "============================================" >> $REPORT_FILE
            echo "END OF REPORT" >> $REPORT_FILE
            echo "============================================" >> $REPORT_FILE
          else
            echo "All tests passed!" >> $REPORT_FILE
          fi

      - name: Upload failure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures-report
          path: all-results/test-failures-report.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Final status check
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.webapp-tests.result }}" != "success" ] || \
             [ "${{ needs.store-tests.result }}" != "success" ] || \
             [ "${{ needs.api-tests.result }}" != "success" ] || \
             [ "${{ needs.platform-tests.result }}" != "success" ] || \
             [ "${{ needs.compile-check.result }}" != "success" ]; then
            echo "::error::Some tests failed - see summary for details"
            exit 1
          fi
          echo "All tests passed!"
