# .github/workflows/dispatch-build.yml
name: Build & Push New Golang Docker Build Server Image

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Git branch or PR ref to build"
        required: true
      tag:
        description: "Docker image tag (e.g. v1.2.3 or latest)"
        required: true

env:
  CHAINCTL_IDENTITY: ee399b4c72dd4e58e3d617f78fc47b74733c9557/922f2d48307d6f5f

# Permissions required for chainguard-dev/setup-chainctl
permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    env:
      IMAGE_TAG: ${{ github.event.inputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Set up QEMU (optional, for multi-arch)
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Login to DockerHub (development repo)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_DEV_USERNAME }}
          password: ${{ secrets.DOCKERHUB_DEV_TOKEN }}

      - name: Build & push development image
        run: |
          docker buildx build \
            --tag mattermostdevelopment/mattermost-build-server:"${IMAGE_TAG}" \
            --push \
            -f server/build/Dockerfile.buildenv .

      - name: Login to DockerHub (production repo)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push production image
        run: |
          docker buildx build \
            --tag mattermost/mattermost-build-server:"${IMAGE_TAG}" \
            --push \
            -f server/build/Dockerfile.buildenv .

  build-and-push-fips:
    runs-on: ubuntu-24.04

    steps:
      - uses: chainguard-dev/setup-chainctl@be0acd273acf04bfdf91f51198327e719f6af978 # v0.4.0
        with:
          identity: ${{ env.CHAINCTL_IDENTITY }}
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Set up QEMU (optional, for multi-arch)
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Login to DockerHub (production repo)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push production image
        run: |
          docker buildx build \
            --tag mattermost/mattermost-build-server-fips:${{ github.event.inputs.tag }} \
            --push \
            -f server/build/Dockerfile.buildenv-fips .
