---
name: Lighthouse Metrics

on:
  # Trigger after smoke tests complete
  workflow_run:
    workflows: ["E2E Smoketests"]
    types:
      - completed

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to test (defaults to current branch HEAD)'
        type: string
        required: false
      server_image:
        description: 'Server Docker image to test'
        type: string
        required: false
        default: 'mattermostdevelopment/mattermost-enterprise-edition:master'
      lighthouse_runs:
        description: 'Number of Lighthouse runs per page'
        type: string
        required: false
        default: '10'

jobs:
  setup:
    name: Setup Test Variables
    runs-on: ubuntu-latest
    # Only run if smoke tests succeeded (for workflow_run trigger) or always for manual dispatch
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      COMMIT_SHA: ${{ steps.vars.outputs.COMMIT_SHA }}
      SERVER_IMAGE: ${{ steps.vars.outputs.SERVER_IMAGE }}
    steps:
      - name: ci/derive-test-variables
        id: vars
        run: |
          # Determine commit SHA and server image based on trigger type
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            # Use the same image tag format as smoke tests (first 7 chars of commit)
            IMAGE_TAG="${COMMIT_SHA:0:7}"
            SERVER_IMAGE="mattermostdevelopment/mattermost-enterprise-edition:${IMAGE_TAG}"
          else
            # Manual dispatch
            COMMIT_SHA="${{ inputs.commit_sha || github.sha }}"
            SERVER_IMAGE="${{ inputs.server_image || 'mattermostdevelopment/mattermost-enterprise-edition:master' }}"
          fi

          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "SERVER_IMAGE=${SERVER_IMAGE}" >> $GITHUB_OUTPUT
          echo "Commit SHA: ${COMMIT_SHA}"
          echo "Server Image: ${SERVER_IMAGE}"

  lighthouse-metrics:
    name: Lighthouse Web Vitals
    needs: setup
    runs-on: ubuntu-latest-8-cores
    timeout-minutes: 45
    defaults:
      run:
        shell: bash
    env:
      LIGHTHOUSE_RUNS: ${{ inputs.lighthouse_runs || '10' }}
      TEST: none
      ENABLED_DOCKER_SERVICES: postgres inbucket

    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.setup.outputs.COMMIT_SHA }}
          fetch-depth: 0

      - name: ci/setup-node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/lighthouse/package-lock.json"

      - name: ci/generate-server-config
        working-directory: e2e-tests
        run: make generate-server

      - name: ci/start-server
        working-directory: e2e-tests
        run: TEST=none make
        env:
          SERVER_IMAGE: ${{ needs.setup.outputs.SERVER_IMAGE }}

      - name: ci/wait-for-server
        run: |
          echo "Waiting for Mattermost server to be ready..."
          timeout 120 bash -c 'until curl -s http://localhost:8065/api/v4/system/ping | grep -q "OK"; do sleep 2; done'
          echo "Server is ready!"

      - name: ci/run-lighthouse-tests
        working-directory: e2e-tests
        run: make run-lh
        env:
          MM_ADMIN_USERNAME: sysadmin
          MM_ADMIN_PASSWORD: Sys@dmin-sample1
          MM_ADMIN_EMAIL: sysadmin@sample.mattermost.com
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          LIGHTHOUSE_RUNS: ${{ env.LIGHTHOUSE_RUNS }}
          LIGHTHOUSE_PAGES: "--all"
          DOCKER_IMAGE_TAG: ${{ needs.setup.outputs.SERVER_IMAGE }}

      - name: ci/upload-lighthouse-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-results-${{ github.run_id }}
          path: |
            e2e-tests/lighthouse/results/
          retention-days: 30

      - name: ci/upload-lighthouse-reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-html-reports-${{ github.run_id }}
          path: e2e-tests/lighthouse/results/*.html
          retention-days: 30

      - name: ci/set-commit-status
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const commitSha = '${{ needs.setup.outputs.COMMIT_SHA }}';
            if (!commitSha) {
              console.log('No commit SHA available, skipping status update');
              return;
            }

            const gradesPath = 'e2e-tests/lighthouse/results/grades.json';
            let status = 'success';
            let description = 'Lighthouse metrics collected';

            try {
              if (fs.existsSync(gradesPath)) {
                const grades = JSON.parse(fs.readFileSync(gradesPath, 'utf-8'));
                const overall = grades.overall;
                const scores = grades.scores;
                const pages = grades.pages.map(p => `${p.pageId}[${p.grade}]`).join(' ');

                status = overall === 'FAIL' ? 'failure' : 'success';
                if (scores) {
                  description = `Perf:${scores.performance} A11y:${scores.accessibility} BP:${scores.bestPractices} | ${pages}`;
                } else {
                  description = `Web Vitals: ${overall} | ${pages}`;
                }
              } else {
                status = 'failure';
                description = 'Lighthouse results not found';
              }
            } catch (error) {
              console.log('Error reading grades:', error.message);
              status = 'failure';
              description = `Error: ${error.message}`;
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: commitSha,
              state: status,
              target_url: `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
              description: description.substring(0, 140),
              context: 'Lighthouse Metrics'
            });

            console.log(`Commit status: ${status} - ${description}`);

      - name: ci/print-summary
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const resultsDir = 'e2e-tests/lighthouse/results';
            const gradesPath = path.join(resultsDir, 'grades.json');
            const serverImage = '${{ needs.setup.outputs.SERVER_IMAGE }}';
            const commitSha = '${{ needs.setup.outputs.COMMIT_SHA }}';
            const runs = '${{ env.LIGHTHOUSE_RUNS }}';

            let summary = '## Web Vitals Results\n\n';

            // Configuration
            summary += '### Configuration\n';
            summary += `| Setting | Value |\n|---------|-------|\n`;
            summary += `| Server Image | \`${serverImage}\` |\n`;
            summary += `| Commit | \`${commitSha.substring(0, 7)}\` |\n`;
            summary += `| Runs per page | ${runs} |\n\n`;

            // Read grades
            let grades = null;
            if (fs.existsSync(gradesPath)) {
              grades = JSON.parse(fs.readFileSync(gradesPath, 'utf-8'));
              const icon = grades.overall === 'PASS' ? '✅' : grades.overall === 'WARN' ? '⚠️' : '❌';
              summary += `### Overall Result: ${icon} ${grades.overall}\n\n`;
            }

            // Find results file
            let results = null;
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('_perf.json'));
              if (files.length > 0) {
                results = JSON.parse(fs.readFileSync(path.join(resultsDir, files[files.length - 1]), 'utf-8'));
              }
            }

            // Format value helper
            const formatMs = (v) => `${(v / 1000).toFixed(2)}s`;
            const formatBytes = (v) => `${(v / 1024).toFixed(0)} KiB`;

            if (results && results.pages) {
              for (const [pageId, page] of Object.entries(results.pages)) {
                const pageGrade = grades?.pages?.find(p => p.pageId === pageId);
                const gradeIcon = pageGrade?.grade === 'PASS' ? '✅' : pageGrade?.grade === 'WARN' ? '⚠️' : '❌';

                summary += `### ${gradeIcon} ${pageId}\n\n`;
                summary += `<details>\n<summary>View detailed metrics</summary>\n\n`;

                // Scores
                summary += '#### Scores\n';
                summary += `| Metric | Score |\n|--------|-------|\n`;
                summary += `| Performance | ${page.performanceScore?.median ?? 'N/A'}/100 |\n`;
                summary += `| Accessibility | ${page.accessibilityScore?.median ?? 'N/A'}/100 |\n`;
                summary += `| Best Practices | ${page.bestPracticesScore?.median ?? 'N/A'}/100 |\n\n`;

                // Core Web Vitals
                summary += '#### Core Web Vitals\n';
                summary += `| Metric | Median | Range |\n|--------|--------|-------|\n`;
                if (page.lcp) summary += `| LCP | ${formatMs(page.lcp.median)} | ${formatMs(page.lcp.lowerBound)} - ${formatMs(page.lcp.upperBound)} |\n`;
                if (page.tbt) summary += `| TBT | ${page.tbt.median.toFixed(0)}ms | ${page.tbt.lowerBound.toFixed(0)} - ${page.tbt.upperBound.toFixed(0)}ms |\n`;
                if (page.cls) summary += `| CLS | ${page.cls.median.toFixed(3)} | ${page.cls.lowerBound.toFixed(3)} - ${page.cls.upperBound.toFixed(3)} |\n`;
                summary += '\n';

                // Timing
                summary += '#### Timing Metrics\n';
                summary += `| Metric | Median | Range |\n|--------|--------|-------|\n`;
                if (page.fcp) summary += `| FCP | ${formatMs(page.fcp.median)} | ${formatMs(page.fcp.lowerBound)} - ${formatMs(page.fcp.upperBound)} |\n`;
                if (page.si) summary += `| Speed Index | ${formatMs(page.si.median)} | ${formatMs(page.si.lowerBound)} - ${formatMs(page.si.upperBound)} |\n`;
                if (page.tti) summary += `| TTI | ${formatMs(page.tti.median)} | ${formatMs(page.tti.lowerBound)} - ${formatMs(page.tti.upperBound)} |\n`;
                if (page.ttfb) summary += `| TTFB | ${page.ttfb.median.toFixed(0)}ms | ${page.ttfb.lowerBound.toFixed(0)} - ${page.ttfb.upperBound.toFixed(0)}ms |\n`;
                summary += '\n';

                // Resources
                summary += '#### Resources\n';
                summary += `| Metric | Value |\n|--------|-------|\n`;
                if (page.totalByteWeight) summary += `| Total Size | ${formatBytes(page.totalByteWeight.median)} |\n`;
                if (page.mainThreadWork) summary += `| Main Thread | ${formatMs(page.mainThreadWork.median)} |\n`;
                if (page.bootupTime) summary += `| JS Boot-up | ${formatMs(page.bootupTime.median)} |\n`;
                summary += '\n';

                summary += '</details>\n\n';
              }
            }

            // Reports section
            summary += '### Reports\n\n';
            if (fs.existsSync(resultsDir)) {
              const htmlFiles = fs.readdirSync(resultsDir).filter(f => f.endsWith('.html'));
              const jsonFiles = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));

              if (htmlFiles.length > 0 || jsonFiles.length > 0) {
                summary += 'Download artifacts from this workflow run to view:\n';
                summary += `- **HTML Reports:** ${htmlFiles.length} file(s)\n`;
                summary += `- **JSON Results:** ${jsonFiles.length} file(s)\n`;
              }
            }

            if (!results && !grades) {
              summary += '\n❌ **Lighthouse results not found**\n';
            }

            core.summary.addRaw(summary).write();

      - name: ci/stop-server
        if: always()
        working-directory: e2e-tests
        run: make stop-server || true

  lighthouse-metrics-no-plugins:
    name: Lighthouse Web Vitals (No Plugins)
    needs: setup
    runs-on: ubuntu-latest-8-cores
    timeout-minutes: 45
    defaults:
      run:
        shell: bash
    env:
      LIGHTHOUSE_RUNS: ${{ inputs.lighthouse_runs || '10' }}
      TEST: none
      ENABLED_DOCKER_SERVICES: postgres inbucket

    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.setup.outputs.COMMIT_SHA }}
          fetch-depth: 0

      - name: ci/setup-node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/lighthouse/package-lock.json"

      - name: ci/generate-server-config
        working-directory: e2e-tests
        run: make generate-server

      - name: ci/start-server
        working-directory: e2e-tests
        run: TEST=none make
        env:
          SERVER_IMAGE: ${{ needs.setup.outputs.SERVER_IMAGE }}

      - name: ci/wait-for-server
        run: |
          echo "Waiting for Mattermost server to be ready..."
          timeout 120 bash -c 'until curl -s http://localhost:8065/api/v4/system/ping | grep -q "OK"; do sleep 2; done'
          echo "Server is ready!"

      - name: ci/disable-all-plugins
        working-directory: e2e-tests
        run: make disable-plugins

      - name: ci/run-lighthouse-tests
        working-directory: e2e-tests
        run: make run-lh
        env:
          MM_ADMIN_USERNAME: sysadmin
          MM_ADMIN_PASSWORD: Sys@dmin-sample1
          MM_ADMIN_EMAIL: sysadmin@sample.mattermost.com
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          LIGHTHOUSE_RUNS: ${{ env.LIGHTHOUSE_RUNS }}
          LIGHTHOUSE_PAGES: "--all"
          LIGHTHOUSE_BASELINE_SUFFIX: "_no_plugins"
          DOCKER_IMAGE_TAG: ${{ needs.setup.outputs.SERVER_IMAGE }}

      - name: ci/upload-lighthouse-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-results-no-plugins-${{ github.run_id }}
          path: |
            e2e-tests/lighthouse/results/
          retention-days: 30

      - name: ci/upload-lighthouse-reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-html-reports-no-plugins-${{ github.run_id }}
          path: e2e-tests/lighthouse/results/*.html
          retention-days: 30

      - name: ci/set-commit-status
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const commitSha = '${{ needs.setup.outputs.COMMIT_SHA }}';
            if (!commitSha) {
              console.log('No commit SHA available, skipping status update');
              return;
            }

            const gradesPath = 'e2e-tests/lighthouse/results/grades.json';
            let status = 'success';
            let description = 'Lighthouse metrics collected (no plugins)';

            try {
              if (fs.existsSync(gradesPath)) {
                const grades = JSON.parse(fs.readFileSync(gradesPath, 'utf-8'));
                const overall = grades.overall;
                const scores = grades.scores;
                const pages = grades.pages.map(p => `${p.pageId}[${p.grade}]`).join(' ');

                status = overall === 'FAIL' ? 'failure' : 'success';
                if (scores) {
                  description = `Perf:${scores.performance} A11y:${scores.accessibility} BP:${scores.bestPractices} | ${pages}`;
                } else {
                  description = `Web Vitals: ${overall} | ${pages}`;
                }
              } else {
                status = 'failure';
                description = 'Lighthouse results not found (no plugins)';
              }
            } catch (error) {
              console.log('Error reading grades:', error.message);
              status = 'failure';
              description = `Error: ${error.message}`;
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: commitSha,
              state: status,
              target_url: `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
              description: description.substring(0, 140),
              context: 'Lighthouse Metrics (No Plugins)'
            });

            console.log(`Commit status: ${status} - ${description}`);

      - name: ci/stop-server
        if: always()
        working-directory: e2e-tests
        run: make stop-server || true
