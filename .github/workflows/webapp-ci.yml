name: Web App CI
on:
  push:
    branches:
      - master
      - release-*
  pull_request:
    paths:
      - "webapp/**"
      - "e2e-tests/**"
      - ".github/workflows/webapp-ci.yml"
      - ".github/actions/webapp-setup/**"

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('{0}-{1}', github.workflow, github.ref) || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  check-lint:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        run: |
          npm run check

  check-i18n:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        working-directory: webapp/channels
        run: |
          cp src/i18n/en.json /tmp/en.json
          mkdir -p /tmp/fake-mobile-dir/assets/base/i18n/
          echo '{}' > /tmp/fake-mobile-dir/assets/base/i18n/en.json
          npm run mmjstool -- i18n extract-webapp --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir
          diff /tmp/en.json src/i18n/en.json
          # Address weblate behavior which does not remove whole translation item when translation string is set to empty
          npm run mmjstool -- i18n clean-empty --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir --check
          npm run mmjstool -- i18n check-empty-src --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir
          rm -rf tmp

  check-types:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        run: |
          npm run check-types

  test-platform:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        package: [client, components]
        run: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    name: test (platform/${{ matrix.package }} run ${{ matrix.run }})
    defaults:
      run:
        working-directory: webapp/platform/${{ matrix.package }}
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/test
        env:
          NODE_OPTIONS: --max_old_space_size=5120
        run: |
          npm run test-ci -- --coverage
      - name: ci/upload-coverage-artifact
        if: matrix.run == 1
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-platform-${{ matrix.package }}
          path: ./webapp/platform/${{ matrix.package }}/coverage/lcov.info
          retention-days: 1

  test-mattermost-redux:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        run: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    name: test (mattermost-redux run ${{ matrix.run }})
    defaults:
      run:
        working-directory: webapp/channels
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/test
        env:
          NODE_OPTIONS: --max_old_space_size=5120
        run: |
          npm run test:jest:mattermost-redux
      - name: ci/upload-coverage-artifact
        if: matrix.run == 1
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-mattermost-redux
          path: ./webapp/channels/coverage/lcov.info
          retention-days: 1

  test-channels:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        run: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    name: test (channels shard ${{ matrix.shard }}/4 run ${{ matrix.run }})
    defaults:
      run:
        working-directory: webapp/channels
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/test
        env:
          NODE_OPTIONS: --max_old_space_size=5120
        run: |
          npm run test:jest:channels:shard${{ matrix.shard }}
      - name: ci/upload-coverage-artifact
        if: matrix.run == 1
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-channels-shard-${{ matrix.shard }}
          path: ./webapp/channels/coverage/lcov.info
          retention-days: 1

  upload-coverage:
    runs-on: ubuntu-22.04
    needs: [test-platform, test-mattermost-redux, test-channels]
    if: ${{ github.event_name != 'pull_request' || !startsWith(github.event.pull_request.base.ref, 'release-') }}
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/download-coverage-artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: coverage-*
          path: coverage-artifacts
          merge-multiple: false
      - name: ci/merge-coverage
        run: |
          sudo apt-get update && sudo apt-get install -y lcov

          # Merge channels shard coverage first
          channels_args=""
          for file in coverage-artifacts/coverage-channels-shard-*/lcov.info; do
            if [ -f "$file" ]; then
              channels_args="$channels_args -a $file"
            fi
          done
          if [ -n "$channels_args" ]; then
            lcov $channels_args -o channels-merged-lcov.info
            echo "Merged channels coverage from shards"
          fi

          # Merge platform coverage
          platform_args=""
          for file in coverage-artifacts/coverage-platform-*/lcov.info; do
            if [ -f "$file" ]; then
              platform_args="$platform_args -a $file"
            fi
          done
          if [ -n "$platform_args" ]; then
            lcov $platform_args -o platform-merged-lcov.info
            echo "Merged platform coverage"
          fi

          # Final merge of all coverage reports
          final_args=""
          if [ -f "channels-merged-lcov.info" ]; then
            final_args="$final_args -a channels-merged-lcov.info"
          fi
          if [ -f "platform-merged-lcov.info" ]; then
            final_args="$final_args -a platform-merged-lcov.info"
          fi
          if [ -f "coverage-artifacts/coverage-mattermost-redux/lcov.info" ]; then
            final_args="$final_args -a coverage-artifacts/coverage-mattermost-redux/lcov.info"
          fi
          if [ -n "$final_args" ]; then
            lcov $final_args -o merged-lcov.info
            echo "Final merged coverage created"
          fi
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true
          files: ./merged-lcov.info

  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/build
        run: |
          npm run build

  # run-performance-bechmarks:
  #   uses: ./.github/workflows/performance-benchmarks.yml
  #   needs: build
