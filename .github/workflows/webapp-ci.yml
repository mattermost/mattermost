name: Web App CI
on:
  push:
    branches:
      - master
      - release-*
  pull_request:
    paths:
      - "webapp/**"
      - "e2e-tests/**"
      - ".github/workflows/webapp-ci.yml"
      - ".github/actions/webapp-setup/**"

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('{0}-{1}', github.workflow, github.ref) || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  check-lint:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        run: |
          npm run check

  check-i18n:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        working-directory: webapp/channels
        run: |
          cp src/i18n/en.json /tmp/en.json
          mkdir -p /tmp/fake-mobile-dir/assets/base/i18n/
          echo '{}' > /tmp/fake-mobile-dir/assets/base/i18n/en.json
          npm run mmjstool -- i18n extract-webapp --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir
          diff /tmp/en.json src/i18n/en.json
          # Address weblate behavior which does not remove whole translation item when translation string is set to empty
          npm run mmjstool -- i18n clean-empty --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir --check
          npm run mmjstool -- i18n check-empty-src --webapp-dir ./src --mobile-dir /tmp/fake-mobile-dir
          rm -rf tmp

  check-types:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/lint
        run: |
          npm run check-types

  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        node-version: [20, 22, 24]
    runs-on: ${{ matrix.os }}
    name: test (${{ matrix.os }}, Node ${{ matrix.node-version }})
    permissions:
      checks: write
      pull-requests: write
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup-node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: webapp/package-lock.json
      - name: ci/install-dependencies
        run: make node_modules
      - name: ci/test
        env:
          NODE_OPTIONS: --max_old_space_size=5120
        run: npm run test-ci
      - name: Upload coverage to Codecov
        # Skip coverage upload for cherry-pick PRs into release branches. Only upload for one matrix combo.
        if: ${{ matrix.os == 'ubuntu-22.04' && matrix.node-version == 22 && (github.event_name != 'pull_request' || !startsWith(github.event.pull_request.base.ref, 'release-')) }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true
          files: ./webapp/channels/coverage/lcov.info

  test-vitest:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        node-version: [20, 22, 24]
    runs-on: ${{ matrix.os }}
    name: test-vitest (${{ matrix.os }}, Node ${{ matrix.node-version }})
    permissions:
      checks: write
      pull-requests: write
    defaults:
      run:
        working-directory: webapp/channels
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup-node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: webapp/package-lock.json
      - name: ci/install-dependencies
        working-directory: webapp
        run: make node_modules
      - name: ci/test-vitest
        run: npm run test:vitest

  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: webapp
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: ci/setup
        uses: ./.github/actions/webapp-setup
      - name: ci/build
        run: |
          npm run build

  # run-performance-bechmarks:
  #   uses: ./.github/workflows/performance-benchmarks.yml
  #   needs: build
