---
name: E2E Tests - Playwright
on:
  workflow_call:
    inputs:
      commit_sha:
        type: string
        required: true
      enable_reporting:
        type: boolean
        required: false
        default: false
      server:
        type: string
        required: false
        default: onprem
      report_type:
        type: string
        required: false
      pr_number:
        type: string
        required: false
      server_image_tag:
        type: string
        required: false
        description: "Server image tag (e.g., master or short SHA)"
    secrets:
      MM_LICENSE:
        required: false
      REPORT_WEBHOOK_URL:
        required: false
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  generate-build-variables:
    runs-on: ubuntu-24.04
    outputs:
      branch: "${{ steps.build-vars.outputs.branch }}"
      build_id: "${{ steps.build-vars.outputs.build_id }}"
      server_image_tag: "${{ steps.build-vars.outputs.server_image_tag }}"
    steps:
      - name: ci/generate-build-variables
        id: build-vars
        env:
          COMMIT_SHA: ${{ inputs.commit_sha }}
          PR_NUMBER: ${{ inputs.pr_number }}
          INPUT_SERVER_IMAGE_TAG: ${{ inputs.server_image_tag }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          # Use provided server_image_tag or derive from commit SHA
          if [ -n "$INPUT_SERVER_IMAGE_TAG" ]; then
            SERVER_IMAGE_TAG="$INPUT_SERVER_IMAGE_TAG"
          else
            SERVER_IMAGE_TAG="${COMMIT_SHA::7}"
          fi
          echo "server_image_tag=${SERVER_IMAGE_TAG}" >> $GITHUB_OUTPUT

          # Generate branch name
          if [ -n "$PR_NUMBER" ]; then
            echo "branch=server-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          else
            echo "branch=server-commit-${SERVER_IMAGE_TAG}" >> $GITHUB_OUTPUT
          fi

          # Generate build ID
          echo "build_id=${RUN_ID}_${RUN_ATTEMPT}-${SERVER_IMAGE_TAG}-playwright-onprem-ent" >> $GITHUB_OUTPUT

  playwright-smoke:
    needs:
      - generate-build-variables
    uses: ./.github/workflows/e2e-tests-playwright-template.yml
    with:
      test_type: smoke
      test_filter: "--grep @smoke"
      timeout_minutes: 30
      enabled_docker_services: "postgres inbucket"
      commit_sha: ${{ inputs.commit_sha }}
      branch: ${{ needs.generate-build-variables.outputs.branch }}
      build_id: ${{ needs.generate-build-variables.outputs.build_id }}
      server_image_tag: ${{ needs.generate-build-variables.outputs.server_image_tag }}
      server: ${{ inputs.server }}
      context_name: "E2E Tests / playwright-smoke"
      pr_number: ${{ inputs.pr_number }}
    secrets:
      MM_LICENSE: ${{ secrets.MM_LICENSE }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ════════════════════════════════════════════════════════════════════════════
  # FULL TESTS - Sharded across 4 runners (POC for parallelization)
  # ════════════════════════════════════════════════════════════════════════════
  playwright-full-shard-1:
    needs: [playwright-smoke, generate-build-variables]
    if: needs.playwright-smoke.outputs.failed == '0' && inputs.pr_number != ''
    uses: ./.github/workflows/e2e-tests-playwright-template.yml
    with:
      test_type: full
      test_filter: '--grep-invert "@smoke|@visual"'
      timeout_minutes: 60
      shard: 1
      total_shards: 4
      enabled_docker_services: "postgres inbucket minio openldap elasticsearch keycloak"
      commit_sha: ${{ inputs.commit_sha }}
      branch: ${{ needs.generate-build-variables.outputs.branch }}
      build_id: ${{ needs.generate-build-variables.outputs.build_id }}
      server_image_tag: ${{ needs.generate-build-variables.outputs.server_image_tag }}
      server: ${{ inputs.server }}
      enable_reporting: false
      pr_number: ${{ inputs.pr_number }}
      context_name: "E2E Tests / playwright-full-1/4"
    secrets:
      MM_LICENSE: ${{ secrets.MM_LICENSE }}
      REPORT_WEBHOOK_URL: ${{ secrets.REPORT_WEBHOOK_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  playwright-full-shard-2:
    needs: [playwright-smoke, generate-build-variables]
    if: needs.playwright-smoke.outputs.failed == '0' && inputs.pr_number != ''
    uses: ./.github/workflows/e2e-tests-playwright-template.yml
    with:
      test_type: full
      test_filter: '--grep-invert "@smoke|@visual"'
      timeout_minutes: 60
      shard: 2
      total_shards: 4
      enabled_docker_services: "postgres inbucket minio openldap elasticsearch keycloak"
      commit_sha: ${{ inputs.commit_sha }}
      branch: ${{ needs.generate-build-variables.outputs.branch }}
      build_id: ${{ needs.generate-build-variables.outputs.build_id }}
      server_image_tag: ${{ needs.generate-build-variables.outputs.server_image_tag }}
      server: ${{ inputs.server }}
      enable_reporting: false
      pr_number: ${{ inputs.pr_number }}
      context_name: "E2E Tests / playwright-full-2/4"
    secrets:
      MM_LICENSE: ${{ secrets.MM_LICENSE }}
      REPORT_WEBHOOK_URL: ${{ secrets.REPORT_WEBHOOK_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  playwright-full-shard-3:
    needs: [playwright-smoke, generate-build-variables]
    if: needs.playwright-smoke.outputs.failed == '0' && inputs.pr_number != ''
    uses: ./.github/workflows/e2e-tests-playwright-template.yml
    with:
      test_type: full
      test_filter: '--grep-invert "@smoke|@visual"'
      timeout_minutes: 60
      shard: 3
      total_shards: 4
      enabled_docker_services: "postgres inbucket minio openldap elasticsearch keycloak"
      commit_sha: ${{ inputs.commit_sha }}
      branch: ${{ needs.generate-build-variables.outputs.branch }}
      build_id: ${{ needs.generate-build-variables.outputs.build_id }}
      server_image_tag: ${{ needs.generate-build-variables.outputs.server_image_tag }}
      server: ${{ inputs.server }}
      enable_reporting: false
      pr_number: ${{ inputs.pr_number }}
      context_name: "E2E Tests / playwright-full-3/4"
    secrets:
      MM_LICENSE: ${{ secrets.MM_LICENSE }}
      REPORT_WEBHOOK_URL: ${{ secrets.REPORT_WEBHOOK_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  playwright-full-shard-4:
    needs: [playwright-smoke, generate-build-variables]
    if: needs.playwright-smoke.outputs.failed == '0' && inputs.pr_number != ''
    uses: ./.github/workflows/e2e-tests-playwright-template.yml
    with:
      test_type: full
      test_filter: '--grep-invert "@smoke|@visual"'
      timeout_minutes: 60
      shard: 4
      total_shards: 4
      enabled_docker_services: "postgres inbucket minio openldap elasticsearch keycloak"
      commit_sha: ${{ inputs.commit_sha }}
      branch: ${{ needs.generate-build-variables.outputs.branch }}
      build_id: ${{ needs.generate-build-variables.outputs.build_id }}
      server_image_tag: ${{ needs.generate-build-variables.outputs.server_image_tag }}
      server: ${{ inputs.server }}
      enable_reporting: false
      pr_number: ${{ inputs.pr_number }}
      context_name: "E2E Tests / playwright-full-4/4"
    secrets:
      MM_LICENSE: ${{ secrets.MM_LICENSE }}
      REPORT_WEBHOOK_URL: ${{ secrets.REPORT_WEBHOOK_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
