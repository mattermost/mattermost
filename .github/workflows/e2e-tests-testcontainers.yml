---
name: "E2E Tests (Testcontainers)"
on:
  push:
    branches:
      - MM-67295_testcontainers
    paths:
      - ".github/workflows/e2e-tests-testcontainers.yml"
      - "e2e-tests/testcontainers/**"
      - "e2e-tests/playwright/**"
      - "e2e-tests/cypress/**"
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Commit SHA to test. If empty, uses the workflow dispatch ref."
        type: string
        required: false
      server_image:
        description: "Full server image (e.g., mattermostdevelopment/mattermost-enterprise-edition:master)"
        type: string
        required: false
        default: "mattermostdevelopment/mattermost-enterprise-edition:master"
      mm_env:
        description: "Comma-separated env vars for the server (e.g., MM_FEATUREFLAGS_X=true)"
        type: string
        required: false
      run_cypress:
        description: "Run Cypress tests"
        type: boolean
        required: false
        default: true
      run_playwright:
        description: "Run Playwright tests"
        type: boolean
        required: false
        default: true

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

env:
  COMMIT_SHA: "${{ inputs.commit_sha || github.sha }}"
  SERVER_IMAGE: "${{ inputs.server_image || 'mattermostdevelopment/mattermost-enterprise-edition:master' }}"
  MM_ENV_INPUT: "${{ inputs.mm_env || '' }}"

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # CYPRESS SMOKE
  # ════════════════════════════════════════════════════════════════════════════
  cypress-smoke:
    if: inputs.run_cypress != 'false'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    outputs:
      status: ${{ steps.result.outputs.status }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.COMMIT_SHA }}
          fetch-depth: 0
      - name: ci/setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/cypress/package-lock.json"
      - name: ci/setup-testcontainers
        working-directory: e2e-tests/testcontainers
        run: npm ci --ignore-scripts --omit=dev
      - name: ci/start-server
        id: start-server
        working-directory: e2e-tests/testcontainers
        env:
          TC_SERVER_IMAGE: ${{ env.SERVER_IMAGE }}
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          MM_ENV: ${{ env.MM_ENV_INPUT }}
        run: |
          ENV_ARGS=""
          if [ -n "$MM_ENV" ]; then
            IFS=',' read -ra ENV_VARS <<< "$MM_ENV"
            for env_var in "${ENV_VARS[@]}"; do
              ENV_ARGS="$ENV_ARGS -E $env_var"
            done
          fi

          node dist/cli.js start --admin -D "postgres,inbucket" $ENV_ARGS -o .tc.out

          SERVER_URL=$(jq -r '.containers.mattermost.url' .tc.out/.tc.docker.json)
          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "Server started at: $SERVER_URL"
      - name: ci/run-cypress-smoke
        working-directory: e2e-tests/cypress
        env:
          CYPRESS_baseUrl: ${{ steps.start-server.outputs.SERVER_URL }}
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
        run: |
          npm ci
          node run_tests.js --stage='@prod' --group='@smoke'
      - name: ci/set-result
        id: result
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
      - name: ci/stop-server
        if: always()
        working-directory: e2e-tests/testcontainers
        run: node dist/cli.js stop || true
      - name: ci/upload-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: cypress-smoke-results
          path: |
            e2e-tests/cypress/logs/
            e2e-tests/cypress/results/
          retention-days: 5

  # ════════════════════════════════════════════════════════════════════════════
  # CYPRESS FULL (only if smoke passes)
  # ════════════════════════════════════════════════════════════════════════════
  cypress-full:
    needs: cypress-smoke
    if: needs.cypress-smoke.result == 'success'
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    outputs:
      status: ${{ steps.result.outputs.status }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.COMMIT_SHA }}
          fetch-depth: 0
      - name: ci/setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/cypress/package-lock.json"
      - name: ci/setup-testcontainers
        working-directory: e2e-tests/testcontainers
        run: npm ci --ignore-scripts --omit=dev
      - name: ci/start-server
        id: start-server
        working-directory: e2e-tests/testcontainers
        env:
          TC_SERVER_IMAGE: ${{ env.SERVER_IMAGE }}
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          MM_ENV: ${{ env.MM_ENV_INPUT }}
        run: |
          ENV_ARGS=""
          if [ -n "$MM_ENV" ]; then
            IFS=',' read -ra ENV_VARS <<< "$MM_ENV"
            for env_var in "${ENV_VARS[@]}"; do
              ENV_ARGS="$ENV_ARGS -E $env_var"
            done
          fi

          node dist/cli.js start --admin -D "postgres,inbucket,minio,openldap,elasticsearch,keycloak" $ENV_ARGS -o .tc.out

          SERVER_URL=$(jq -r '.containers.mattermost.url' .tc.out/.tc.docker.json)
          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "Server started at: $SERVER_URL"
      - name: ci/run-cypress-full
        working-directory: e2e-tests/cypress
        env:
          CYPRESS_baseUrl: ${{ steps.start-server.outputs.SERVER_URL }}
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
        run: |
          npm ci
          node run_tests.js --stage='@prod' --excludeGroup='@smoke,@te_only,@cloud_only,@high_availability' --sortFirst='@compliance_export,@elasticsearch,@ldap_group,@ldap' --sortLast='@saml,@keycloak,@plugin,@plugins_uninstall,@mfa,@license_removal'
      - name: ci/set-result
        id: result
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
      - name: ci/stop-server
        if: always()
        working-directory: e2e-tests/testcontainers
        run: node dist/cli.js stop || true
      - name: ci/upload-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: cypress-full-results
          path: |
            e2e-tests/cypress/logs/
            e2e-tests/cypress/results/
          retention-days: 5

  # ════════════════════════════════════════════════════════════════════════════
  # PLAYWRIGHT SMOKE
  # ════════════════════════════════════════════════════════════════════════════
  playwright-smoke:
    if: inputs.run_playwright != 'false'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    outputs:
      status: ${{ steps.result.outputs.status }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.COMMIT_SHA }}
          fetch-depth: 0
      - name: ci/setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/playwright/package-lock.json"
      - name: ci/get-webapp-node-modules
        working-directory: webapp
        run: make node_modules
      - name: ci/setup-testcontainers
        working-directory: e2e-tests/testcontainers
        run: npm ci --ignore-scripts --omit=dev
      - name: ci/playwright-install
        working-directory: e2e-tests/playwright
        run: npm ci
      - name: ci/run-playwright-smoke
        working-directory: e2e-tests/playwright
        env:
          PW_TC: "true"
          TC_SERVER_IMAGE: ${{ env.SERVER_IMAGE }}
          TC_DEPENDENCIES: "postgres,inbucket"
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          MM_ENV: ${{ env.MM_ENV_INPUT }}
        run: npm run test:ci -- --grep @smoke
      - name: ci/set-result
        id: result
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
      - name: ci/upload-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: playwright-smoke-results
          path: |
            e2e-tests/playwright/logs/
            e2e-tests/playwright/results/
          retention-days: 5

  # ════════════════════════════════════════════════════════════════════════════
  # PLAYWRIGHT FULL (only if smoke passes)
  # ════════════════════════════════════════════════════════════════════════════
  playwright-full:
    needs: playwright-smoke
    if: needs.playwright-smoke.result == 'success'
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    outputs:
      status: ${{ steps.result.outputs.status }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.COMMIT_SHA }}
          fetch-depth: 0
      - name: ci/setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: npm
          cache-dependency-path: "e2e-tests/playwright/package-lock.json"
      - name: ci/get-webapp-node-modules
        working-directory: webapp
        run: make node_modules
      - name: ci/setup-testcontainers
        working-directory: e2e-tests/testcontainers
        run: npm ci --ignore-scripts --omit=dev
      - name: ci/playwright-install
        working-directory: e2e-tests/playwright
        run: npm ci
      - name: ci/run-playwright-full
        working-directory: e2e-tests/playwright
        env:
          PW_TC: "true"
          TC_SERVER_IMAGE: ${{ env.SERVER_IMAGE }}
          TC_DEPENDENCIES: "postgres,inbucket,minio,openldap,elasticsearch,keycloak"
          MM_LICENSE: ${{ secrets.MM_E2E_TEST_LICENSE_ONPREM_ENT }}
          MM_ENV: ${{ env.MM_ENV_INPUT }}
        run: npm run test:ci -- --grep-invert "@smoke|@visual"
      - name: ci/set-result
        id: result
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT
      - name: ci/upload-results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: playwright-full-results
          path: |
            e2e-tests/playwright/logs/
            e2e-tests/playwright/results/
          retention-days: 5

  # ════════════════════════════════════════════════════════════════════════════
  # SUMMARY
  # ════════════════════════════════════════════════════════════════════════════
  summary:
    if: always()
    runs-on: ubuntu-24.04
    needs:
      - cypress-smoke
      - cypress-full
      - playwright-smoke
      - playwright-full
    steps:
      - name: ci/write-summary
        env:
          CY_SMOKE: ${{ needs.cypress-smoke.result }}
          CY_FULL: ${{ needs.cypress-full.result }}
          PW_SMOKE: ${{ needs.playwright-smoke.result }}
          PW_FULL: ${{ needs.playwright-full.result }}
        run: |
          status_icon() {
            case "$1" in
              success)  echo ":white_check_mark: Passed" ;;
              skipped)  echo ":fast_forward: Skipped" ;;
              *)        echo ":x: $1" ;;
            esac
          }

          {
            echo "## E2E Testcontainers Results"
            echo ""
            echo "| Runner | Smoke | Full |"
            echo "|--------|-------|------|"
            if [ "${{ inputs.run_cypress || 'true' }}" != "false" ]; then
              echo "| Cypress | $(status_icon "$CY_SMOKE") | $(status_icon "$CY_FULL") |"
            fi
            if [ "${{ inputs.run_playwright || 'true' }}" != "false" ]; then
              echo "| Playwright | $(status_icon "$PW_SMOKE") | $(status_icon "$PW_FULL") |"
            fi
            echo ""
            echo "**Server image:** \`${{ env.SERVER_IMAGE }}\`"
            echo "**Commit:** \`${{ env.COMMIT_SHA }}\`"
          } >> $GITHUB_STEP_SUMMARY
